<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Êº¢Â≠ó„Éû„Çπ„Çø„Éº - Kanji Master</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: sans-serif;
      background: white;
      color: black;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 20px 20px 15px 20px;
      border-bottom: 2px solid black;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .data-controls {
      display: flex;
      gap: 10px;
    }
    
    .data-btn {
      padding: 6px 12px;
      background: black;
      color: white;
      border: 1px solid black;
      cursor: pointer;
      font-size: 14px;
    }
    
    .data-btn:hover {
      background: #333;
    }
    
    #import-file {
      display: none;
    }
    
    h1 {
      font-size: 24px;
    }
    
    .nav-tabs {
      display: flex;
      gap: 10px;
    }
    
    .tab-btn {
      padding: 8px 16px;
      background: white;
      border: 1px solid black;
      cursor: pointer;
    }
    
    .tab-btn.active {
      background: black;
      color: white;
    }
    
    .page {
      display: none;
      padding: 20px;
    }
    
    .page.active {
      display: block;
    }
    
    .legend {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      padding: 10px;
      border: 1px solid black;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 14px;
    }
    
    .legend-color {
      width: 20px;
      height: 20px;
      border: 1px solid black;
    }
    
    .kanji-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(28px, 1fr));
      gap: 2px;
      border: 1px solid black;
      padding: 10px;
      max-height: 600px;
      overflow-y: auto;
    }
    
    .kanji-cell {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      cursor: pointer;
      border: 1px solid #ccc;
    }
    
    .kanji-cell:hover {
      border: 2px solid black;
    }
    
    .kanji-cell.unknown { background: black; color: black; }
    .kanji-cell.learning { background: #555; color: black; }
    .kanji-cell.familiar { background: #888; color: black; }
    .kanji-cell.known { background: #bbb; color: black; }
    .kanji-cell.mastered { background: white; color: black; border: 1px solid #ccc; }
    
    /* Legend colors to match grid cells */
    .legend-color.unknown { background: black; }
    .legend-color.learning { background: #555; }
    .legend-color.familiar { background: #888; }
    .legend-color.known { background: #bbb; }
    .legend-color.mastered { background: white; border: 1px solid #ccc; }
    
    .study-controls {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
      padding: 20px;
      background: transparent;
    }
    
    .control-group {
      min-width: 200px;
    }
    
    .control-group label {
      display: block;
      font-size: 14px;
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    select, button {
      width: 100%;
      padding: 8px;
      border: 1px solid black;
      background: white;
      color: black;
      cursor: pointer;
    }
    
    button {
      background: black;
      color: white;
    }
    
    button:hover {
      background: #333;
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .study-card {
      border: 2px solid black;
      padding: 40px 20px;
      text-align: center;
      margin-bottom: 20px;
      min-height: 400px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    
    .kanji-display {
      font-size: 120px;
      margin-bottom: 20px;
    }
    
    .context-display {
      font-size: 32px;
      color: #666;
      margin-top: -10px;
      margin-bottom: 20px;
    }
    
    .kanji-info {
      display: none;
    }
    
    .kanji-info.visible {
      display: block;
    }
    
    .stroke-order {
      font-size: 120px;
      margin-bottom: 20px;
      min-height: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .stroke-order svg {
      width: 200px;
      height: 200px;
      display: block;
    }
    
    .reading {
      font-size: 24px;
      margin-bottom: 10px;
    }
    
    .meaning {
      font-size: 18px;
      margin-bottom: 20px;
    }
    
    .examples {
      text-align: left;
      max-width: 600px;
      margin: 0 auto;
    }
    
    .example-item {
      margin-bottom: 15px;
      padding: 10px;
      border-left: 2px solid black;
    }
    
    .example-ja {
      font-size: 16px;
      margin-bottom: 5px;
    }
    
    .example-en {
      font-size: 14px;
      color: #666;
    }
    
    .show-answer-btn {
      max-width: 300px;
    }
    
    .rating-buttons {
      display: none;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 20px;
      width: 100%;
      max-width: 600px;
    }
    
    .rating-buttons.visible {
      display: grid;
    }
    
    .rating-btn {
      padding: 10px;
      border: 2px solid black;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      border: 1px solid black;
      padding: 15px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: bold;
      display: block;
    }
    
    .stat-label {
      font-size: 12px;
      margin-top: 5px;
    }
    
    .no-kanji {
      text-align: center;
      padding: 40px 20px;
    }
    
    .drop-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      pointer-events: none;
    }
    
    .drop-overlay.active {
      display: flex;
    }
    
    .drop-message {
      color: white;
      font-size: 32px;
      font-weight: bold;
      text-align: center;
      padding: 40px;
      border: 4px dashed white;
      border-radius: 10px;
    }
    
    .session-progress {
      text-align: center;
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
    }
    
    /* Dark mode styles - invert all colors */
    body.dark-mode {
      background: #1a1a1a;
      color: #e0e0e0;
    }
    
    body.dark-mode .container {
      background: #2a2a2a;
      border-color: #404040;
    }
    
    body.dark-mode .header {
      background: linear-gradient(135deg, #333 0%, #1a1a1a 100%);
      border-bottom-color: #404040;
    }
    
    body.dark-mode .tabs {
      background: #333;
      border-color: #404040;
    }
    
    body.dark-mode .tab-btn {
      background: #2a2a2a;
      color: #e0e0e0;
      border-color: #404040;
    }
    
    body.dark-mode .tab-btn.active {
      background: #1a1a1a;
      color: #4a9eff;
      border-bottom-color: #1a1a1a;
    }
    
    body.dark-mode .kanji-grid {
      background: #2a2a2a;
    }
    
    body.dark-mode .kanji-cell {
      background: #1a1a1a;
      color: #000;
      border-color: #404040;
    }
    
    body.dark-mode .kanji-cell:hover {
      border-color: #777;
    }
    
    /* Dark mode: All kanji text is black - visibility increases as backgrounds lighten */
    body.dark-mode .kanji-cell.unknown { background: black; color: black; }
    body.dark-mode .kanji-cell.learning { background: #555; color: black; }
    body.dark-mode .kanji-cell.familiar { background: #888; color: black; }
    body.dark-mode .kanji-cell.known { background: #bbb; color: black; }
    body.dark-mode .kanji-cell.mastered { background: white; color: black; border: 1px solid #444; }
    
    /* Dark mode: All text is black */
    body.dark-mode .level-0 { background: black; color: black; }
    body.dark-mode .level-1 { background: #555; color: black; }
    body.dark-mode .level-2 { background: #888; color: black; }
    body.dark-mode .level-3 { background: #bbb; color: black; }
    body.dark-mode .level-review { background: #4a5a6a; color: black; }
    
    body.dark-mode .study-page {
      background: #2a2a2a;
    }
    
    body.dark-mode .study-card {
      background: #333;
      border-color: #404040;
    }
    
    body.dark-mode .context-display {
      color: #999;
    }
    
    body.dark-mode .show-answer-btn {
      background: #4a9eff;
      color: white;
    }
    
    body.dark-mode .show-answer-btn:hover {
      background: #3a8eef;
    }
    
    body.dark-mode .kanji-info {
      background: #333;
      border-color: #404040;
    }
    
    body.dark-mode .rating-buttons button {
      background: #404040;
      color: #e0e0e0;
      border-color: #555;
    }
    
    body.dark-mode .rating-buttons button:hover {
      background: #4a4a4a;
    }
    
    body.dark-mode .rating-buttons .level-0 { background: #555; }
    body.dark-mode .rating-buttons .level-1 { background: #8b4545; }
    body.dark-mode .rating-buttons .level-2 { background: #8b8b45; }
    body.dark-mode .rating-buttons .level-3 { background: #458b45; }
    
    body.dark-mode .example-item {
      border-color: #404040;
    }
    
    body.dark-mode select, body.dark-mode input[type="file"] {
      background: #333;
      color: #e0e0e0;
      border-color: #555;
    }
    
    body.dark-mode button {
      background: #404040;
      color: #e0e0e0;
      border-color: #555;
    }
    
    body.dark-mode button:hover {
      background: #4a4a4a;
    }
    
    body.dark-mode .legend {
      background: #333;
      border-color: #404040;
    }
    
    body.dark-mode .legend-item {
      border-color: #404040;
    }
    
    body.dark-mode #no-kanji {
      color: #999;
    }
    
    body.dark-mode .language-toggle {
      background: #404040;
      color: #e0e0e0;
    }
    
    body.dark-mode .language-toggle:hover {
      background: #4a4a4a;
    }
    
    body.dark-mode .session-progress {
      color: #999;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1></h1>
      <div class="nav-tabs">
        <button class="tab-btn active" data-page="grid"></button>
        <button class="tab-btn" data-page="study"></button>
      </div>
      <div class="data-controls">
        <button class="data-btn" id="language-btn"></button>
        <button class="data-btn" id="dark-mode-btn" onclick="app.toggleDarkMode()">üåô</button>
        <button class="data-btn" id="export-btn"></button>
        <button class="data-btn" id="import-btn"></button>
        <input type="file" id="import-file" accept=".json">
      </div>
    </header>
    
    <!-- Grid Page -->
    <div id="grid-page" class="page active">
      <div class="legend">
        <div class="legend-item">
          <div class="legend-color" style="background: black"></div>
          <span></span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #555"></div>
          <span></span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #888"></div>
          <span></span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #bbb"></div>
          <span></span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: white"></div>
          <span></span>
        </div>
      </div>
      
      <div class="stats">
        <div class="stat-card">
          <span class="stat-value" id="total-kanji">0</span>
          <span class="stat-label" id="stat-total"></span>
        </div>
        <div class="stat-card">
          <span class="stat-value" id="mastered-count">0</span>
          <span class="stat-label" id="stat-mastered"></span>
        </div>
        <div class="stat-card">
          <span class="stat-value" id="learning-count">0</span>
          <span class="stat-label" id="stat-progress"></span>
        </div>
        <div class="stat-card">
          <span class="stat-value" id="unknown-count">0</span>
          <span class="stat-label" id="stat-unknown"></span>
        </div>
      </div>
      
      <div class="kanji-grid" id="kanji-grid"></div>
    </div>
    
    <!-- Study Page -->
    <div id="study-page" class="page">
      <div class="study-controls">
        <div class="control-group">
          <label id="label-filter"></label>
          <select id="level-filter" onchange="app.startStudy()">
            <option value="all" id="filter-all"></option>
            <option value="unknown" id="filter-unknown"></option>
            <option value="learning" id="filter-learning"></option>
            <option value="familiar" id="filter-familiar"></option>
            <option value="known" id="filter-known"></option>
            <option value="review" id="filter-review"></option>
          </select>
        </div>
        <div class="control-group">
          <label id="label-sort"></label>
          <select id="sort-option" onchange="app.startStudy()">
            <option value="random" id="sort-random"></option>
            <option value="frequency" id="sort-frequency"></option>
            <option value="level" id="sort-level"></option>
          </select>
        </div>
        <div class="control-group">
          <label id="label-limit"></label>
          <input type="number" id="study-limit" min="1" max="2000" value="20" onchange="app.startStudy()" style="width: 100%;">
        </div>
      </div>
      
      <div class="session-progress" id="session-progress"></div>
      
      <div class="study-card" id="study-card">
        <div class="study-options" style="margin-bottom: 20px;">
          <label style="margin-right: 15px; cursor: pointer;" id="label-kun">
            <input type="checkbox" id="show-kun" checked onchange="app.saveTogglePreferences(); app.updateDisplay()">
          </label>
          <label style="margin-right: 15px; cursor: pointer;" id="label-on">
            <input type="checkbox" id="show-on" checked onchange="app.saveTogglePreferences(); app.updateDisplay()">
          </label>
          <label style="margin-right: 15px; cursor: pointer;" id="label-meaning">
            <input type="checkbox" id="show-meaning" checked onchange="app.saveTogglePreferences(); app.updateDisplay()">
          </label>
          <label style="margin-right: 15px; cursor: pointer;" id="label-examples">
            <input type="checkbox" id="show-examples" onchange="app.saveTogglePreferences(); app.updateDisplay()">
          </label>
          <label style="margin-right: 15px; cursor: pointer;" id="label-stroke">
            <input type="checkbox" id="show-stroke-order" onchange="app.saveTogglePreferences(); app.updateDisplay()">
          </label>
          <label style="cursor: pointer;" id="label-context">
            <input type="checkbox" id="show-in-context" onchange="app.saveTogglePreferences(); app.updateContextDisplay()">
          </label>
        </div>
        
        <div class="kanji-display" id="current-kanji"></div>
        <div class="stroke-order" id="stroke-order" style="display: none;"></div>
        <div class="context-display" id="context-display" style="display: none;"></div>
        
        <button class="show-answer-btn" id="show-answer-btn" onclick="app.showAnswer()">
        </button>
        
        <div class="kanji-info" id="kanji-info">
          <div class="reading" id="kanji-reading"></div>
          <div class="meaning" id="kanji-meaning"></div>
          <div class="examples" id="kanji-examples"></div>
        </div>
        
        <div class="rating-buttons" id="rating-buttons">
          <button class="rating-btn" data-rating="0" onclick="app.rateCard(0)">
            <span id="rating-again"></span><br><small id="rating-learning"></small>
          </button>
          <button class="rating-btn" data-rating="1" onclick="app.rateCard(1)">
            <span id="rating-hard"></span><br><small id="rating-familiar"></small>
          </button>
          <button class="rating-btn" data-rating="2" onclick="app.rateCard(2)">
            <span id="rating-good"></span><br><small id="rating-known"></small>
          </button>
          <button class="rating-btn" data-rating="3" onclick="app.rateCard(3)">
            <span id="rating-easy"></span><br><small id="rating-mastered"></small>
          </button>
        </div>
      </div>
      
      <div class="no-kanji" id="no-kanji" style="display: none;">
        <p id="no-kanji-msg"></p>
        <p style="margin-top: 1rem;" id="no-kanji-hint"></p>
      </div>
    </div>
  </div>
  
  <div class="drop-overlay" id="drop-overlay">
    <div class="drop-message">
    </div>
  </div>

  <script>
    const KANJI_LIST = `‰∏Ä‰∫å‰ªÅ‰∏âÂõõ‰∫î‰ºçÂÖ≠‰∏ÉÂÖ´‰πùÂçÅÁôæÂçÉ‰∏áËê¨ÂÑÑÊÜ∂ÂÖÜÁú∫ÈäöÊåëË∑≥Èõ∂‰ª§ÂÜ∑Èà¥Áé≤ÈΩ¢Ê≠ØË£ÅÂπ¥Áà∂ÈáúÊØçÂ≠êÂ≠úÂ≠§Â≠´Áà™Â≠î‰∫ÜÂÖÑÊ≥ÅÂºüÁ¨¨ÂºîÂßâÂ∏ÇÂ¶πÈªíÁ¥´Ê≠§Êü¥ÈõåÁ¥∫ÁîòÈùíÊô¥Ê∏ÖË´ãÁ≤æÊÉÖÈùñÈùôËµ§Ë∑°Á∑ëÈå≤Á¶ÑÈªÑÊ®™ÁôΩÊ≥äÊüè‰ºØÊãçËø´Ëà∂Á≤ïÂè£ÂìÅÂô®Âê∏ÂèäÊâ±Á¥öÂñ´ÂêπÁÇäÂô¥Â¢≥ÊÜ§ÂêêÂë≥Êú™ÂòÜÂñùÊ∏áÂë™ÂîÜÂò±Â±ûÂëºÂîÑÂêü‰ªäÁê¥È≥¥Âî±ÊòåÊô∂Âè´Ëµ≥ÂñöÊèõÂîØÁ∂≠Âí≤Âì®Âè∑ÂëâÂ®ØË™§Âê¶ËàåÂêéÂîáËæ∞Â®†ÊåØÈúáÂì≤ÂïìÂõΩÂõ≥ÂúíÈÅ†Âõ£ÂúèÂ∑ªÂà∏Êã≥ÂõûÂõ≤‰∫ïËÄï‰∏ºÂõ∫ÂÄãÂõ∞ÂõöÊó•ÊóßÊó≠ÊõúÊò®ÈÖ¢‰ΩúË©êÊò†Ëã±Â§ÆÊöóÈóáÊöÅÂ∞≠ÊõôÁΩ≤ÊöëË´∏ÊöñÊòáÂçáÂºÅÊôØ‰∫¨ÂΩ±ÊòìÊòØÊõ∏Èü≥ÈüøÈÉ∑È¶ôÊôãÊõøÊö´Êñ¨Áî∞Áî∑ËÉÉÁï∞Á¥ØÂ°ÅÁï≥ÊÄùÁïôÁîªÁî∫‰∏ÅÈ†ÇË®ÇÂ∫ÅÁï•ÈÖ™Áµ°ËêΩÁïîÂçä‰º¥Âà§ÂçëÁ¢ëÈ¨ºÈ≠îÈÜúÂ°äÈ≠ÇÈ≠èÈ≠ÖÈ≠ÅÊõ≤ÂÖ∏Ë±äÁõÆÁúºÈôêÁû≥Á´•Áû¨Áù°ÂûÇÁú†Ê∞ëÁù¶ÁúåËá™ÈºªË≤∑ÁΩ™ÁΩ∞ÁæÖÁΩ∑Ë¶áË¶ÜËÖπË§áÂæ©ÁúÅÂ∞ëÁÇíÂ∞èÁúãÁù£Ë≤ùË¥àÊõΩÂÉßÂ±§Â¢óÊÜéË≤°ÊâçÊùêË≥≠ÊïóË≥†ÂüπÂÄçÈô™Ë≤©ÂèçÊùøÂùÇÈ£ØÈò™ÁâàÁâáË≤ØË≥ÑË≥äË≥ºÊ∫ùÊßãË¨õË≤ßË≤ªË≤¥Ë≤®ÂåñËä±Èù¥Èù©Ë≥ÉË≤∏‰ª£Ë¢ãË≥ÄÂä†Êû∂ÂòâË≤øË≥õË≥™Ë≥¢Â†ÖÂì°È°åÈ°òÈ†ëÈ°îÂΩ¶È°çÈ°ûÈ†àÈ†ªÊ≠©È†ÜÈ†ê‰∫àÈáéÈ†≠Ë±ÜÈÄóÈ°ïÈ°ßÈõáÊúàÂãùËÑöÂç¥ËÉ¥ËÖ∞Ë¶ÅËÖïËÉéÂè∞ÊÄ†ËÜ≥ÂñÑËÜ®ËÑÇÊó®ÊåáËÉ∏ËáìËîµËÖ∏È®∞ËÉûÂåÖÊ≥°Êä±Á†≤È£ΩËÇ•Ë±öËÇùÂπ≤Ê±óÂππÂàäËÉÜÊãÖËÑáËÑÖÂçîËÇ∫ËÑ≥ÊÇ©ËÑàËÜúÊúçËÑ±ËÇåÊú∫È£¢ËÉåËÇØÈ™®ËÖéÁÅ´ÁÅØÁÅΩÁáÉÁÑ∂ÁÑºÁÇâÁá•ÊìçËóªÁπ∞ÁÖ©ÁàÜÊö¥ÁÖôÁïëÁï†Ê∞¥Ê∞∑ÊπØÊµ©Ê≤àÊûïÊ¥ãÁæäÊ¥≤Â∑ûÈÖ¨Êµ∑ÊÇîÊØéÊ≤ñ‰∏≠‰ª≤Âø†ÁÅòÊ≥¢Á†¥ÊµÅÁêâÁ°´ÁÄ¨È†ºÊ∏¶Á¶çÈçãÈÅéÊ¥™ÊπæÊµ¶Ë£úÊçïËºîËí≤ËàóÊµúÂÖµÊΩüËáºËààÊ∏ØÊπñËÉ°Ê≤¢ÊäûÊ≥•Ê±†Âú∞‰πüÊ∑ÄÊ≤≥ÂèØ‰ΩïËç∑Â∑ùÊªùÁ´úÈæçÊ∏ìÈ∂èÊµÆÊºèÊ≥åÁßòÂøÖÊª¥ÊëòÈÅ©ÊïµÊ≤°ÊΩúÊµ∏‰æµÂØùÊ∑±Ê±öÊøØÊ¥óÂÖàÊ∫∂ÂÆπÊµ¥Ê¨≤Êº±Ê∂ºÊµÑÊ∑≥ÊΩ§ÊªëÊº¨Ê∏©Ê≤∏ÊπßÂãáÊ≤πÁî±Ê±ΩÊ∞óÊ±ÅÊªãÊÖàÁ£ÅÊ≤ªÊ∏ãÊπøÊ∂ôÊàªÊ≥£ÈÖíÊΩîÊ±∫ÊºîÊ∑ëÂèîÊ∂≤Ê∑∑ÊòÜÊøÉËæ≤Ê∫Ä‰∏°ÂÜÜÊº†ÊøÅÊøÄÊ¥ªÊã¨‰π±ËæûÂπ∏Â†±Ê∏¨ÂâáÂÅ¥Ê¥•Êº¢Ê±éÂá°Â∏ÜÊ∏°Â∫¶Ê∫ñÊªûÂ∏ØÊ∏àÊñâÂâ§Ê∑ªÊ¥æÊº´ÊÖ¢ÊªÖÊ≥ïÂéªÊºÇÁ•®Ê®ôÊµÖÈä≠Ë∑µÊº∏Ê∏ïÊ∑µÊ∫êÂéüÊ∏õÊ∂ØÊ∂àËÇñÊ∏âÊæÑÁôªÊ≥®Êü±ÈßêÊºÜÊ≤ôÁ†ÇÊ∑°Ë´áÁÇéÊ≥≥Ê∞∏Ë©†ÂáùÂáÜÈÖ∏ÈÖ∑ÂëäÈÖµÂ≠ùÊïôËÄÅÈÜ∏Â£åÂ¨¢Ë≠≤ÈÖçÈÖîÁ≤ãÊú®ÊûóÊ£ÆÊ®ãÊ§úÈ®ìÂâ£Èô∫Ê°ÉÈÄÉÊùæË®üÂÖ¨Ê¶éÊ®∫ËèØÊ§øÊùâÊ°úÊ°ßÊ™úÊ§éÊ•¢ÊßôÁúüÊÖéÊüøÊ¢®Ê°ÇÂú≠Ê•†Ê†πÁóïÊ©òÊ°ëÊ†ÉÊ†óÊ¶äÊ¢ÖÊùéÊü≥Ê•äÊèöÈôΩÊßªË¶èÊ®πÊûêÊû¢Êû†Ê¢ÅÊ£öÊúãÂ¥©ÊùúÊßΩÊõπÈÅ≠Ê®ΩÊ©ãÂñ¨ÂÉëÁüØÊ¨ÑËò≠ÊùëÊ†∏Ê†ºÂêÑÈñ£ÂÆ¢Ê¢∞ÊàíÊ¶ÇÊÖ®Ê£ãÊúüÂÖ∂ÁÆïÊóóÊ¨∫ÊùØ‰∏çÊûöÊ©üÂπæÁ£ØÁïøÊûØÂè§ÂßëÊïÖÊ†°‰∫§ËºÉÁµûÂäπÈÉäÊúΩÊ•µÊ®©Ê§çÊÆñÊßòÊ£íÂ•â‰ø∏Ê°üÊú≠ÊüÑÁóÖÊ®°Êú¥Êù°ÊüîÈõÜÊüìÊüªÊûùÊîØÁ§æÁ•àÁ•ñÁãôÁµÑÁ≤óÁßüÈòªÁ•ûÁî≥‰º∏Á¥≥Á¶ÖÊà¶Á•ùÁ§ºÁ¶èÂâØÂπÖÁ••Ë©≥Á•êÂè≥Á•âÊ≠¢Ë¶ñÂàùË¢´ÁöÆÂΩºÊä´Áñ≤Ë£ïË•üÁ¶ÅË¢ñË£∏ÈáëÈäÄÈäÖÂêåÊ¥ûÊ°êÁ≠íÈå´ÈâÑËø≠ÈãºÁ∂±Â≤°ÂâõÈâõÊ≤øÈè°Â¢ÉÈå¶ÈäÉÂÖÖÈéñÈáßÈéåÈáùÈã≠ÈàçÂ±ØÈã≥ÂØøÈå†ÂÆöÈçµÂª∫ÂÅ•Èâ¢Êú¨ÂΩìÈçõÊÆµÈêòÈäòÂêçÈëëÁõ£Ëâ¶Èá£ÈéÆÂúüÂ£≤Â£∞ÂñúÂ°æÁÜüÂ£ÅÁôñÂûãÂàëÂΩ¢Áì∂Áì¶Â¢®Â°óÂ¢úÂ†ïÊúâÂû£Â°ÄÂ±è‰ΩµÂ£áÂ°öÂ°îÊê≠Á≠îÂüéÊàêË™†ÁõõÂùëÊäóËà™Â†ÄÂ±àÊéòÂ†§ÊèêÂ†∞ÂüºÂ•áÂØÑÈ®éÂ¥éÂ†∫ÁïåÂ†¥ÂüüÂ£äÊáêÂ†™ÂãòÁîöÂùáÂüãÂ°©ÁêÜÈáåÁèæÁèçÁè†Êú±Ê†™ÊÆäÁëûÁè≠Áí∞ÈÇÑÁêÉÊ±ÇÊïëÁê¢ÁéãÁöáÊúõËÅñÁéâÁ¥†ÊØíÂ•èÊ≥∞È∫¶È∫πÁß¶ÁùÄÁæéÈ§äÂßúÂ∏≥Èï∑ÂºµÂπåÊôÉÂÖâÂ∏ΩÂÜí‰∫∫ÂÇæÈ†É‰Ω≥‰ΩøÂè≤ÂÄüÊòîÈåØÊÉúÂÉçÂãï‰ºëÂÇç‰ªªÂ¶äËçè‰ºùËª¢ÂÇ¨‰ø°‰ªèÊâï‰øÆÂÄ´Ëº™‰ºè‰ΩçÂÑ™ÊÜÇÂÇë‰øäÈßøÂ≥ª‰Ωì‰ø£ÂÇ∑ÂÉèË±°ÂÇµ‰ΩêÂ∑¶Â∑Æ‰øóË∞∑‰ø∫Â•ÑÂÉïÊí≤Ê•≠‰æ°‰øÇÁ≥ª‰ª∂ÂÄô‰æõÂÖ±‰ªñ‰ΩéÊäµÂ∫ïÈÇ∏ÂÅµË≤ûÁ¶éÂÄíÂà∞‰ø≥ÊéíËº©‰øµË°®ÂÇô‰æøÂÅΩÁÇ∫ÂÄ§ÁΩÆÁõ¥‰æùË°£‰ºäÂÄ≠Âßî‰ª∞ÂÅ∂ÈÅáÈöÖ‰æã‰ºº‰ª•ÂÅèÈÅçÁ∑®ÁØá‰ªÆ‰ΩèÂÄ∂ÂÖ∑ÂÑüË≥ûÂÅú‰∫≠ÂÅâÈÅïÁ∑ØÂÉöÈÅºÂØÆÁôÇ‰æÆ‰ªïÂ£´ÊÅ≠Âú®Â≠òÂæåË°åÂæÄ‰∏ªÂΩπÁñ´Ë°ìÂæãÂæ™ÁõæË°õÂæíËµ∞Ë∂ÖË∂ôË∂äËµ¥ÂæÆË°ùÂæπÊí§Âæ≥ÂæóÂæÅÊ≠£Ë®ºÁóáÊîøÊï¥ÂæêÂèôÈô§Ë°°Âæ°Âç∏Ë°óÂ•≥Â¶ÉÂß´Ëá£Ëá®Â™õÊè¥Â®òÂ´°Â¶ôÂ¶ñÂ¶ÇÂ©øÂ©¶Â•ΩÂ™íÂ©öÂßªÂõ†Â´ÅÂÆ∂Á®ºÂßìÁîüÊòüÊÄßÁâ≤Áî£ÂßãÂ´åÂÖºË¨ôÂ¶ªË®ÄË™∞Ë¨ÄÊüêË™ûÂêæÊÇüË©±Ë®òÂ∑±ÂøåÁ¥ÄËµ∑Ë≠∞Áæ©Áä†ÂÑÄË´ñË©∞ÂêâË™¨Á®éË™åÂøóË™≤ÊûúËèìÂ∑£Ë©ûÂè∏È£ºË®ìË™≠Ë®≥Ë™øÂΩ´Ë¨πÂã§Ë¨éËø∑Ë®àË´æË®∫Ë©¶ÂºèË´ÆË≥áÂßøÊ¨°Ë™ìË≠¶Êï¨È©öË≠∑Ë™òË≠òÁπîËÅ∑Ë®¥Ë™çÂøçÂàÉË®éË´≠ÊÑâËº∏ÁôíË¨ùÂ∞ÑË∫´Ë®±Ë™ïÂª∂Ë≠úÊôÆ‰∏¶Ë®≠Ë™áË¨°Êè∫Ë©ïÂπ≥Âù™Ë©≤ÂäæË´èÂèñË∂£ËÄ≥ÊÅ•ËÅ¥Âä©ËÅØÂøÉÊÖãËÉΩÁÜäÊÅØÊÅ©ÊÜ©ÊÅãÂ§âÊÄ•ÂøòÁõ≤Âøô‰∫°ÊÇ£ÊÇ™‰∫úÊÑèÊÄíÂ•¥Âä™ÊÅêÊÖ∞Â∞âÊÇ≤ÈùûÊââÊñêÊÉ≥Áõ∏ÊπòÁÆ±Êá∏ÊÇ†ÊÜ≤Êá≤Âæ¥ÊááÊÉëÊÑöÊÜæÊÑüÊÖ£Ë≤´Âø´ÊÇºÊÄñÂ∏ÉÂ∏åÊÉßÊÅ®ÊÉ®ÂèÇÊÅí‰∫òÊÖåËçíÊÄ™ÊâãÊíÉÊäïÊé®ÊãôÂá∫Êì¨ÁñëÊäÄÂ≤êÊê∫ÊíÆÊúÄÊéÉÊèèËãóÁå´ÊâπÊØîÁêµÊéßÊç®ËàéÊéõÊåøÊìÅÊé™Êé°ËèúÂΩ©Êé≤ÊéàÂèóÊãùÊãìÊäºÊãêÊì¶ÂØüÊêæÊè°ÊäúÈ´™ÂèãÊäπÊú´ÊåüÂ≥°Áã≠Êã°Â∫ÉÈâ±ÂÆèÁ¥òÊçÆÂ±ÖÊã†Âá¶ÊêçÊã∑ËÄÉÊâìÊäòÊå´Â∫ßÊäëÊé•ÊëÇÊâ∂Â§´ÊçúÊé¢ÊãæÊèÆËºùÊãíÂ∑®Ë∑ùÊãòË∂≥‰øÉÊçâË∫çË∏äÁî®Ë∏èË¶ãË¶™Êñ∞Ë¶≥ÂãßÊ≠ìË¶ßÂÖêÂÖãÂÖúÁ´∂ÈÄ±Âë®ËøëÊ¨£Êñ≠Ëæ∫ÂàÄÈÄüÊùüÁñéÈÅãÈÅäÈÅÖÈÄÜËæºÂÖ•ÈÄöÁóõÈÄî‰ΩôÊñúÈÅ∑ÈÄùÂ∑°ÈÅ£ÈÄÅËøîÈÄÄÈÄ†ÈÄ∏ÈÅÆËøΩÈÅÇÈÅîÈÄ≤ÈÅøÈÄÆËøÖÈÄìËøéËø∞ÈÄèÈÅ∏Â∑ΩÈÅ∫ËæªÊñπËÇ™ÂùäÂ¶®Ë®™ÊàøËä≥Á¥°Èò≤ÊîæÊñºÊóèÊóÖÊñΩÊóãÂåóÂçóË•øÊù±ÂáçÊ£üËªäËªåËª∏ËªüËªΩÂæÑËåéÁµåËªíËΩÑÂâ≤ËàüËàπËâáÂª∑Â∫≠‰∏πÊò•Â§èÁßãËê©ÂÜ¨ÊúùÊΩÆ‰πæ‰πôÈüìÂçàÊòºÊô©Â§úÈõ®Èõ≤ÊõáÈõ∞ÂàÜÁ¥õÁ≤âÈúßÂãôÁüõÈúûÊöáÈú≤Ë∑ØÈõ∑ÈõªÈõ™ÈúäÈúÄÊÑõÂ¶•ÁÜ±Ëí∏ÊâøÁÖÆËÄÖÁÖïÁÖßÊò≠Ê≤ºÊãõÁ¥πÂè¨Âã≤Ëñ´ÈªôÁÑ°ËàûÁÇπÈñÄÂïèÈñìÁ∞°Èñ¢ÈñëËÅûÈñãÈñâÈñ≤ÊÇ¶Èñ•‰ºêÈóòÂÜô‰∏éÂÜóÂÜ†ËªçÁ©¥Â≠óÂÆóÁ§∫ÂØõÂÆ∞ËæõÂü∑ÂØíÂØÇÂÆÆÂëÇÂÆùÂØÜÂØ©ÂÆüÁ™ÆÂÆ£ÂØßÂÆ≥ÂÆÖË®óÂÆãÂØ°ÂÆ§ÂÆòËèÖÁÆ°È§®ÈòúÂÆ¥Ë≥ìÂØåÂÜ®ÂÆúÂÆáÂ§©ÂÆôÊäΩÂÆâÊ°àÂÆåÂÖÉÁø´ÂØÖ‰∏∏Á©∂Á™ÅÁ™ÉÂàáÁ™íÁ™™Á™ØÁ™ìÁ©∫Â≠¶Ë¶öÊ†ÑÂñ∂ËõçÂä¥ÊéåÂ†ÇÂÖöÂ∏∏ÂìÄË°∞Âñ™Ë£èË£ÇÂàóÁÉàË£ÖÂ£ÆËçòË£ΩÂà∂Ë§í‰øùÂëÜË•≤ÂçíÁéáË±™‰∫Æ‰∫´‰∫®ËÇ≤Ê£ÑÂêëÂ∞öÊåôË™âÂ•ÆÂ•àÂ•îÂ•™ÂØ∏ËÄêÂØæÂ∞ÅËæ±Â∞äÂ∞éÈÅìÈ¶ñÂ∞ãË£ÅËºâÊ†ΩÂúßÂ®ÅÁÅ∞ÂéÑÊ≠¥Êö¶ÂéöÂéòÂ∏≠Â∫äÈ∫ªÊë©Á£®ÂªäÈÉéÊúóÂ∫´Â∫ú‰ªòÁ¨¶Â∫óÂïÜÂ∫∑ÊÖ∂Â∫∏È∑πËÖêËÇâÂªâÂ∫∂Â∫èÂªÉÁô∫Â∫µÂøúÂªüÈπøÈ∫óÁó¢Âà©ÁñæÁó¥Áü•Êô∫ËôéËôöÊàØËôúÊÖÆËÜöÁõßËôêÂäáÂ±ãÂ±ÄÂ∞ªÂ∞æÊ¢∂ÊØõÂ∞øÂ±äÂ±ïÂ±•Â∞ΩÂ∞ºÊà∏ÊâÄËÇ©ÊâáÂêàÂê´ÂëΩ‰ºÅÂÖ®ÂÇòÂØ∫ÊôÇÊåÅ‰æçË©©ÂæÖÁâπÁ≠âÈ≠öÊºÅÈØ®ÈÆÆËô´ËõáËöäËù∂ËûçÁã¨ÁãºÊµ™ËâØÁãÇÁåõÂ≠üÁã©ÂÆàÁåüÁå™ÁçÖÂ∏´Â∏•Áç≤Á©´Áå∂ÁäØÁåøÁçÑÈ¶¨ÈßíÂè•ÈßÜÂå∫Ê¨ßÊÆ¥ÈßÖÈ®íÈßÑÂ§™ÁÉèÈ≥•È≥©Èµ¨È¥ªÈ¥àÈ¥®ÈµúÈ∂¥È∑≤Â∞±Â≥∂Â∂ãÂ∂åÁâõÁâü‰π≥Áâ©‰∫ãÁâßÈõÑÈõ¢ÈõëÈõ£ÈõÄÁæΩÁøíÁøåÁøºÁøîÁøªÁï™Ëó©Âπ°ÁøÅËå®ËãëËäΩÁâôÈõÖËëâËäù‰πã‰πèËçâÊó©ÂçìËä¶Ëä≠Â∑¥ÊääÁê∂ËïâËå∂ËèåËèäËëµËóçËñÆËìÆÈÄ£Ëä•‰ªãËëõËè©ËçªËåÖËòáËè±ÂãüÊÖïËã•ÊöÆÂ¢ìÂπïËìÑÁïúËä∏ËóùËë¨Ê≠ªËñ©Ëñ¶Ëñ¨Ê•ΩÂ§¢Ëó§ËåÇËñÑÂçöÁ∏õÂ∞ÇÁ∞øËã´Âç†Ëã¶Á≥∏Á∑íËëóÁ∏æË≤¨Á©çÁµ±Áµ¶Á∑©Á¥çÂÜÖÁ∑èËÅ°Á¥îÁµπÁ∂øÁ∑öÊ≥âÁ∂≤Á∏ÑÁµêÁ∑†Â∏ùÁ¥ÑÁöÑÁ∏ÅÁ∂ôÁµ∂Ëâ≤ÁµÇÁ¥ôÊ∞èÁ¥ãÊñáÊñéÁ≤õÁµµ‰ºöÁ∂æÁπäÁ¥∞Á∂öÁ∏¶ÂæìÁ≥æÁ∏ÆÂÆøÁ∑¥Á¥¢Á∑äÁπÅÁ´πÁØâÁ≠ëÁØ†Á¨π‰∏ñÁ¨õÁØ§Á≠ãÁØÄÂç≥Á¨ëÁÆóÁ≠ÜËÇáÁ±çÁ≠ñÁØÑÁ±≥ÊñôÊñóÁ≤íÁ¨†Á´ãÁ´ØÁ≥ñÂîêÁ≤ßÂ∫ÑÁ≤òÁ≥ßÈáèÁßÅÁ®öÁ®îÂøµÁ©èÈö†ÂíåÁßªÁ®ãÂëàÁ®≤Á©ÇÊÅµÁßíÁß∞Áß©Â§±ÁßëÁ®ÆÈáçÁ®øÈ´òÂ≠£ÁßÄ‰πÉÈáàÂ∞∫Áü≥Á§éÁ§ÅÁÑ¶Á†îÁ†ïÁ¢∫Á°¨Êõ¥Á¢ÅÂü∫Â±±‰ªôÂ¥îÂ≤©Â∑åÂé≥Êï¢Â≤∏ÁÇ≠Â≥†‰∏ä‰∏ãÂ≤≥‰∏òÂ∂ΩÂ≥∞Â≥ØÈÄ¢Á∏´Â∂∫È†òÂµêÈ¢®ÂáßÂ≤¨Áî≤Â¥áÁöøÁõÜÁõ§Á£êÊê¨Ëà¨ÁõóÁõüÊòéÁõäË°ÄË°ÜÈ£üÈ£≤È£æÈ§ìÊàëÊó¢Â§ßËá≠Â∞ñÂ••Â•®Â∞ÜÂ•ëÁä¨ÁåÆÁä∂Áç£ÂäõÂπºÂãâÂÖçÂä±Âã¢Âä£Â§ïÂ§ñÊÆãÊÆâÊó¨Â§ö‰πÖÂ∑•È†ÖÂäüÊîªÂ∑ßÊ±üÁ¥ÖËôπË≤¢Ê¨†Ê≠åÊ¨æÈö∑ÊïèÊîπÊï∑Êï£Êï∞Ëá¥Ëá≥Ëµ¶Êï¶ËßíËß¶Ëß£‰∫âË≤†Âç±‰∫ÄÂåªÁü¢Áü≠Âå†ÂåπÂåøÂá∂ÂáΩÂπΩÂà∑Ââ∞‰πóÂâµÂÄâÂâñÂà•ÂâäÂààÂäâÂàªÂà∫Â∏∞ÊÆ∫Á©ÄÊÆªÊÆøÊØÖÂèàÂèéÂèåÈöªÈö£Êù•Èô£ÈöÜÈôçÈöõÁ•≠ÈöäÈöèÈ´ÑÈô¢ÈôµÁ®úÈô∏ÈöéÁöÜÈôõÈô∞Èô∂Èô≥ÈöúÁ´†ÂΩ∞ÈöîÈô•ÈÇ¶ÈÑ≠ÈÉΩÈÉ°ÂêõÁæ§ÈÉ®ÈÉµÈÇ™ÈÉÅÈÇ£ÈÉ≠ÈòøÂºìÂºïÂºòÂº∑ÂºæÂçòÂº¶ÁéÑÂπªÂº•Âº±Âç∞ÂÜçÂçµ‰∏à‰∫íÈºìÊ≠¶È£õÂÜäÁº∂ÂºäÂπ£Èù¢Ââç`.split('');

    const translations = {
      ja: {
        title: 'Êº¢Â≠ó„Éû„Çπ„Çø„Éº',
        gridView: '„Ç∞„É™„ÉÉ„ÉâË°®Á§∫',
        studyMode: 'Â≠¶Áøí„É¢„Éº„Éâ',
        exportData: '„Éá„Éº„ÇøÂá∫Âäõ',
        importData: '„Éá„Éº„ÇøÂÖ•Âäõ',
        unknown: 'Êú™Â≠¶Áøí',
        learning: 'Â≠¶Áøí‰∏≠',
        familiar: 'ÊÖ£„Çå„Åü',
        known: 'Êó¢Áü•',
        mastered: 'ÁøíÂæóÊ∏à„Åø',
        allLevels: 'ÂÖ®„É¨„Éô„É´',
        unknownOnly: 'Êú™Â≠¶Áøí„ÅÆ„Åø',
        learningOnly: 'Â≠¶Áøí‰∏≠„ÅÆ„Åø',
        familiarOnly: 'ÊÖ£„Çå„Åü„ÇÇ„ÅÆ„ÅÆ„Åø',
        knownOnly: 'Êó¢Áü•„ÅÆ„Åø',
        reviewDue: 'Âæ©ÁøíÂøÖË¶Å',
        sortBy: '‰∏¶„Å≥Êõø„Åà',
        random: '„É©„É≥„ÉÄ„É†',
        frequency: 'È†ªÂ∫¶',
        proficiency: 'ÁøíÁÜüÂ∫¶',
        levelFilter: '„É¨„Éô„É´„Éï„Ç£„É´„Çø„Éº',
        studyLimit: 'Â≠¶ÁøíÊï∞',
        kunReading: 'Ë®ìË™≠„Åø',
        onReading: 'Èü≥Ë™≠„Åø',
        meaning: 'ÊÑèÂë≥',
        examples: '‰æãÊñá',
        strokeOrder: 'Á≠ÜÈ†Ü',
        showInContext: 'ÊñáËÑà„ÅßË°®Á§∫',
        showAnswer: 'Á≠î„Åà„ÇíË¶ã„Çã',
        total: 'ÂêàË®à',
        totalKanji: 'ÂêàË®àÊº¢Â≠ó',
        inProgress: 'Â≠¶Áøí‰∏≠',
        unknownCount: 'Êú™Â≠¶Áøí',
        dataUnavailable: '„Éá„Éº„Çø„Å™„Åó',
        again: '„ÇÇ„ÅÜ‰∏ÄÂ∫¶',
        hard: 'Èõ£„Åó„ÅÑ',
        good: 'ËâØ„ÅÑ',
        easy: 'Á∞°Âçò',
        noKanji: 'ÈÅ∏Êäû„Åó„Åü„Éï„Ç£„É´„Çø„Éº„Å´Ë©≤ÂΩì„Åô„ÇãÊº¢Â≠ó„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ',
        adjustFilters: '„Éï„Ç£„É´„Çø„ÉºË®≠ÂÆö„ÇíË™øÊï¥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
        sessionComplete: 'Â≠¶Áøí„Çª„ÉÉ„Ç∑„Éß„É≥ÂÆå‰∫ÜÔºÅ',
        selectFilter: 'Êñ∞„Åó„ÅÑ„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÈñãÂßã„Åô„Çã„Å´„ÅØ„Éï„Ç£„É´„Çø„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
        noExamples: '‰æãÊñá„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì',
        strokeNotAvailable: 'Á≠ÜÈ†Ü„Éá„Éº„Çø„Å™„Åó',
        importConfirm: 'ÁèæÂú®„ÅÆÈÄ≤Êçó„ÇíÁΩÆ„ÅçÊèõ„Åà„Åæ„Åô„ÄÇÁ∂öË°å„Åó„Åæ„Åô„ÅãÔºü',
        importSuccess: '„Éá„Éº„Çø„ÅåÊ≠£Â∏∏„Å´„Ç§„É≥„Éù„Éº„Éà„Åï„Çå„Åæ„Åó„ÅüÔºÅ',
        importError: '„Éá„Éº„Çø„ÅÆ„Ç§„É≥„Éù„Éº„Éà„Ç®„É©„Éº: ',
        invalidFile: 'ÁÑ°Âäπ„Å™„Éá„Éº„Çø„Éï„Ç°„Ç§„É´: kanjiProgress„Åå„ÅÇ„Çä„Åæ„Åõ„Çì',
        dropJson: 'JSON„Éï„Ç°„Ç§„É´„Çí„Éâ„É≠„ÉÉ„Éó„Åó„Å¶„Ç§„É≥„Éù„Éº„Éà',
        dropJsonOnly: 'JSON„Éï„Ç°„Ç§„É´„Çí„Éâ„É≠„ÉÉ„Éó„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
        clickToStudy: '„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Â≠¶Áøí',
        progressCounter: 'ÊûöÁõÆ / '
      },
      en: {
        title: 'Kanji Master',
        gridView: 'Grid View',
        studyMode: 'Study Mode',
        exportData: 'Export Data',
        importData: 'Import Data',
        unknown: 'Unknown',
        learning: 'Learning',
        familiar: 'Familiar',
        known: 'Known',
        mastered: 'Mastered',
        allLevels: 'All Levels',
        unknownOnly: 'Unknown Only',
        learningOnly: 'Learning Only',
        familiarOnly: 'Familiar Only',
        knownOnly: 'Known Only',
        reviewDue: 'Review Due',
        sortBy: 'Sort By',
        random: 'Random',
        frequency: 'Frequency',
        proficiency: 'Proficiency Level',
        levelFilter: 'Level Filter',
        studyLimit: 'Study Limit',
        kunReading: 'Kunyomi',
        onReading: 'Onyomi',
        meaning: 'Meaning',
        examples: 'Examples',
        strokeOrder: 'Stroke Order',
        showInContext: 'Show in Context',
        showAnswer: 'Show Answer',
        total: 'Total',
        totalKanji: 'Total Kanji',
        inProgress: 'In Progress',
        unknownCount: 'Unknown',
        dataUnavailable: 'Data unavailable',
        again: 'Again',
        hard: 'Hard',
        good: 'Good',
        easy: 'Easy',
        noKanji: 'No kanji available for the selected filters.',
        adjustFilters: 'Try adjusting your filter settings.',
        sessionComplete: 'Study session complete!',
        selectFilter: 'Select a filter to start a new session.',
        noExamples: 'No examples available',
        strokeNotAvailable: 'Stroke order not available',
        importConfirm: 'This will replace your current progress. Continue?',
        importSuccess: 'Data imported successfully!',
        importError: 'Error importing data: ',
        invalidFile: 'Invalid data file: missing kanjiProgress',
        dropJson: 'Drop JSON file to import',
        dropJsonOnly: 'Please drop a JSON file',
        clickToStudy: 'Click to study',
        progressCounter: ' of '
      }
    };

    const app = {
      kanjiData: {},
      currentKanji: null,
      studyQueue: [],
      currentIndex: 0,
      currentKanjiFullData: null,
      nextKanjiData: null, // Cache for pre-fetched next card
      language: 'ja',
      savedSession: null, // Track saved study session
      
      init() {
        this.loadLanguage();
        this.loadDarkMode();
        this.loadData();
        this.loadTogglePreferences();
        this.loadSavedSession();
        this.setupEventListeners();
        this.renderGrid();
        this.updateStats();
        this.applyTranslations();
      },
      
      loadSavedSession() {
        const saved = localStorage.getItem('savedStudySession');
        if (saved) {
          this.savedSession = JSON.parse(saved);
        }
      },
      
      saveSession() {
        if (this.studyQueue.length > 0 && this.currentIndex < this.studyQueue.length) {
          const session = {
            studyQueue: this.studyQueue,
            currentIndex: this.currentIndex,
            filter: document.getElementById('level-filter').value,
            sort: document.getElementById('sort-option').value,
            limit: document.getElementById('study-limit').value,
            timestamp: new Date().toISOString()
          };
          localStorage.setItem('savedStudySession', JSON.stringify(session));
          this.savedSession = session;
        }
      },
      
      clearSession() {
        localStorage.removeItem('savedStudySession');
        this.savedSession = null;
      },
      
      autoResumeOrStart() {
        // If we have a saved session, restore it automatically
        if (this.savedSession && this.savedSession.studyQueue.length > 0) {
          // Restore the session
          this.studyQueue = this.savedSession.studyQueue;
          this.currentIndex = this.savedSession.currentIndex;
          
          // Restore the controls
          document.getElementById('level-filter').value = this.savedSession.filter;
          document.getElementById('sort-option').value = this.savedSession.sort;
          document.getElementById('study-limit').value = this.savedSession.limit;
          
          // Show the study card
          document.getElementById('study-card').style.display = 'flex';
          document.getElementById('no-kanji').style.display = 'none';
          
          // Clear any old answer data
          document.getElementById('kanji-info').classList.remove('visible');
          document.getElementById('rating-buttons').classList.remove('visible');
          document.getElementById('show-answer-btn').style.display = 'block';
          document.getElementById('kanji-reading').innerHTML = '';
          document.getElementById('kanji-meaning').textContent = '';
          document.getElementById('kanji-examples').innerHTML = '';
          
          // Update progress counter
          this.updateProgressCounter();
          
          // Show the card
          this.showCard();
        } else {
          // No saved session, start fresh
          this.startStudy();
        }
      },
      
      loadLanguage() {
        const saved = localStorage.getItem('language');
        if (saved) {
          this.language = saved;
        }
      },
      
      toggleLanguage() {
        this.language = this.language === 'ja' ? 'en' : 'ja';
        localStorage.setItem('language', this.language);
        document.getElementById('language-btn').textContent = this.language === 'ja' ? 'EN' : 'Êó•Êú¨Ë™û';
        this.applyTranslations();
        this.renderGrid(); // Re-render grid to update tooltips
        this.updateProgressCounter(); // Update progress counter
      },
      
      loadDarkMode() {
        const saved = localStorage.getItem('darkMode');
        if (saved === 'true') {
          document.body.classList.add('dark-mode');
          document.getElementById('dark-mode-btn').textContent = '‚òÄÔ∏è';
        }
      },
      
      toggleDarkMode() {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        localStorage.setItem('darkMode', isDark);
        
        // Update icon
        document.getElementById('dark-mode-btn').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
      },
      
      t(key) {
        return translations[this.language][key] || key;
      },
      
      applyTranslations() {
        // Header
        document.querySelector('h1').textContent = this.t('title');
        document.querySelectorAll('.tab-btn')[0].textContent = this.t('gridView');
        document.querySelectorAll('.tab-btn')[1].textContent = this.t('studyMode');
        document.getElementById('language-btn').textContent = this.language === 'ja' ? 'EN' : 'Êó•Êú¨Ë™û';
        document.getElementById('export-btn').textContent = this.t('exportData');
        document.getElementById('import-btn').textContent = this.t('importData');
        
        // Legend
        const legendItems = document.querySelectorAll('.legend-item span');
        legendItems[0].textContent = this.t('unknown');
        legendItems[1].textContent = this.t('learning');
        legendItems[2].textContent = this.t('familiar');
        legendItems[3].textContent = this.t('known');
        legendItems[4].textContent = this.t('mastered');
        
        // Study labels
        document.getElementById('label-filter').textContent = this.t('levelFilter');
        document.getElementById('label-sort').textContent = this.t('sortBy');
        document.getElementById('label-limit').textContent = this.t('studyLimit');
        
        // Sort options
        document.getElementById('sort-random').textContent = this.t('random');
        document.getElementById('sort-frequency').textContent = this.t('frequency');
        document.getElementById('sort-level').textContent = this.t('proficiency');
        
        // Checkbox labels - need to preserve the checkbox input
        const kunCheckbox = document.getElementById('show-kun');
        const onCheckbox = document.getElementById('show-on');
        const meaningCheckbox = document.getElementById('show-meaning');
        const examplesCheckbox = document.getElementById('show-examples');
        const strokeCheckbox = document.getElementById('show-stroke-order');
        
        document.getElementById('label-kun').innerHTML = `<input type="checkbox" id="show-kun" ${kunCheckbox.checked ? 'checked' : ''} onchange="app.saveTogglePreferences(); app.updateDisplay()"> ${this.t('kunReading')}`;
        document.getElementById('label-on').innerHTML = `<input type="checkbox" id="show-on" ${onCheckbox.checked ? 'checked' : ''} onchange="app.saveTogglePreferences(); app.updateDisplay()"> ${this.t('onReading')}`;
        document.getElementById('label-meaning').innerHTML = `<input type="checkbox" id="show-meaning" ${meaningCheckbox.checked ? 'checked' : ''} onchange="app.saveTogglePreferences(); app.updateDisplay()"> ${this.t('meaning')}`;
        document.getElementById('label-examples').innerHTML = `<input type="checkbox" id="show-examples" ${examplesCheckbox.checked ? 'checked' : ''} onchange="app.saveTogglePreferences(); app.updateDisplay()"> ${this.t('examples')}`;
        document.getElementById('label-stroke').innerHTML = `<input type="checkbox" id="show-stroke-order" ${strokeCheckbox.checked ? 'checked' : ''} onchange="app.saveTogglePreferences(); app.updateDisplay()"> ${this.t('strokeOrder')}`;
        
        const contextCheckbox = document.getElementById('show-in-context');
        document.getElementById('label-context').innerHTML = `<input type="checkbox" id="show-in-context" ${contextCheckbox.checked ? 'checked' : ''} onchange="app.saveTogglePreferences(); app.updateContextDisplay()"> ${this.t('showInContext')}`;
        
        // Show answer button
        document.getElementById('show-answer-btn').textContent = this.t('showAnswer');
        
        // Stats
        document.getElementById('stat-total').textContent = this.t('totalKanji');
        document.getElementById('stat-mastered').textContent = this.t('mastered');
        document.getElementById('stat-progress').textContent = this.t('inProgress');
        document.getElementById('stat-unknown').textContent = this.t('unknownCount');
        
        // Rating buttons
        document.getElementById('rating-again').textContent = this.t('again');
        document.getElementById('rating-hard').textContent = this.t('hard');
        document.getElementById('rating-good').textContent = this.t('good');
        document.getElementById('rating-easy').textContent = this.t('easy');
        document.getElementById('rating-learning').textContent = this.t('learning');
        document.getElementById('rating-familiar').textContent = this.t('familiar');
        document.getElementById('rating-known').textContent = this.t('known');
        document.getElementById('rating-mastered').textContent = this.t('mastered');
        
        // Update filter counts to use current language
        this.updateFilterCounts();
        
        // No kanji messages
        document.getElementById('no-kanji-msg').textContent = this.t('noKanji');
        document.getElementById('no-kanji-hint').textContent = this.t('adjustFilters');
        
        // Drop overlay
        document.querySelector('.drop-message').textContent = this.t('dropJson');
      },
      
      loadTogglePreferences() {
        const prefs = localStorage.getItem('togglePreferences');
        if (prefs) {
          const preferences = JSON.parse(prefs);
          document.getElementById('show-kun').checked = preferences.showKun ?? true;
          document.getElementById('show-on').checked = preferences.showOn ?? true;
          document.getElementById('show-meaning').checked = preferences.showMeaning ?? true;
          document.getElementById('show-examples').checked = preferences.showExamples ?? false;
          document.getElementById('show-stroke-order').checked = preferences.showStrokeOrder ?? false;
          document.getElementById('show-in-context').checked = preferences.showInContext ?? false;
        } else {
          // Set defaults
          document.getElementById('show-kun').checked = true;
          document.getElementById('show-on').checked = true;
          document.getElementById('show-meaning').checked = true;
          document.getElementById('show-examples').checked = false;
          document.getElementById('show-stroke-order').checked = false;
          document.getElementById('show-in-context').checked = false;
        }
      },
      
      saveTogglePreferences() {
        const preferences = {
          showKun: document.getElementById('show-kun').checked,
          showOn: document.getElementById('show-on').checked,
          showMeaning: document.getElementById('show-meaning').checked,
          showExamples: document.getElementById('show-examples').checked,
          showStrokeOrder: document.getElementById('show-stroke-order').checked,
          showInContext: document.getElementById('show-in-context').checked
        };
        localStorage.setItem('togglePreferences', JSON.stringify(preferences));
      },
      
      loadData() {
        const saved = localStorage.getItem('kanjiProgress');
        if (saved) {
          this.kanjiData = JSON.parse(saved);
        } else {
          // Initialize all kanji as unknown
          KANJI_LIST.forEach(kanji => {
            this.kanjiData[kanji] = {
              level: 0, // 0=unknown, 1=learning, 2=familiar, 3=known, 4=mastered
              lastReview: null,
              nextReview: null,
              reviewCount: 0
            };
          });
          this.saveData();
        }
      },
      
      saveData() {
        localStorage.setItem('kanjiProgress', JSON.stringify(this.kanjiData));
      },
      
      exportData() {
        const data = {
          kanjiProgress: this.kanjiData,
          togglePreferences: JSON.parse(localStorage.getItem('togglePreferences') || '{}'),
          exportDate: new Date().toISOString(),
          version: '1.0'
        };
        
        const json = JSON.stringify(data, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `kanji-progress-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      },
      
      importData(file) {
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = JSON.parse(e.target.result);
            
            // Validate the data structure
            if (!data.kanjiProgress) {
              alert(this.t('invalidFile'));
              return;
            }
            
            // Confirm before overwriting
            if (!confirm(this.t('importConfirm'))) {
              return;
            }
            
            // Import the data
            this.kanjiData = data.kanjiProgress;
            this.saveData();
            
            // Import preferences if they exist
            if (data.togglePreferences) {
              localStorage.setItem('togglePreferences', JSON.stringify(data.togglePreferences));
              this.loadTogglePreferences();
            }
            
            // Refresh the display
            this.renderGrid();
            this.updateStats();
            
            alert(this.t('importSuccess'));
          } catch (error) {
            alert(this.t('importError') + error.message);
          }
          
          // Reset the file input
          document.getElementById('import-file').value = '';
        };
        
        reader.readAsText(file);
      },
      
      setupEventListeners() {
        // Language button
        document.getElementById('language-btn').addEventListener('click', () => {
          this.toggleLanguage();
        });
        
        // Export/Import buttons
        document.getElementById('export-btn').addEventListener('click', () => {
          this.exportData();
        });
        
        document.getElementById('import-btn').addEventListener('click', () => {
          document.getElementById('import-file').click();
        });
        
        document.getElementById('import-file').addEventListener('change', (e) => {
          this.importData(e.target.files[0]);
        });
        
        // Drag and drop
        let dragCounter = 0;
        const overlay = document.getElementById('drop-overlay');
        
        document.addEventListener('dragenter', (e) => {
          e.preventDefault();
          dragCounter++;
          if (dragCounter === 1) {
            overlay.classList.add('active');
          }
        });
        
        document.addEventListener('dragleave', (e) => {
          e.preventDefault();
          dragCounter--;
          if (dragCounter === 0) {
            overlay.classList.remove('active');
          }
        });
        
        document.addEventListener('dragover', (e) => {
          e.preventDefault();
        });
        
        document.addEventListener('drop', (e) => {
          e.preventDefault();
          dragCounter = 0;
          overlay.classList.remove('active');
          
          const files = e.dataTransfer.files;
          if (files.length > 0) {
            const file = files[0];
            if (file.type === 'application/json' || file.name.endsWith('.json')) {
              this.importData(file);
            } else {
              alert(this.t('dropJsonOnly'));
            }
          }
        });
        
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            e.target.classList.add('active');
            const page = e.target.dataset.page;
            document.getElementById(page + '-page').classList.add('active');
            
            // Auto-start study when switching to study page
            if (page === 'study') {
              // Hide answer info IMMEDIATELY before startStudy runs
              document.getElementById('kanji-info').classList.remove('visible');
              document.getElementById('rating-buttons').classList.remove('visible');
              document.getElementById('show-answer-btn').style.display = 'block';
              
              // Auto-resume if there's a saved session, otherwise start fresh
              app.autoResumeOrStart();
            } else {
              // Save session when leaving study mode
              if (app.studyQueue.length > 0 && app.currentIndex < app.studyQueue.length) {
                app.saveSession();
              }
              
              // Clear study card display when leaving study mode
              document.getElementById('current-kanji').textContent = '';
              document.getElementById('context-display').textContent = '';
              document.getElementById('context-display').style.display = 'none';
              document.getElementById('session-progress').textContent = '';
            }
          });
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
          // Ignore if typing in an input field
          if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
          
          const key = e.key.toLowerCase();
          const isAnswerVisible = document.getElementById('kanji-info').classList.contains('visible');
          const isStudyMode = document.getElementById('study-page').classList.contains('active');
          
          // Only handle shortcuts in study mode
          if (!isStudyMode) return;
          
          // Space/Enter - Show Answer
          if ((key === ' ' || key === 'enter') && !isAnswerVisible) {
            e.preventDefault();
            this.showAnswer();
            return;
          }
          
          // Number keys 0-4 - Rate cards (only when answer is visible)
          if (isAnswerVisible && ['0', '1', '2', '3', '4'].includes(key)) {
            e.preventDefault();
            const rating = parseInt(key);
            this.rateCard(rating);
            return;
          }
          
          // Toggle shortcuts (work anytime in study mode)
          if (key === 'k') {
            e.preventDefault();
            document.getElementById('show-kun').click();
            return;
          }
          if (key === 'o') {
            e.preventDefault();
            document.getElementById('show-on').click();
            return;
          }
          if (key === 'm') {
            e.preventDefault();
            document.getElementById('show-meaning').click();
            return;
          }
          if (key === 'e') {
            e.preventDefault();
            document.getElementById('show-examples').click();
            return;
          }
          if (key === 's') {
            e.preventDefault();
            document.getElementById('show-stroke-order').click();
            return;
          }
          
          // Arrow keys / Backspace - Navigate cards
          if (key === 'arrowleft' || key === 'backspace') {
            e.preventDefault();
            this.previousCard();
            return;
          }
          if (key === 'arrowright') {
            e.preventDefault();
            this.nextCard();
            return;
          }
          
          // R - Restart session
          if (key === 'r') {
            e.preventDefault();
            this.startStudy();
            return;
          }
          
          // Escape - Skip card
          if (key === 'escape') {
            e.preventDefault();
            this.skipCard();
            return;
          }
        });
      },
      
      renderGrid() {
        const grid = document.getElementById('kanji-grid');
        grid.innerHTML = '';
        
        KANJI_LIST.forEach(kanji => {
          const cell = document.createElement('div');
          cell.className = 'kanji-cell ' + this.getLevelClass(kanji);
          cell.textContent = kanji;
          cell.title = `${this.t('clickToStudy')}: ${kanji}`;
          cell.addEventListener('click', () => this.studySpecificKanji(kanji));
          grid.appendChild(cell);
        });
      },
      
      studySpecificKanji(kanji) {
        // Clear saved session when manually selecting a specific kanji
        this.clearSession();
        
        // Switch to study mode tab
        this.switchTab('study');
        
        // Hide answer info IMMEDIATELY
        document.getElementById('kanji-info').classList.remove('visible');
        document.getElementById('rating-buttons').classList.remove('visible');
        document.getElementById('show-answer-btn').style.display = 'block';
        document.getElementById('kanji-reading').innerHTML = '';
        document.getElementById('kanji-meaning').textContent = '';
        document.getElementById('kanji-examples').innerHTML = '';
        
        // Create a study queue with just this kanji
        this.studyQueue = [kanji];
        this.currentIndex = 0;
        
        // Show study card
        document.getElementById('study-card').style.display = 'flex';
        document.getElementById('no-kanji').style.display = 'none';
        
        // Update progress counter
        this.updateProgressCounter();
        
        // Load the card
        this.showCard();
      },
      
      switchTab(page) {
        // Update tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.classList.remove('active');
          if (btn.dataset.page === page) {
            btn.classList.add('active');
          }
        });
        
        // Update pages
        document.querySelectorAll('.page').forEach(p => {
          p.classList.remove('active');
        });
        document.getElementById(page + '-page').classList.add('active');
      },
      
      getLevelClass(kanji) {
        const level = this.kanjiData[kanji]?.level || 0;
        const classes = ['unknown', 'learning', 'familiar', 'known', 'mastered'];
        return classes[level];
      },
      
      updateStats() {
        const stats = { unknown: 0, learning: 0, familiar: 0, known: 0, mastered: 0 };
        KANJI_LIST.forEach(kanji => {
          const level = this.kanjiData[kanji]?.level || 0;
          const key = ['unknown', 'learning', 'familiar', 'known', 'mastered'][level];
          stats[key]++;
        });
        
        document.getElementById('total-kanji').textContent = KANJI_LIST.length;
        document.getElementById('mastered-count').textContent = stats.mastered;
        document.getElementById('learning-count').textContent = stats.learning + stats.familiar + stats.known;
        document.getElementById('unknown-count').textContent = stats.unknown;
        
        // Update filter counts
        this.updateFilterCounts();
      },
      
      updateFilterCounts() {
        const now = new Date();
        
        // Count cards for each filter
        const counts = {
          all: KANJI_LIST.length,
          unknown: 0,
          learning: 0,
          familiar: 0,
          known: 0,
          review: 0
        };
        
        KANJI_LIST.forEach(kanji => {
          const data = this.kanjiData[kanji] || { level: 0, lastReview: null, nextReview: null, reviewCount: 0 };
          
          if (data.level === 0) counts.unknown++;
          if (data.level === 1) counts.learning++;
          if (data.level === 2) counts.familiar++;
          if (data.level === 3) counts.known++;
          
          // Count review due
          if (data.nextReview && new Date(data.nextReview) <= now) {
            counts.review++;
          }
        });
        
        // Update option text with counts using translations
        document.getElementById('filter-all').textContent = `${this.t('allLevels')} (${counts.all})`;
        document.getElementById('filter-unknown').textContent = `${this.t('unknownOnly')} (${counts.unknown})`;
        document.getElementById('filter-learning').textContent = `${this.t('learningOnly')} (${counts.learning})`;
        document.getElementById('filter-familiar').textContent = `${this.t('familiarOnly')} (${counts.familiar})`;
        document.getElementById('filter-known').textContent = `${this.t('knownOnly')} (${counts.known})`;
        document.getElementById('filter-review').textContent = `${this.t('reviewDue')} (${counts.review})`;
      },
      
      updateProgressCounter() {
        const progressElement = document.getElementById('session-progress');
        if (this.studyQueue.length > 0) {
          const current = this.currentIndex + 1;
          const total = this.studyQueue.length;
          progressElement.textContent = `${current}${this.t('progressCounter')}${total}`;
        } else {
          progressElement.textContent = '';
        }
      },
      
      async startStudy() {
        const filter = document.getElementById('level-filter').value;
        const sort = document.getElementById('sort-option').value;
        const limitValue = document.getElementById('study-limit').value;
        
        // Clear any saved session when starting a new one
        this.clearSession();
        
        const now = new Date();
        
        // Build queue based on filter
        this.studyQueue = KANJI_LIST.filter(kanji => {
          const data = this.kanjiData[kanji] || { level: 0, lastReview: null, nextReview: null, reviewCount: 0 };
          
          // First check the level filter
          if (filter === 'all') return true;
          if (filter === 'unknown') return data.level === 0;
          if (filter === 'learning') return data.level === 1;
          if (filter === 'familiar') return data.level === 2;
          if (filter === 'known') return data.level === 3;
          if (filter === 'review') {
            // Only show cards that are due for review
            if (!data.nextReview) return false;
            return new Date(data.nextReview) <= now;
          }
          return false;
        });
        
        if (this.studyQueue.length === 0) {
          document.getElementById('study-card').style.display = 'none';
          document.getElementById('no-kanji').style.display = 'block';
          document.getElementById('session-progress').textContent = '';
          return;
        }
        
        // Sort queue
        if (sort === 'random') {
          this.studyQueue.sort(() => Math.random() - 0.5);
        } else if (sort === 'level') {
          this.studyQueue.sort((a, b) => this.kanjiData[a].level - this.kanjiData[b].level);
        }
        // For frequency, we'll keep the original order (which is roughly by frequency)
        
        // Apply study limit
        const limit = parseInt(limitValue);
        if (!isNaN(limit) && limit > 0) {
          this.studyQueue = this.studyQueue.slice(0, limit);
        }
        
        document.getElementById('study-card').style.display = 'flex';
        document.getElementById('no-kanji').style.display = 'none';
        
        this.currentIndex = 0;
        
        // Clear any old answer data before showing new card
        document.getElementById('kanji-info').classList.remove('visible');
        document.getElementById('rating-buttons').classList.remove('visible');
        document.getElementById('show-answer-btn').style.display = 'block';
        document.getElementById('kanji-reading').innerHTML = '';
        document.getElementById('kanji-meaning').textContent = '';
        document.getElementById('kanji-examples').innerHTML = '';
        
        // Update progress counter
        this.updateProgressCounter();
        
        this.showCard();
      },
      
      async preFetchNextCard() {
        // Pre-fetch data for the next card in background
        const nextIndex = this.currentIndex + 1;
        if (nextIndex >= this.studyQueue.length) {
          // No next card to pre-fetch
          this.nextKanjiData = null;
          return;
        }
        
        const nextKanji = this.studyQueue[nextIndex];
        console.log('Pre-fetching data for next card:', nextKanji);
        
        try {
          // Fetch from Jiten API through CORS proxy
          const jitenUrl = `https://api.jiten.moe/api/kanji/${nextKanji}`;
          const jitenResponse = await fetch(`https://corsproxy.io/?${encodeURIComponent(jitenUrl)}`);
          const jitenData = await jitenResponse.json();
          
          this.nextKanjiData = {
            kanji: nextKanji,
            data: jitenData
          };
          console.log('Pre-fetch complete for:', nextKanji);
        } catch (error) {
          console.error('Error pre-fetching next card:', error);
          this.nextKanjiData = null;
        }
      },
      
      async showCard() {
        if (this.currentIndex >= this.studyQueue.length) {
          // Session complete - clear the saved session
          this.clearSession();
          
          // Hide the card
          document.getElementById('study-card').style.display = 'none';
          document.getElementById('no-kanji').style.display = 'block';
          document.getElementById('no-kanji').innerHTML = `<p>${this.t('sessionComplete')}</p><p style="margin-top: 1rem;">${this.t('selectFilter')}</p>`;
          document.getElementById('session-progress').textContent = '';
          return;
        }
        
        // Save session after every card move
        this.saveSession();
        
        this.currentKanji = this.studyQueue[this.currentIndex];
        
        // Update progress counter
        this.updateProgressCounter();
        
        // Show loading indicator immediately
        document.getElementById('current-kanji').textContent = '...';
        document.getElementById('current-kanji').style.display = 'block';
        document.getElementById('context-display').style.display = 'none';
        
        // Check if we have pre-fetched data for this card
        if (this.nextKanjiData && this.nextKanjiData.kanji === this.currentKanji) {
          console.log('Using pre-fetched data for:', this.currentKanji);
          this.currentKanjiFullData = this.nextKanjiData.data;
          this.nextKanjiData = null; // Clear the cache
          
          // Display kanji
          document.getElementById('current-kanji').textContent = this.currentKanji;
          document.getElementById('current-kanji').style.display = 'block';
          
          // Display optional context
          this.updateContextDisplay();
        } else {
          // No cached data, fetch it now
          console.log('Fetching data for:', this.currentKanji);
          try {
            // Fetch from Jiten API through CORS proxy
            const jitenUrl = `https://api.jiten.moe/api/kanji/${this.currentKanji}`;
            const jitenResponse = await fetch(`https://corsproxy.io/?${encodeURIComponent(jitenUrl)}`);
            console.log('Jiten response status:', jitenResponse.status);
            
            if (!jitenResponse.ok) {
              throw new Error(`Jiten API returned ${jitenResponse.status}`);
            }
            
            const jitenData = await jitenResponse.json();
            console.log('Jiten data received:', jitenData);
            this.currentKanjiFullData = jitenData;
            
            // Display kanji
            document.getElementById('current-kanji').textContent = this.currentKanji;
            document.getElementById('current-kanji').style.display = 'block';
            
            // Display optional context
            this.updateContextDisplay();
            
          } catch (error) {
            console.error('Error fetching kanji data:', error);
            this.currentKanjiFullData = null;
            document.getElementById('current-kanji').textContent = this.currentKanji;
            document.getElementById('context-display').style.display = 'none';
          }
        }
        
        // Reset UI state
        document.getElementById('kanji-info').classList.remove('visible');
        document.getElementById('rating-buttons').classList.remove('visible');
        document.getElementById('show-answer-btn').style.display = 'block';
        
        // Reset display - show kanji, hide stroke order initially
        document.getElementById('current-kanji').style.display = 'block';
        document.getElementById('stroke-order').style.display = 'none';
        document.getElementById('stroke-order').innerHTML = '';
        
        // Pre-fetch the NEXT card in background
        this.preFetchNextCard();
      },
      
      displayAnswer() {
        const data = this.currentKanjiFullData;
        
        if (!data) {
          document.getElementById('kanji-reading').textContent = '‚Äî';
          document.getElementById('kanji-meaning').textContent = this.t('dataUnavailable');
          document.getElementById('kanji-examples').innerHTML = '';
          return;
        }
        
        const showKun = document.getElementById('show-kun').checked;
        const showOn = document.getElementById('show-on').checked;
        const showMeaning = document.getElementById('show-meaning').checked;
        const showExamples = document.getElementById('show-examples').checked;
        const showStrokeOrder = document.getElementById('show-stroke-order').checked;
        
        // Toggle between kanji display and stroke order
        if (showStrokeOrder) {
          document.getElementById('current-kanji').style.display = 'none';
          document.getElementById('stroke-order').style.display = 'block';
          this.loadStrokeOrder();
        } else {
          document.getElementById('current-kanji').style.display = 'block';
          document.getElementById('current-kanji').textContent = this.currentKanji;
          document.getElementById('stroke-order').style.display = 'none';
        }
        
        // Context is independent - update it regardless of kanji vs stroke order
        this.updateContextDisplay();
        
        let readingHTML = '';
        
        // Show ALL kun readings if checked
        // Jiten API uses kunReadings (camelCase, not snake_case)
        if (showKun && data.kunReadings && data.kunReadings.length > 0) {
          readingHTML += `<div style="margin-bottom: 15px;">
            <strong>Ë®ìË™≠„Åø:</strong> ${data.kunReadings.join(', ')}
          </div>`;
        }
        
        // Show ALL on readings if checked
        // Jiten API uses onReadings (camelCase, not snake_case)
        if (showOn && data.onReadings && data.onReadings.length > 0) {
          readingHTML += `<div style="margin-bottom: 15px;">
            <strong>Èü≥Ë™≠„Åø:</strong> ${data.onReadings.join(', ')}
          </div>`;
        }
        
        if (readingHTML) {
          document.getElementById('kanji-reading').innerHTML = readingHTML;
          document.getElementById('kanji-reading').style.display = 'block';
        } else {
          document.getElementById('kanji-reading').style.display = 'none';
        }
        
        // Show ALL meanings if checked
        if (showMeaning) {
          if (data.meanings && data.meanings.length > 0) {
            document.getElementById('kanji-meaning').textContent = data.meanings.join(', ');
          } else {
            document.getElementById('kanji-meaning').textContent = '‚Äî';
          }
          document.getElementById('kanji-meaning').style.display = 'block';
        } else {
          document.getElementById('kanji-meaning').style.display = 'none';
        }
        
        // Show examples if checked
        if (showExamples) {
          const examplesHTML = this.getExamples(data);
          document.getElementById('kanji-examples').innerHTML = examplesHTML;
          document.getElementById('kanji-examples').style.display = 'block';
        } else {
          document.getElementById('kanji-examples').style.display = 'none';
        }
      },
      
      async loadStrokeOrder() {
        const kanji = this.currentKanji;
        const unicode = kanji.codePointAt(0).toString(16).padStart(5, '0');
        const svgUrl = `https://raw.githubusercontent.com/KanjiVG/kanjivg/master/kanji/${unicode}.svg`;
        
        try {
          const response = await fetch(svgUrl);
          const svgText = await response.text();
          
          // Parse SVG properly to avoid XML artifacts
          const parser = new DOMParser();
          const svgDoc = parser.parseFromString(svgText, 'image/svg+xml');
          const svg = svgDoc.querySelector('svg');
          
          if (!svg) {
            throw new Error('Invalid SVG');
          }
          
          // Clean up the container and add the SVG
          const container = document.getElementById('stroke-order');
          container.innerHTML = '';
          container.appendChild(svg.cloneNode(true));
          
          // Get the imported SVG element
          const importedSvg = container.querySelector('svg');
          
          // Remove all metadata groups (kvg:element, text elements, etc.)
          importedSvg.querySelectorAll('g[id^="kvg:StrokeNumbers"]').forEach(el => el.remove());
          importedSvg.querySelectorAll('text').forEach(el => el.remove());
          
          // Get only the stroke paths (not the character outline)
          const paths = importedSvg.querySelectorAll('path[id^="kvg:"]');
          paths.forEach((path, index) => {
            // Style the strokes
            path.style.fill = 'none';
            path.style.stroke = 'black';
            path.style.strokeWidth = '3';
            path.style.strokeLinecap = 'round';
            path.style.strokeLinejoin = 'round';
            
            // Animate
            const length = path.getTotalLength();
            path.style.strokeDasharray = length;
            path.style.strokeDashoffset = length;
            path.style.animation = `drawStroke 0.5s ease-out ${index * 0.3}s forwards`;
          });
          
          // Add CSS animation if not already added
          if (!document.getElementById('stroke-animation-style')) {
            const style = document.createElement('style');
            style.id = 'stroke-animation-style';
            style.textContent = `
              @keyframes drawStroke {
                to {
                  stroke-dashoffset: 0;
                }
              }
            `;
            document.head.appendChild(style);
          }
        } catch (error) {
          console.error('Error loading stroke order:', error);
          document.getElementById('stroke-order').innerHTML = `<p style="color: #999;">${this.t('strokeNotAvailable')}</p>`;
        }
      },
      
      getBestRepresentativeWord(kanji, data) {
        console.log('getBestRepresentativeWord called for:', kanji);
        
        if (!data || !data.topWords || data.topWords.length === 0) {
          console.log('No words available, returning empty array');
          return [];
        }
        
        // Jiten API returns topWords in frequency order, so just take the first 3
        const examples = [];
        
        for (let i = 0; i < Math.min(3, data.topWords.length); i++) {
          const word = data.topWords[i];
          // Use the reading field which has the kanji+kana form
          if (word.reading) {
            examples.push(word.reading);
          }
        }
        
        console.log('Top 3 frequent words:', examples);
        return examples;
      },
      
      parseFurigana(furiganaText) {
        // Parse Jiten's furigana format: "Ëµ§[„ÅÇ„Åã]„ÅÑ" -> "<ruby>Ëµ§<rt>„ÅÇ„Åã</rt></ruby>„ÅÑ"
        if (!furiganaText) return '';
        
        return furiganaText.replace(/([^[]+)\[([^\]]+)\]/g, '<ruby>$1<rt>$2</rt></ruby>');
      },
      
      getExamples(data) {
        if (!data.topWords || data.topWords.length === 0) {
          return `<p>${this.t('noExamples')}</p>`;
        }
        
        // Get first 5 examples from Jiten API topWords
        const examples = data.topWords.slice(0, 5);
        let html = '';
        
        examples.forEach(word => {
          // Jiten kanji endpoint structure: { reading, readingFurigana, mainDefinition }
          // Use readingFurigana for furigana display
          const withFurigana = this.parseFurigana(word.readingFurigana || word.reading);
          html += `
            <div class="example-item">
              <div class="example-ja">${withFurigana}</div>
              <div class="example-en">${word.mainDefinition || ''}</div>
            </div>
          `;
        });
        
        return html;
      },
      
      showAnswer() {
        this.displayAnswer();
        document.getElementById('kanji-info').classList.add('visible');
        document.getElementById('rating-buttons').classList.add('visible');
        document.getElementById('show-answer-btn').style.display = 'none';
      },
      
      updateContextDisplay() {
        // Update the displayed context without affecting kanji/stroke order display
        if (!this.currentKanji || !this.currentKanjiFullData) {
          return; // No card loaded yet
        }
        
        const showInContext = document.getElementById('show-in-context').checked;
        const contextDisplay = document.getElementById('context-display');
        
        if (showInContext) {
          // Show context words
          const contextWords = this.getBestRepresentativeWord(this.currentKanji, this.currentKanjiFullData);
          // Only show if we have context words
          if (contextWords.length > 0) {
            contextDisplay.textContent = contextWords.join('„Éª'); // Japanese middle dot separator
            contextDisplay.style.display = 'block';
          } else {
            contextDisplay.style.display = 'none';
          }
        } else {
          // Hide context
          contextDisplay.style.display = 'none';
        }
      },
      
      updateDisplay() {
        // Only update if answer is already shown
        if (document.getElementById('kanji-info').classList.contains('visible')) {
          this.displayAnswer();
        }
      },
      
      rateCard(rating) {
        // Update kanji data
        const data = this.kanjiData[this.currentKanji];
        data.level = rating;
        data.lastReview = new Date().toISOString();
        data.reviewCount++;
        
        // Calculate next review (simple SRS)
        const intervals = [1, 3, 7, 14, 30]; // days
        const interval = intervals[rating] || 1;
        const nextReview = new Date();
        nextReview.setDate(nextReview.getDate() + interval);
        data.nextReview = nextReview.toISOString();
        
        this.saveData();
        this.renderGrid();
        this.updateStats();
        
        // Move to next card
        this.currentIndex++;
        this.showCard();
      },
      
      previousCard() {
        if (this.currentIndex > 0) {
          this.currentIndex--;
          this.showCard();
        }
      },
      
      nextCard() {
        if (this.currentIndex < this.studyQueue.length - 1) {
          this.currentIndex++;
          this.showCard();
        }
      },
      
      skipCard() {
        // Skip without rating
        this.currentIndex++;
        this.showCard();
      }
    };

    // Initialize app
    app.init();
  </script>
</body>
</html>
