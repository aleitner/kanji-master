<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¼¢å­—ãƒã‚¹ã‚¿ãƒ¼ - Kanji Master</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: sans-serif;
      background: white;
      color: black;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 20px 20px 15px 20px;
      border-bottom: 2px solid black;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .data-controls {
      display: flex;
      gap: 10px;
    }
    
    .data-btn {
      padding: 6px 12px;
      background: black;
      color: white;
      border: 1px solid black;
      cursor: pointer;
      font-size: 14px;
    }
    
    .data-btn:hover {
      background: #333;
    }
    
    #import-file {
      display: none;
    }
    
    h1 {
      font-size: 24px;
    }
    
    .nav-tabs {
      display: flex;
      gap: 10px;
    }
    
    .tab-btn {
      padding: 8px 16px;
      background: white;
      border: 1px solid black;
      cursor: pointer;
    }
    
    .tab-btn.active {
      background: black;
      color: white;
    }
    
    .page {
      display: none;
      padding: 20px;
    }
    
    .page.active {
      display: block;
    }
    
    .legend {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      padding: 10px;
      border: 1px solid black;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 14px;
    }
    
    .legend-color {
      width: 20px;
      height: 20px;
      border: 1px solid black;
    }
    
    .kanji-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(28px, 1fr));
      gap: 2px;
      border: 1px solid black;
      padding: 10px;
      max-height: 600px;
      overflow-y: auto;
    }
    
    .kanji-cell {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      cursor: pointer;
      border: 1px solid #ccc;
    }
    
    .kanji-cell:hover {
      border: 2px solid black;
    }
    
    .kanji-cell.unknown { background: black; color: black; }
    .kanji-cell.learning { background: #555; color: black; }
    .kanji-cell.familiar { background: #888; color: black; }
    .kanji-cell.known { background: #bbb; color: black; }
    .kanji-cell.mastered { background: white; color: black; border: 1px solid #ccc; }
    
    /* Legend colors to match grid cells */
    .legend-color.unknown { background: black; }
    .legend-color.learning { background: #555; }
    .legend-color.familiar { background: #888; }
    .legend-color.known { background: #bbb; }
    .legend-color.mastered { background: white; border: 1px solid #ccc; }
    
    .study-controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
      padding: 20px;
      background: transparent;
    }
    
    .control-group {
      min-width: 200px;
    }
    
    .control-group label {
      display: block;
      font-size: 14px;
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    select, button {
      width: 100%;
      padding: 8px;
      border: 1px solid black;
      background: white;
      color: black;
      cursor: pointer;
    }
    
    button {
      background: black;
      color: white;
    }
    
    button:hover {
      background: #333;
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .study-card {
      border: 2px solid black;
      padding: 40px 20px;
      text-align: center;
      margin-bottom: 20px;
      min-height: 400px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    
    .kanji-display {
      font-size: 120px;
      margin-bottom: 20px;
    }
    
    .context-display {
      font-size: 32px;
      color: #666;
      margin-top: -10px;
      margin-bottom: 20px;
    }
    
    .kanji-info {
      display: none;
    }
    
    .kanji-info.visible {
      display: block;
    }
    
    .stroke-order {
      font-size: 120px;
      margin-bottom: 20px;
      min-height: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .stroke-order svg {
      width: 200px;
      height: 200px;
      display: block;
    }
    
    .reading {
      font-size: 24px;
      margin-bottom: 10px;
    }
    
    .meaning {
      font-size: 18px;
      margin-bottom: 20px;
    }
    
    .examples {
      text-align: left;
      max-width: 600px;
      margin: 0 auto;
    }
    
    .example-item {
      margin-bottom: 15px;
      padding: 10px;
      border-left: 2px solid black;
    }
    
    .example-ja {
      font-size: 16px;
      margin-bottom: 5px;
    }
    
    .example-en {
      font-size: 14px;
      color: #666;
    }
    
    .show-answer-btn {
      max-width: 300px;
    }
    
    .rating-buttons {
      display: none;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 20px;
      width: 100%;
      max-width: 600px;
    }
    
    .rating-buttons.visible {
      display: grid;
    }
    
    .rating-btn {
      padding: 10px;
      border: 2px solid black;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      border: 1px solid black;
      padding: 15px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: bold;
      display: block;
    }
    
    .stat-label {
      font-size: 12px;
      margin-top: 5px;
    }
    
    .no-kanji {
      text-align: center;
      padding: 40px 20px;
    }
    
    .drop-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      pointer-events: none;
    }
    
    .drop-overlay.active {
      display: flex;
    }
    
    .drop-message {
      color: white;
      font-size: 32px;
      font-weight: bold;
      text-align: center;
      padding: 40px;
      border: 4px dashed white;
      border-radius: 10px;
    }
    
    /* Dark mode styles - invert all colors */
    body.dark-mode {
      background: #1a1a1a;
      color: #e0e0e0;
    }
    
    body.dark-mode .container {
      background: #2a2a2a;
      border-color: #404040;
    }
    
    body.dark-mode .header {
      background: linear-gradient(135deg, #333 0%, #1a1a1a 100%);
      border-bottom-color: #404040;
    }
    
    body.dark-mode .tabs {
      background: #333;
      border-color: #404040;
    }
    
    body.dark-mode .tab-btn {
      background: #2a2a2a;
      color: #e0e0e0;
      border-color: #404040;
    }
    
    body.dark-mode .tab-btn.active {
      background: #1a1a1a;
      color: #4a9eff;
      border-bottom-color: #1a1a1a;
    }
    
    body.dark-mode .kanji-grid {
      background: #2a2a2a;
    }
    
    body.dark-mode .kanji-cell {
      background: #1a1a1a;
      color: #000;
      border-color: #404040;
    }
    
    body.dark-mode .kanji-cell:hover {
      border-color: #777;
    }
    
    /* Dark mode: All kanji text is black - visibility increases as backgrounds lighten */
    body.dark-mode .kanji-cell.unknown { background: black; color: black; }
    body.dark-mode .kanji-cell.learning { background: #555; color: black; }
    body.dark-mode .kanji-cell.familiar { background: #888; color: black; }
    body.dark-mode .kanji-cell.known { background: #bbb; color: black; }
    body.dark-mode .kanji-cell.mastered { background: white; color: black; border: 1px solid #444; }
    
    /* Dark mode: All text is black */
    body.dark-mode .level-0 { background: black; color: black; }
    body.dark-mode .level-1 { background: #555; color: black; }
    body.dark-mode .level-2 { background: #888; color: black; }
    body.dark-mode .level-3 { background: #bbb; color: black; }
    body.dark-mode .level-review { background: #4a5a6a; color: black; }
    
    body.dark-mode .study-page {
      background: #2a2a2a;
    }
    
    body.dark-mode .study-card {
      background: #333;
      border-color: #404040;
    }
    
    body.dark-mode .context-display {
      color: #999;
    }
    
    body.dark-mode .show-answer-btn {
      background: #4a9eff;
      color: white;
    }
    
    body.dark-mode .show-answer-btn:hover {
      background: #3a8eef;
    }
    
    body.dark-mode .kanji-info {
      background: #333;
      border-color: #404040;
    }
    
    body.dark-mode .rating-buttons button {
      background: #404040;
      color: #e0e0e0;
      border-color: #555;
    }
    
    body.dark-mode .rating-buttons button:hover {
      background: #4a4a4a;
    }
    
    body.dark-mode .rating-buttons .level-0 { background: #555; }
    body.dark-mode .rating-buttons .level-1 { background: #8b4545; }
    body.dark-mode .rating-buttons .level-2 { background: #8b8b45; }
    body.dark-mode .rating-buttons .level-3 { background: #458b45; }
    
    body.dark-mode .example-item {
      border-color: #404040;
    }
    
    body.dark-mode select, body.dark-mode input[type="file"] {
      background: #333;
      color: #e0e0e0;
      border-color: #555;
    }
    
    body.dark-mode button {
      background: #404040;
      color: #e0e0e0;
      border-color: #555;
    }
    
    body.dark-mode button:hover {
      background: #4a4a4a;
    }
    
    body.dark-mode .legend {
      background: #333;
      border-color: #404040;
    }
    
    body.dark-mode .legend-item {
      border-color: #404040;
    }
    
    body.dark-mode #no-kanji {
      color: #999;
    }
    
    body.dark-mode .language-toggle {
      background: #404040;
      color: #e0e0e0;
    }
    
    body.dark-mode .language-toggle:hover {
      background: #4a4a4a;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1></h1>
      <div class="nav-tabs">
        <button class="tab-btn active" data-page="grid"></button>
        <button class="tab-btn" data-page="study"></button>
      </div>
      <div class="data-controls">
        <button class="data-btn" id="language-btn"></button>
        <button class="data-btn" id="dark-mode-btn" onclick="app.toggleDarkMode()">ğŸŒ™</button>
        <button class="data-btn" id="export-btn"></button>
        <button class="data-btn" id="import-btn"></button>
        <input type="file" id="import-file" accept=".json">
      </div>
    </header>
    
    <!-- Grid Page -->
    <div id="grid-page" class="page active">
      <div class="legend">
        <div class="legend-item">
          <div class="legend-color" style="background: black"></div>
          <span></span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #555"></div>
          <span></span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #888"></div>
          <span></span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #bbb"></div>
          <span></span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: white"></div>
          <span></span>
        </div>
      </div>
      
      <div class="stats">
        <div class="stat-card">
          <span class="stat-value" id="total-kanji">0</span>
          <span class="stat-label" id="stat-total"></span>
        </div>
        <div class="stat-card">
          <span class="stat-value" id="mastered-count">0</span>
          <span class="stat-label" id="stat-mastered"></span>
        </div>
        <div class="stat-card">
          <span class="stat-value" id="learning-count">0</span>
          <span class="stat-label" id="stat-progress"></span>
        </div>
        <div class="stat-card">
          <span class="stat-value" id="unknown-count">0</span>
          <span class="stat-label" id="stat-unknown"></span>
        </div>
      </div>
      
      <div class="kanji-grid" id="kanji-grid"></div>
    </div>
    
    <!-- Study Page -->
    <div id="study-page" class="page">
      <div class="study-controls">
        <div class="control-group">
          <label id="label-filter"></label>
          <select id="level-filter" onchange="app.startStudy()">
            <option value="all" id="filter-all"></option>
            <option value="unknown" id="filter-unknown"></option>
            <option value="learning" id="filter-learning"></option>
            <option value="familiar" id="filter-familiar"></option>
            <option value="known" id="filter-known"></option>
            <option value="review" id="filter-review"></option>
          </select>
        </div>
        <div class="control-group">
          <label id="label-sort"></label>
          <select id="sort-option" onchange="app.startStudy()">
            <option value="random" id="sort-random"></option>
            <option value="frequency" id="sort-frequency"></option>
            <option value="level" id="sort-level"></option>
          </select>
        </div>
      </div>
      
      <div class="study-card" id="study-card">
        <div class="study-options" style="margin-bottom: 20px;">
          <label style="margin-right: 15px; cursor: pointer;" id="label-kun">
            <input type="checkbox" id="show-kun" checked onchange="app.saveTogglePreferences(); app.updateDisplay()">
          </label>
          <label style="margin-right: 15px; cursor: pointer;" id="label-on">
            <input type="checkbox" id="show-on" checked onchange="app.saveTogglePreferences(); app.updateDisplay()">
          </label>
          <label style="margin-right: 15px; cursor: pointer;" id="label-meaning">
            <input type="checkbox" id="show-meaning" checked onchange="app.saveTogglePreferences(); app.updateDisplay()">
          </label>
          <label style="margin-right: 15px; cursor: pointer;" id="label-examples">
            <input type="checkbox" id="show-examples" onchange="app.saveTogglePreferences(); app.updateDisplay()">
          </label>
          <label style="margin-right: 15px; cursor: pointer;" id="label-stroke">
            <input type="checkbox" id="show-stroke-order" onchange="app.saveTogglePreferences(); app.updateDisplay()">
          </label>
          <label style="cursor: pointer;" id="label-context">
            <input type="checkbox" id="show-in-context" onchange="app.saveTogglePreferences(); app.updateContextDisplay()">
          </label>
        </div>
        
        <div class="kanji-display" id="current-kanji"></div>
        <div class="stroke-order" id="stroke-order" style="display: none;"></div>
        <div class="context-display" id="context-display" style="display: none;"></div>
        
        <button class="show-answer-btn" id="show-answer-btn" onclick="app.showAnswer()">
        </button>
        
        <div class="kanji-info" id="kanji-info">
          <div class="reading" id="kanji-reading"></div>
          <div class="meaning" id="kanji-meaning"></div>
          <div class="examples" id="kanji-examples"></div>
        </div>
        
        <div class="rating-buttons" id="rating-buttons">
          <button class="rating-btn" data-rating="0" onclick="app.rateCard(0)">
            <span id="rating-again"></span><br><small id="rating-learning"></small>
          </button>
          <button class="rating-btn" data-rating="1" onclick="app.rateCard(1)">
            <span id="rating-hard"></span><br><small id="rating-familiar"></small>
          </button>
          <button class="rating-btn" data-rating="2" onclick="app.rateCard(2)">
            <span id="rating-good"></span><br><small id="rating-known"></small>
          </button>
          <button class="rating-btn" data-rating="3" onclick="app.rateCard(3)">
            <span id="rating-easy"></span><br><small id="rating-mastered"></small>
          </button>
        </div>
      </div>
      
      <div class="no-kanji" id="no-kanji" style="display: none;">
        <p id="no-kanji-msg"></p>
        <p style="margin-top: 1rem;" id="no-kanji-hint"></p>
      </div>
    </div>
  </div>
  
  <div class="drop-overlay" id="drop-overlay">
    <div class="drop-message">
    </div>
  </div>

  <script>
    const KANJI_LIST = `ä¸€äºŒä»ä¸‰å››äº”ä¼å…­ä¸ƒå…«ä¹åç™¾åƒä¸‡è¬å„„æ†¶å…†çœºéŠšæŒ‘è·³é›¶ä»¤å†·éˆ´ç²é½¢æ­¯è£å¹´çˆ¶é‡œæ¯å­å­œå­¤å­«çˆªå­”äº†å…„æ³å¼Ÿç¬¬å¼”å§‰å¸‚å¦¹é»’ç´«æ­¤æŸ´é›Œç´ºç”˜é’æ™´æ¸…è«‹ç²¾æƒ…é–é™èµ¤è·¡ç·‘éŒ²ç¦„é»„æ¨ªç™½æ³ŠæŸä¼¯æ‹è¿«èˆ¶ç²•å£å“å™¨å¸åŠæ‰±ç´šå–«å¹ç‚Šå™´å¢³æ†¤åå‘³æœªå˜†å–æ¸‡å‘ªå”†å˜±å±å‘¼å”„åŸä»Šç´é³´å”±æ˜Œæ™¶å«èµ³å–šæ›å”¯ç¶­å’²å“¨å·å‘‰å¨¯èª¤å¦èˆŒåå”‡è¾°å¨ æŒ¯éœ‡å“²å•“å›½å›³åœ’é å›£åœå·»åˆ¸æ‹³å›å›²äº•è€•ä¸¼å›ºå€‹å›°å›šæ—¥æ—§æ—­æ›œæ˜¨é…¢ä½œè©æ˜ è‹±å¤®æš—é—‡æšå°­æ›™ç½²æš‘è«¸æš–æ˜‡å‡å¼æ™¯äº¬å½±æ˜“æ˜¯æ›¸éŸ³éŸ¿éƒ·é¦™æ™‹æ›¿æš«æ–¬ç”°ç”·èƒƒç•°ç´¯å¡ç•³æ€ç•™ç”»ç”ºä¸é ‚è¨‚åºç•¥é…ªçµ¡è½ç•”åŠä¼´åˆ¤å‘ç¢‘é¬¼é­”é†œå¡Šé­‚é­é­…é­æ›²å…¸è±Šç›®çœ¼é™ç³ç«¥ç¬ç¡å‚çœ æ°‘ç¦çœŒè‡ªé¼»è²·ç½ªç½°ç¾…ç½·è¦‡è¦†è…¹è¤‡å¾©çœå°‘ç‚’å°çœ‹ç£è²è´ˆæ›½åƒ§å±¤å¢—æ†è²¡æ‰æè³­æ•—è³ åŸ¹å€é™ªè²©åæ¿å‚é£¯é˜ªç‰ˆç‰‡è²¯è³„è³Šè³¼æºæ§‹è¬›è²§è²»è²´è²¨åŒ–èŠ±é´é©è³ƒè²¸ä»£è¢‹è³€åŠ æ¶å˜‰è²¿è³›è³ªè³¢å …å“¡é¡Œé¡˜é ‘é¡”å½¦é¡é¡é ˆé »æ­©é †é äºˆé‡é ­è±†é€—é¡•é¡§é›‡æœˆå‹è„šå´èƒ´è…°è¦è…•èƒå°æ€ è†³å–„è†¨è„‚æ—¨æŒ‡èƒ¸è‡“è”µè…¸é¨°èƒåŒ…æ³¡æŠ±ç ²é£½è‚¥è±šè‚å¹²æ±—å¹¹åˆŠèƒ†æ‹…è„‡è„…å”è‚ºè„³æ‚©è„ˆè†œæœè„±è‚Œæœºé£¢èƒŒè‚¯éª¨è…ç«ç¯ç½ç‡ƒç„¶ç„¼ç‚‰ç‡¥æ“è—»ç¹°ç…©çˆ†æš´ç…™ç•‘ç• æ°´æ°·æ¹¯æµ©æ²ˆæ•æ´‹ç¾Šæ´²å·é…¬æµ·æ‚”æ¯æ²–ä¸­ä»²å¿ ç˜æ³¢ç ´æµç‰ç¡«ç€¬é ¼æ¸¦ç¦é‹éæ´ªæ¹¾æµ¦è£œæ•è¼”è’²èˆ—æµœå…µæ½Ÿè‡¼èˆˆæ¸¯æ¹–èƒ¡æ²¢æŠæ³¥æ± åœ°ä¹Ÿæ·€æ²³å¯ä½•è·å·æ»ç«œé¾æ¸“é¶æµ®æ¼æ³Œç§˜å¿…æ»´æ‘˜é©æ•µæ²¡æ½œæµ¸ä¾µå¯æ·±æ±šæ¿¯æ´—å…ˆæº¶å®¹æµ´æ¬²æ¼±æ¶¼æµ„æ·³æ½¤æ»‘æ¼¬æ¸©æ²¸æ¹§å‹‡æ²¹ç”±æ±½æ°—æ±æ»‹æ…ˆç£æ²»æ¸‹æ¹¿æ¶™æˆ»æ³£é…’æ½”æ±ºæ¼”æ·‘å”æ¶²æ··æ˜†æ¿ƒè¾²æº€ä¸¡å††æ¼ æ¿æ¿€æ´»æ‹¬ä¹±è¾å¹¸å ±æ¸¬å‰‡å´æ´¥æ¼¢æ±å‡¡å¸†æ¸¡åº¦æº–æ»å¸¯æ¸ˆæ–‰å‰¤æ·»æ´¾æ¼«æ…¢æ»…æ³•å»æ¼‚ç¥¨æ¨™æµ…éŠ­è·µæ¼¸æ¸•æ·µæºåŸæ¸›æ¶¯æ¶ˆè‚–æ¸‰æ¾„ç™»æ³¨æŸ±é§æ¼†æ²™ç ‚æ·¡è«‡ç‚æ³³æ°¸è© å‡å‡†é…¸é…·å‘Šé…µå­æ•™è€é†¸å£Œå¬¢è­²é…é…”ç²‹æœ¨æ—æ£®æ¨‹æ¤œé¨“å‰£é™ºæ¡ƒé€ƒæ¾è¨Ÿå…¬æ¦æ¨ºè¯æ¤¿æ‰æ¡œæ¡§æªœæ¤æ¥¢æ§™çœŸæ…æŸ¿æ¢¨æ¡‚åœ­æ¥ æ ¹ç—•æ©˜æ¡‘æ ƒæ —æ¦Šæ¢…ææŸ³æ¥Šæšé™½æ§»è¦æ¨¹ææ¢æ æ¢æ£šæœ‹å´©æœæ§½æ›¹é­æ¨½æ©‹å–¬åƒ‘çŸ¯æ¬„è˜­æ‘æ ¸æ ¼å„é–£å®¢æ¢°æˆ’æ¦‚æ…¨æ£‹æœŸå…¶ç®•æ——æ¬ºæ¯ä¸æšæ©Ÿå¹¾ç£¯ç•¿æ¯å¤å§‘æ•…æ ¡äº¤è¼ƒçµåŠ¹éƒŠæœ½æ¥µæ¨©æ¤æ®–æ§˜æ£’å¥‰ä¿¸æ¡Ÿæœ­æŸ„ç—…æ¨¡æœ´æ¡æŸ”é›†æŸ“æŸ»ææ”¯ç¤¾ç¥ˆç¥–ç‹™çµ„ç²—ç§Ÿé˜»ç¥ç”³ä¼¸ç´³ç¦…æˆ¦ç¥ç¤¼ç¦å‰¯å¹…ç¥¥è©³ç¥å³ç¥‰æ­¢è¦–åˆè¢«çš®å½¼æŠ«ç–²è£•è¥Ÿç¦è¢–è£¸é‡‘éŠ€éŠ…åŒæ´æ¡ç­’éŒ«é‰„è¿­é‹¼ç¶±å²¡å‰›é‰›æ²¿é¡å¢ƒéŒ¦éŠƒå……é–é‡§éŒé‡é‹­éˆå±¯é‹³å¯¿éŒ å®šéµå»ºå¥é‰¢æœ¬å½“é›æ®µé˜éŠ˜åé‘‘ç›£è‰¦é‡£é®åœŸå£²å£°å–œå¡¾ç†Ÿå£ç™–å‹åˆ‘å½¢ç“¶ç“¦å¢¨å¡—å¢œå •æœ‰å£å¡€å±ä½µå£‡å¡šå¡”æ­ç­”åŸæˆèª ç››å‘æŠ—èˆªå €å±ˆæ˜å ¤æå °åŸ¼å¥‡å¯„é¨å´å ºç•Œå ´åŸŸå£Šæ‡å ªå‹˜ç”šå‡åŸ‹å¡©ç†é‡Œç¾çç æœ±æ ªæ®Šç‘ç­ç’°é‚„çƒæ±‚æ•‘ç¢ç‹çš‡æœ›è–ç‰ç´ æ¯’å¥æ³°éº¦éº¹ç§¦ç€ç¾é¤Šå§œå¸³é•·å¼µå¹Œæ™ƒå…‰å¸½å†’äººå‚¾é ƒä½³ä½¿å²å€Ÿæ˜”éŒ¯æƒœåƒå‹•ä¼‘å‚ä»»å¦Šèä¼è»¢å‚¬ä¿¡ä»æ‰•ä¿®å€«è¼ªä¼ä½å„ªæ†‚å‚‘ä¿Šé§¿å³»ä½“ä¿£å‚·åƒè±¡å‚µä½å·¦å·®ä¿—è°·ä¿ºå¥„åƒ•æ’²æ¥­ä¾¡ä¿‚ç³»ä»¶å€™ä¾›å…±ä»–ä½æŠµåº•é‚¸åµè²ç¦å€’åˆ°ä¿³æ’è¼©ä¿µè¡¨å‚™ä¾¿å½ç‚ºå€¤ç½®ç›´ä¾è¡£ä¼Šå€­å§”ä»°å¶é‡éš…ä¾‹ä¼¼ä»¥åéç·¨ç¯‡ä»®ä½å€¶å…·å„Ÿè³åœäº­å‰é•ç·¯åƒšé¼å¯®ç™‚ä¾®ä»•å£«æ­åœ¨å­˜å¾Œè¡Œå¾€ä¸»å½¹ç–«è¡“å¾‹å¾ªç›¾è¡›å¾’èµ°è¶…è¶™è¶Šèµ´å¾®è¡å¾¹æ’¤å¾³å¾—å¾æ­£è¨¼ç—‡æ”¿æ•´å¾å™é™¤è¡¡å¾¡å¸è¡—å¥³å¦ƒå§«è‡£è‡¨åª›æ´å¨˜å«¡å¦™å¦–å¦‚å©¿å©¦å¥½åª’å©šå§»å› å«å®¶ç¨¼å§“ç”Ÿæ˜Ÿæ€§ç‰²ç”£å§‹å«Œå…¼è¬™å¦»è¨€èª°è¬€æŸèªå¾æ‚Ÿè©±è¨˜å·±å¿Œç´€èµ·è­°ç¾©çŠ å„€è«–è©°å‰èª¬ç¨èªŒå¿—èª²æœè“å·£è©å¸é£¼è¨“èª­è¨³èª¿å½«è¬¹å‹¤è¬è¿·è¨ˆè«¾è¨ºè©¦å¼è«®è³‡å§¿æ¬¡èª“è­¦æ•¬é©šè­·èª˜è­˜ç¹”è·è¨´èªå¿åˆƒè¨è«­æ„‰è¼¸ç™’è¬å°„èº«è¨±èª•å»¶è­œæ™®ä¸¦è¨­èª‡è¬¡æºè©•å¹³åªè©²åŠ¾è«å–è¶£è€³æ¥è´åŠ©è¯å¿ƒæ…‹èƒ½ç†Šæ¯æ©æ†©æ‹å¤‰æ€¥å¿˜ç›²å¿™äº¡æ‚£æ‚ªäºœæ„æ€’å¥´åŠªææ…°å°‰æ‚²éæ‰‰æ–æƒ³ç›¸æ¹˜ç®±æ‡¸æ‚ æ†²æ‡²å¾´æ‡‡æƒ‘æ„šæ†¾æ„Ÿæ…£è²«å¿«æ‚¼æ€–å¸ƒå¸Œæƒ§æ¨æƒ¨å‚æ’äº˜æ…Œè’æ€ªæ‰‹æ’ƒæŠ•æ¨æ‹™å‡ºæ“¬ç–‘æŠ€å²æºæ’®æœ€æƒæè‹—çŒ«æ‰¹æ¯”çµæ§æ¨èˆæ›æŒ¿æ“æªæ¡èœå½©æ²æˆå—æ‹æ‹“æŠ¼æ‹æ“¦å¯Ÿæ¾æ¡æŠœé«ªå‹æŠ¹æœ«æŒŸå³¡ç‹­æ‹¡åºƒé‰±å®ç´˜æ®å±…æ‹ å‡¦ææ‹·è€ƒæ‰“æŠ˜æŒ«åº§æŠ‘æ¥æ‘‚æ‰¶å¤«æœæ¢æ‹¾æ®è¼æ‹’å·¨è·æ‹˜è¶³ä¿ƒæ‰èºè¸Šç”¨è¸è¦‹è¦ªæ–°è¦³å‹§æ­“è¦§å…å…‹å…œç«¶é€±å‘¨è¿‘æ¬£æ–­è¾ºåˆ€é€ŸæŸç–é‹éŠé…é€†è¾¼å…¥é€šç—›é€”ä½™æ–œé·é€å·¡é£é€è¿”é€€é€ é€¸é®è¿½é‚é”é€²é¿é€®è¿…é€“è¿è¿°é€é¸å·½éºè¾»æ–¹è‚ªåŠå¦¨è¨ªæˆ¿èŠ³ç´¡é˜²æ”¾æ–¼æ—æ—…æ–½æ—‹åŒ—å—è¥¿æ±å‡æ£Ÿè»Šè»Œè»¸è»Ÿè»½å¾„èŒçµŒè»’è½„å‰²èˆŸèˆ¹è‰‡å»·åº­ä¸¹æ˜¥å¤ç§‹è©å†¬æœæ½®ä¹¾ä¹™éŸ“åˆæ˜¼æ™©å¤œé›¨é›²æ›‡é›°åˆ†ç´›ç²‰éœ§å‹™çŸ›éœæš‡éœ²è·¯é›·é›»é›ªéœŠéœ€æ„›å¦¥ç†±è’¸æ‰¿ç…®è€…ç…•ç…§æ˜­æ²¼æ‹›ç´¹å¬å‹²è–«é»™ç„¡èˆç‚¹é–€å•é–“ç°¡é–¢é–‘èé–‹é–‰é–²æ‚¦é–¥ä¼é—˜å†™ä¸å†—å† è»ç©´å­—å®—ç¤ºå¯›å®°è¾›åŸ·å¯’å¯‚å®®å‘‚å®å¯†å¯©å®Ÿçª®å®£å¯§å®³å®…è¨—å®‹å¯¡å®¤å®˜è…ç®¡é¤¨é˜œå®´è³“å¯Œå†¨å®œå®‡å¤©å®™æŠ½å®‰æ¡ˆå®Œå…ƒç¿«å¯…ä¸¸ç©¶çªçªƒåˆ‡çª’çªªçª¯çª“ç©ºå­¦è¦šæ „å–¶è›åŠ´æŒå ‚å…šå¸¸å“€è¡°å–ªè£è£‚åˆ—çƒˆè£…å£®è˜è£½åˆ¶è¤’ä¿å‘†è¥²å’ç‡è±ªäº®äº«äº¨è‚²æ£„å‘å°šæŒ™èª‰å¥®å¥ˆå¥”å¥ªå¯¸è€å¯¾å°è¾±å°Šå°é“é¦–å°‹è£è¼‰æ ½åœ§å¨ç°å„æ­´æš¦åšå˜å¸­åºŠéº»æ‘©ç£¨å»Šéƒæœ—åº«åºœä»˜ç¬¦åº—å•†åº·æ…¶åº¸é·¹è…è‚‰å»‰åº¶åºå»ƒç™ºåºµå¿œå»Ÿé¹¿éº—ç—¢åˆ©ç–¾ç—´çŸ¥æ™ºè™è™šæˆ¯è™œæ…®è†šç›§è™åŠ‡å±‹å±€å°»å°¾æ¢¶æ¯›å°¿å±Šå±•å±¥å°½å°¼æˆ¸æ‰€è‚©æ‰‡åˆå«å‘½ä¼å…¨å‚˜å¯ºæ™‚æŒä¾è©©å¾…ç‰¹ç­‰é­šæ¼é¯¨é®®è™«è›‡èšŠè¶èç‹¬ç‹¼æµªè‰¯ç‹‚çŒ›å­Ÿç‹©å®ˆçŒŸçŒªç…å¸«å¸¥ç²ç©«çŒ¶çŠ¯çŒ¿ç„é¦¬é§’å¥é§†åŒºæ¬§æ®´é§…é¨’é§„å¤ªçƒé³¥é³©éµ¬é´»é´ˆé´¨éµœé¶´é·²å°±å³¶å¶‹å¶Œç‰›ç‰Ÿä¹³ç‰©äº‹ç‰§é›„é›¢é›‘é›£é›€ç¾½ç¿’ç¿Œç¿¼ç¿”ç¿»ç•ªè—©å¹¡ç¿èŒ¨è‹‘èŠ½ç‰™é›…è‘‰èŠä¹‹ä¹è‰æ—©å“èŠ¦èŠ­å·´æŠŠç¶è•‰èŒ¶èŒèŠè‘µè—è–®è“®é€£èŠ¥ä»‹è‘›è©è»èŒ…è˜‡è±å‹Ÿæ…•è‹¥æš®å¢“å¹•è“„ç•œèŠ¸è—è‘¬æ­»è–©è–¦è–¬æ¥½å¤¢è—¤èŒ‚è–„åšç¸›å°‚ç°¿è‹«å è‹¦ç³¸ç·’è‘—ç¸¾è²¬ç©çµ±çµ¦ç·©ç´å†…ç·è¡ç´”çµ¹ç¶¿ç·šæ³‰ç¶²ç¸„çµç· å¸ç´„çš„ç¸ç¶™çµ¶è‰²çµ‚ç´™æ°ç´‹æ–‡æ–ç²›çµµä¼šç¶¾ç¹Šç´°ç¶šç¸¦å¾“ç³¾ç¸®å®¿ç·´ç´¢ç·Šç¹ç«¹ç¯‰ç­‘ç¯ ç¬¹ä¸–ç¬›ç¯¤ç­‹ç¯€å³ç¬‘ç®—ç­†è‚‡ç±ç­–ç¯„ç±³æ–™æ–—ç²’ç¬ ç«‹ç«¯ç³–å”ç²§åº„ç²˜ç³§é‡ç§ç¨šç¨”å¿µç©éš å’Œç§»ç¨‹å‘ˆç¨²ç©‚æµç§’ç§°ç§©å¤±ç§‘ç¨®é‡ç¨¿é«˜å­£ç§€ä¹ƒé‡ˆå°ºçŸ³ç¤ç¤ç„¦ç ”ç •ç¢ºç¡¬æ›´ç¢åŸºå±±ä»™å´”å²©å·Œå³æ•¢å²¸ç‚­å³ ä¸Šä¸‹å²³ä¸˜å¶½å³°å³¯é€¢ç¸«å¶ºé ˜åµé¢¨å‡§å²¬ç”²å´‡çš¿ç›†ç›¤ç£æ¬èˆ¬ç›—ç›Ÿæ˜ç›Šè¡€è¡†é£Ÿé£²é£¾é¤“æˆ‘æ—¢å¤§è‡­å°–å¥¥å¥¨å°†å¥‘çŠ¬çŒ®çŠ¶ç£åŠ›å¹¼å‹‰å…åŠ±å‹¢åŠ£å¤•å¤–æ®‹æ®‰æ—¬å¤šä¹…å·¥é …åŠŸæ”»å·§æ±Ÿç´…è™¹è²¢æ¬ æ­Œæ¬¾éš·æ•æ”¹æ•·æ•£æ•°è‡´è‡³èµ¦æ•¦è§’è§¦è§£äº‰è² å±äº€åŒ»çŸ¢çŸ­åŒ åŒ¹åŒ¿å‡¶å‡½å¹½åˆ·å‰°ä¹—å‰µå€‰å‰–åˆ¥å‰ŠåˆˆåŠ‰åˆ»åˆºå¸°æ®ºç©€æ®»æ®¿æ¯…åˆååŒéš»éš£æ¥é™£éš†é™éš›ç¥­éšŠéšé«„é™¢é™µç¨œé™¸éšçš†é™›é™°é™¶é™³éšœç« å½°éš”é™¥é‚¦é„­éƒ½éƒ¡å›ç¾¤éƒ¨éƒµé‚ªéƒé‚£éƒ­é˜¿å¼“å¼•å¼˜å¼·å¼¾å˜å¼¦ç„å¹»å¼¥å¼±å°å†åµä¸ˆäº’é¼“æ­¦é£›å†Šç¼¶å¼Šå¹£é¢å‰`.split('');

    const translations = {
      ja: {
        title: 'æ¼¢å­—ãƒã‚¹ã‚¿ãƒ¼',
        gridView: 'ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤º',
        studyMode: 'å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰',
        exportData: 'ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›',
        importData: 'ãƒ‡ãƒ¼ã‚¿å…¥åŠ›',
        unknown: 'æœªå­¦ç¿’',
        learning: 'å­¦ç¿’ä¸­',
        familiar: 'æ…£ã‚ŒãŸ',
        known: 'æ—¢çŸ¥',
        mastered: 'ç¿’å¾—æ¸ˆã¿',
        allLevels: 'å…¨ãƒ¬ãƒ™ãƒ«',
        unknownOnly: 'æœªå­¦ç¿’ã®ã¿',
        learningOnly: 'å­¦ç¿’ä¸­ã®ã¿',
        familiarOnly: 'æ…£ã‚ŒãŸã‚‚ã®ã®ã¿',
        knownOnly: 'æ—¢çŸ¥ã®ã¿',
        reviewDue: 'å¾©ç¿’å¿…è¦',
        sortBy: 'ä¸¦ã³æ›¿ãˆ',
        random: 'ãƒ©ãƒ³ãƒ€ãƒ ',
        frequency: 'é »åº¦',
        proficiency: 'ç¿’ç†Ÿåº¦',
        levelFilter: 'ãƒ¬ãƒ™ãƒ«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼',
        kunReading: 'è¨“èª­ã¿',
        onReading: 'éŸ³èª­ã¿',
        meaning: 'æ„å‘³',
        examples: 'ä¾‹æ–‡',
        strokeOrder: 'ç­†é †',
        showInContext: 'æ–‡è„ˆã§è¡¨ç¤º',
        showAnswer: 'ç­”ãˆã‚’è¦‹ã‚‹',
        total: 'åˆè¨ˆ',
        totalKanji: 'åˆè¨ˆæ¼¢å­—',
        inProgress: 'å­¦ç¿’ä¸­',
        unknownCount: 'æœªå­¦ç¿’',
        dataUnavailable: 'ãƒ‡ãƒ¼ã‚¿ãªã—',
        again: 'ã‚‚ã†ä¸€åº¦',
        hard: 'é›£ã—ã„',
        good: 'è‰¯ã„',
        easy: 'ç°¡å˜',
        noKanji: 'é¸æŠã—ãŸãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã«è©²å½“ã™ã‚‹æ¼¢å­—ãŒã‚ã‚Šã¾ã›ã‚“ã€‚',
        adjustFilters: 'ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®šã‚’èª¿æ•´ã—ã¦ãã ã•ã„ã€‚',
        sessionComplete: 'å­¦ç¿’ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†ï¼',
        selectFilter: 'æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã™ã‚‹ã«ã¯ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚',
        noExamples: 'ä¾‹æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“',
        strokeNotAvailable: 'ç­†é †ãƒ‡ãƒ¼ã‚¿ãªã—',
        importConfirm: 'ç¾åœ¨ã®é€²æ—ã‚’ç½®ãæ›ãˆã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ',
        importSuccess: 'ãƒ‡ãƒ¼ã‚¿ãŒæ­£å¸¸ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã¾ã—ãŸï¼',
        importError: 'ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ',
        invalidFile: 'ç„¡åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«: kanjiProgressãŒã‚ã‚Šã¾ã›ã‚“',
        dropJson: 'JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ã‚¤ãƒ³ãƒãƒ¼ãƒˆ',
        dropJsonOnly: 'JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„',
        clickToStudy: 'ã‚¯ãƒªãƒƒã‚¯ã—ã¦å­¦ç¿’'
      },
      en: {
        title: 'Kanji Master',
        gridView: 'Grid View',
        studyMode: 'Study Mode',
        exportData: 'Export Data',
        importData: 'Import Data',
        unknown: 'Unknown',
        learning: 'Learning',
        familiar: 'Familiar',
        known: 'Known',
        mastered: 'Mastered',
        allLevels: 'All Levels',
        unknownOnly: 'Unknown Only',
        learningOnly: 'Learning Only',
        familiarOnly: 'Familiar Only',
        knownOnly: 'Known Only',
        reviewDue: 'Review Due',
        sortBy: 'Sort By',
        random: 'Random',
        frequency: 'Frequency',
        proficiency: 'Proficiency Level',
        levelFilter: 'Level Filter',
        kunReading: 'Kunyomi',
        onReading: 'Onyomi',
        meaning: 'Meaning',
        examples: 'Examples',
        strokeOrder: 'Stroke Order',
        showInContext: 'Show in Context',
        showAnswer: 'Show Answer',
        total: 'Total',
        totalKanji: 'Total Kanji',
        inProgress: 'In Progress',
        unknownCount: 'Unknown',
        dataUnavailable: 'Data unavailable',
        again: 'Again',
        hard: 'Hard',
        good: 'Good',
        easy: 'Easy',
        noKanji: 'No kanji available for the selected filters.',
        adjustFilters: 'Try adjusting your filter settings.',
        sessionComplete: 'Study session complete!',
        selectFilter: 'Select a filter to start a new session.',
        noExamples: 'No examples available',
        strokeNotAvailable: 'Stroke order not available',
        importConfirm: 'This will replace your current progress. Continue?',
        importSuccess: 'Data imported successfully!',
        importError: 'Error importing data: ',
        invalidFile: 'Invalid data file: missing kanjiProgress',
        dropJson: 'Drop JSON file to import',
        dropJsonOnly: 'Please drop a JSON file',
        clickToStudy: 'Click to study'
      }
    };

    const app = {
      kanjiData: {},
      currentKanji: null,
      studyQueue: [],
      currentIndex: 0,
      currentKanjiFullData: null,
      nextKanjiData: null, // Cache for pre-fetched next card
      language: 'ja',
      
      init() {
        this.loadLanguage();
        this.loadDarkMode();
        this.loadData();
        this.loadTogglePreferences();
        this.setupEventListeners();
        this.renderGrid();
        this.updateStats();
        this.applyTranslations();
      },
      
      loadLanguage() {
        const saved = localStorage.getItem('language');
        if (saved) {
          this.language = saved;
        }
      },
      
      toggleLanguage() {
        this.language = this.language === 'ja' ? 'en' : 'ja';
        localStorage.setItem('language', this.language);
        document.getElementById('language-btn').textContent = this.language === 'ja' ? 'EN' : 'æ—¥æœ¬èª';
        this.applyTranslations();
        this.renderGrid(); // Re-render grid to update tooltips
      },
      
      loadDarkMode() {
        const saved = localStorage.getItem('darkMode');
        if (saved === 'true') {
          document.body.classList.add('dark-mode');
          document.getElementById('dark-mode-btn').textContent = 'â˜€ï¸';
        }
      },
      
      toggleDarkMode() {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        localStorage.setItem('darkMode', isDark);
        
        // Update icon
        document.getElementById('dark-mode-btn').textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
      },
      
      t(key) {
        return translations[this.language][key] || key;
      },
      
      applyTranslations() {
        // Header
        document.querySelector('h1').textContent = this.t('title');
        document.querySelectorAll('.tab-btn')[0].textContent = this.t('gridView');
        document.querySelectorAll('.tab-btn')[1].textContent = this.t('studyMode');
        document.getElementById('language-btn').textContent = this.language === 'ja' ? 'EN' : 'æ—¥æœ¬èª';
        document.getElementById('export-btn').textContent = this.t('exportData');
        document.getElementById('import-btn').textContent = this.t('importData');
        
        // Legend
        const legendItems = document.querySelectorAll('.legend-item span');
        legendItems[0].textContent = this.t('unknown');
        legendItems[1].textContent = this.t('learning');
        legendItems[2].textContent = this.t('familiar');
        legendItems[3].textContent = this.t('known');
        legendItems[4].textContent = this.t('mastered');
        
        // Study labels
        document.getElementById('label-filter').textContent = this.t('levelFilter');
        document.getElementById('label-sort').textContent = this.t('sortBy');
        
        // Sort options
        document.getElementById('sort-random').textContent = this.t('random');
        document.getElementById('sort-frequency').textContent = this.t('frequency');
        document.getElementById('sort-level').textContent = this.t('proficiency');
        
        // Checkbox labels - need to preserve the checkbox input
        const kunCheckbox = document.getElementById('show-kun');
        const onCheckbox = document.getElementById('show-on');
        const meaningCheckbox = document.getElementById('show-meaning');
        const examplesCheckbox = document.getElementById('show-examples');
        const strokeCheckbox = document.getElementById('show-stroke-order');
        
        document.getElementById('label-kun').innerHTML = `<input type="checkbox" id="show-kun" ${kunCheckbox.checked ? 'checked' : ''} onchange="app.saveTogglePreferences(); app.updateDisplay()"> ${this.t('kunReading')}`;
        document.getElementById('label-on').innerHTML = `<input type="checkbox" id="show-on" ${onCheckbox.checked ? 'checked' : ''} onchange="app.saveTogglePreferences(); app.updateDisplay()"> ${this.t('onReading')}`;
        document.getElementById('label-meaning').innerHTML = `<input type="checkbox" id="show-meaning" ${meaningCheckbox.checked ? 'checked' : ''} onchange="app.saveTogglePreferences(); app.updateDisplay()"> ${this.t('meaning')}`;
        document.getElementById('label-examples').innerHTML = `<input type="checkbox" id="show-examples" ${examplesCheckbox.checked ? 'checked' : ''} onchange="app.saveTogglePreferences(); app.updateDisplay()"> ${this.t('examples')}`;
        document.getElementById('label-stroke').innerHTML = `<input type="checkbox" id="show-stroke-order" ${strokeCheckbox.checked ? 'checked' : ''} onchange="app.saveTogglePreferences(); app.updateDisplay()"> ${this.t('strokeOrder')}`;
        
        const contextCheckbox = document.getElementById('show-in-context');
        document.getElementById('label-context').innerHTML = `<input type="checkbox" id="show-in-context" ${contextCheckbox.checked ? 'checked' : ''} onchange="app.saveTogglePreferences(); app.updateContextDisplay()"> ${this.t('showInContext')}`;
        
        // Show answer button
        document.getElementById('show-answer-btn').textContent = this.t('showAnswer');
        
        // Stats
        document.getElementById('stat-total').textContent = this.t('totalKanji');
        document.getElementById('stat-mastered').textContent = this.t('mastered');
        document.getElementById('stat-progress').textContent = this.t('inProgress');
        document.getElementById('stat-unknown').textContent = this.t('unknownCount');
        
        // Rating buttons
        document.getElementById('rating-again').textContent = this.t('again');
        document.getElementById('rating-hard').textContent = this.t('hard');
        document.getElementById('rating-good').textContent = this.t('good');
        document.getElementById('rating-easy').textContent = this.t('easy');
        document.getElementById('rating-learning').textContent = this.t('learning');
        document.getElementById('rating-familiar').textContent = this.t('familiar');
        document.getElementById('rating-known').textContent = this.t('known');
        document.getElementById('rating-mastered').textContent = this.t('mastered');
        
        // Update filter counts to use current language
        this.updateFilterCounts();
        
        // No kanji messages
        document.getElementById('no-kanji-msg').textContent = this.t('noKanji');
        document.getElementById('no-kanji-hint').textContent = this.t('adjustFilters');
        
        // Drop overlay
        document.querySelector('.drop-message').textContent = this.t('dropJson');
      },
      
      loadTogglePreferences() {
        const prefs = localStorage.getItem('togglePreferences');
        if (prefs) {
          const preferences = JSON.parse(prefs);
          document.getElementById('show-kun').checked = preferences.showKun ?? true;
          document.getElementById('show-on').checked = preferences.showOn ?? true;
          document.getElementById('show-meaning').checked = preferences.showMeaning ?? true;
          document.getElementById('show-examples').checked = preferences.showExamples ?? false;
          document.getElementById('show-stroke-order').checked = preferences.showStrokeOrder ?? false;
          document.getElementById('show-in-context').checked = preferences.showInContext ?? false;
        } else {
          // Set defaults
          document.getElementById('show-kun').checked = true;
          document.getElementById('show-on').checked = true;
          document.getElementById('show-meaning').checked = true;
          document.getElementById('show-examples').checked = false;
          document.getElementById('show-stroke-order').checked = false;
          document.getElementById('show-in-context').checked = false;
        }
      },
      
      saveTogglePreferences() {
        const preferences = {
          showKun: document.getElementById('show-kun').checked,
          showOn: document.getElementById('show-on').checked,
          showMeaning: document.getElementById('show-meaning').checked,
          showExamples: document.getElementById('show-examples').checked,
          showStrokeOrder: document.getElementById('show-stroke-order').checked,
          showInContext: document.getElementById('show-in-context').checked
        };
        localStorage.setItem('togglePreferences', JSON.stringify(preferences));
      },
      
      loadData() {
        const saved = localStorage.getItem('kanjiProgress');
        if (saved) {
          this.kanjiData = JSON.parse(saved);
        } else {
          // Initialize all kanji as unknown
          KANJI_LIST.forEach(kanji => {
            this.kanjiData[kanji] = {
              level: 0, // 0=unknown, 1=learning, 2=familiar, 3=known, 4=mastered
              lastReview: null,
              nextReview: null,
              reviewCount: 0
            };
          });
          this.saveData();
        }
      },
      
      saveData() {
        localStorage.setItem('kanjiProgress', JSON.stringify(this.kanjiData));
      },
      
      exportData() {
        const data = {
          kanjiProgress: this.kanjiData,
          togglePreferences: JSON.parse(localStorage.getItem('togglePreferences') || '{}'),
          exportDate: new Date().toISOString(),
          version: '1.0'
        };
        
        const json = JSON.stringify(data, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `kanji-progress-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      },
      
      importData(file) {
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = JSON.parse(e.target.result);
            
            // Validate the data structure
            if (!data.kanjiProgress) {
              alert(this.t('invalidFile'));
              return;
            }
            
            // Confirm before overwriting
            if (!confirm(this.t('importConfirm'))) {
              return;
            }
            
            // Import the data
            this.kanjiData = data.kanjiProgress;
            this.saveData();
            
            // Import preferences if they exist
            if (data.togglePreferences) {
              localStorage.setItem('togglePreferences', JSON.stringify(data.togglePreferences));
              this.loadTogglePreferences();
            }
            
            // Refresh the display
            this.renderGrid();
            this.updateStats();
            
            alert(this.t('importSuccess'));
          } catch (error) {
            alert(this.t('importError') + error.message);
          }
          
          // Reset the file input
          document.getElementById('import-file').value = '';
        };
        
        reader.readAsText(file);
      },
      
      setupEventListeners() {
        // Language button
        document.getElementById('language-btn').addEventListener('click', () => {
          this.toggleLanguage();
        });
        
        // Export/Import buttons
        document.getElementById('export-btn').addEventListener('click', () => {
          this.exportData();
        });
        
        document.getElementById('import-btn').addEventListener('click', () => {
          document.getElementById('import-file').click();
        });
        
        document.getElementById('import-file').addEventListener('change', (e) => {
          this.importData(e.target.files[0]);
        });
        
        // Drag and drop
        let dragCounter = 0;
        const overlay = document.getElementById('drop-overlay');
        
        document.addEventListener('dragenter', (e) => {
          e.preventDefault();
          dragCounter++;
          if (dragCounter === 1) {
            overlay.classList.add('active');
          }
        });
        
        document.addEventListener('dragleave', (e) => {
          e.preventDefault();
          dragCounter--;
          if (dragCounter === 0) {
            overlay.classList.remove('active');
          }
        });
        
        document.addEventListener('dragover', (e) => {
          e.preventDefault();
        });
        
        document.addEventListener('drop', (e) => {
          e.preventDefault();
          dragCounter = 0;
          overlay.classList.remove('active');
          
          const files = e.dataTransfer.files;
          if (files.length > 0) {
            const file = files[0];
            if (file.type === 'application/json' || file.name.endsWith('.json')) {
              this.importData(file);
            } else {
              alert(this.t('dropJsonOnly'));
            }
          }
        });
        
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            e.target.classList.add('active');
            const page = e.target.dataset.page;
            document.getElementById(page + '-page').classList.add('active');
            
            // Auto-start study when switching to study page
            if (page === 'study') {
              // Hide answer info IMMEDIATELY before startStudy runs
              document.getElementById('kanji-info').classList.remove('visible');
              document.getElementById('rating-buttons').classList.remove('visible');
              document.getElementById('show-answer-btn').style.display = 'block';
              
              this.startStudy();
            } else {
              // Clear study card display when leaving study mode
              document.getElementById('current-kanji').textContent = '';
              document.getElementById('context-display').textContent = '';
              document.getElementById('context-display').style.display = 'none';
            }
          });
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
          // Ignore if typing in an input field
          if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
          
          const key = e.key.toLowerCase();
          const isAnswerVisible = document.getElementById('kanji-info').classList.contains('visible');
          const isStudyMode = document.getElementById('study-page').classList.contains('active');
          
          // Only handle shortcuts in study mode
          if (!isStudyMode) return;
          
          // Space/Enter - Show Answer
          if ((key === ' ' || key === 'enter') && !isAnswerVisible) {
            e.preventDefault();
            this.showAnswer();
            return;
          }
          
          // Number keys 0-4 - Rate cards (only when answer is visible)
          if (isAnswerVisible && ['0', '1', '2', '3', '4'].includes(key)) {
            e.preventDefault();
            const rating = parseInt(key);
            this.rateCard(rating);
            return;
          }
          
          // Toggle shortcuts (work anytime in study mode)
          if (key === 'k') {
            e.preventDefault();
            document.getElementById('show-kun').click();
            return;
          }
          if (key === 'o') {
            e.preventDefault();
            document.getElementById('show-on').click();
            return;
          }
          if (key === 'm') {
            e.preventDefault();
            document.getElementById('show-meaning').click();
            return;
          }
          if (key === 'e') {
            e.preventDefault();
            document.getElementById('show-examples').click();
            return;
          }
          if (key === 's') {
            e.preventDefault();
            document.getElementById('show-stroke-order').click();
            return;
          }
          
          // Arrow keys / Backspace - Navigate cards
          if (key === 'arrowleft' || key === 'backspace') {
            e.preventDefault();
            this.previousCard();
            return;
          }
          if (key === 'arrowright') {
            e.preventDefault();
            this.nextCard();
            return;
          }
          
          // R - Restart session
          if (key === 'r') {
            e.preventDefault();
            this.startStudy();
            return;
          }
          
          // Escape - Skip card
          if (key === 'escape') {
            e.preventDefault();
            this.skipCard();
            return;
          }
        });
      },
      
      renderGrid() {
        const grid = document.getElementById('kanji-grid');
        grid.innerHTML = '';
        
        KANJI_LIST.forEach(kanji => {
          const cell = document.createElement('div');
          cell.className = 'kanji-cell ' + this.getLevelClass(kanji);
          cell.textContent = kanji;
          cell.title = `${this.t('clickToStudy')}: ${kanji}`;
          cell.addEventListener('click', () => this.studySpecificKanji(kanji));
          grid.appendChild(cell);
        });
      },
      
      studySpecificKanji(kanji) {
        // Switch to study mode tab
        this.switchTab('study');
        
        // Hide answer info IMMEDIATELY
        document.getElementById('kanji-info').classList.remove('visible');
        document.getElementById('rating-buttons').classList.remove('visible');
        document.getElementById('show-answer-btn').style.display = 'block';
        document.getElementById('kanji-reading').innerHTML = '';
        document.getElementById('kanji-meaning').textContent = '';
        document.getElementById('kanji-examples').innerHTML = '';
        
        // Create a study queue with just this kanji
        this.studyQueue = [kanji];
        this.currentIndex = 0;
        
        // Show study card
        document.getElementById('study-card').style.display = 'flex';
        document.getElementById('no-kanji').style.display = 'none';
        
        // Load the card
        this.showCard();
      },
      
      switchTab(page) {
        // Update tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.classList.remove('active');
          if (btn.dataset.page === page) {
            btn.classList.add('active');
          }
        });
        
        // Update pages
        document.querySelectorAll('.page').forEach(p => {
          p.classList.remove('active');
        });
        document.getElementById(page + '-page').classList.add('active');
      },
      
      getLevelClass(kanji) {
        const level = this.kanjiData[kanji]?.level || 0;
        const classes = ['unknown', 'learning', 'familiar', 'known', 'mastered'];
        return classes[level];
      },
      
      updateStats() {
        const stats = { unknown: 0, learning: 0, familiar: 0, known: 0, mastered: 0 };
        KANJI_LIST.forEach(kanji => {
          const level = this.kanjiData[kanji]?.level || 0;
          const key = ['unknown', 'learning', 'familiar', 'known', 'mastered'][level];
          stats[key]++;
        });
        
        document.getElementById('total-kanji').textContent = KANJI_LIST.length;
        document.getElementById('mastered-count').textContent = stats.mastered;
        document.getElementById('learning-count').textContent = stats.learning + stats.familiar + stats.known;
        document.getElementById('unknown-count').textContent = stats.unknown;
        
        // Update filter counts
        this.updateFilterCounts();
      },
      
      updateFilterCounts() {
        const now = new Date();
        
        // Count cards for each filter
        const counts = {
          all: KANJI_LIST.length,
          unknown: 0,
          learning: 0,
          familiar: 0,
          known: 0,
          review: 0
        };
        
        KANJI_LIST.forEach(kanji => {
          const data = this.kanjiData[kanji] || { level: 0, lastReview: null, nextReview: null, reviewCount: 0 };
          
          if (data.level === 0) counts.unknown++;
          if (data.level === 1) counts.learning++;
          if (data.level === 2) counts.familiar++;
          if (data.level === 3) counts.known++;
          
          // Count review due
          if (data.nextReview && new Date(data.nextReview) <= now) {
            counts.review++;
          }
        });
        
        // Update option text with counts using translations
        document.getElementById('filter-all').textContent = `${this.t('allLevels')} (${counts.all})`;
        document.getElementById('filter-unknown').textContent = `${this.t('unknownOnly')} (${counts.unknown})`;
        document.getElementById('filter-learning').textContent = `${this.t('learningOnly')} (${counts.learning})`;
        document.getElementById('filter-familiar').textContent = `${this.t('familiarOnly')} (${counts.familiar})`;
        document.getElementById('filter-known').textContent = `${this.t('knownOnly')} (${counts.known})`;
        document.getElementById('filter-review').textContent = `${this.t('reviewDue')} (${counts.review})`;
      },
      
      
      async startStudy() {
        const filter = document.getElementById('level-filter').value;
        const sort = document.getElementById('sort-option').value;
        
        const now = new Date();
        
        // Build queue based on filter
        this.studyQueue = KANJI_LIST.filter(kanji => {
          const data = this.kanjiData[kanji] || { level: 0, lastReview: null, nextReview: null, reviewCount: 0 };
          
          // First check the level filter
          if (filter === 'all') return true;
          if (filter === 'unknown') return data.level === 0;
          if (filter === 'learning') return data.level === 1;
          if (filter === 'familiar') return data.level === 2;
          if (filter === 'known') return data.level === 3;
          if (filter === 'review') {
            // Only show cards that are due for review
            if (!data.nextReview) return false;
            return new Date(data.nextReview) <= now;
          }
          return false;
        });
        
        if (this.studyQueue.length === 0) {
          document.getElementById('study-card').style.display = 'none';
          document.getElementById('no-kanji').style.display = 'block';
          return;
        }
        
        document.getElementById('study-card').style.display = 'flex';
        document.getElementById('no-kanji').style.display = 'none';
        
        // Sort queue
        if (sort === 'random') {
          this.studyQueue.sort(() => Math.random() - 0.5);
        } else if (sort === 'level') {
          this.studyQueue.sort((a, b) => this.kanjiData[a].level - this.kanjiData[b].level);
        }
        // For frequency, we'll keep the original order (which is roughly by frequency)
        
        this.currentIndex = 0;
        
        // Clear any old answer data before showing new card
        document.getElementById('kanji-info').classList.remove('visible');
        document.getElementById('rating-buttons').classList.remove('visible');
        document.getElementById('show-answer-btn').style.display = 'block';
        document.getElementById('kanji-reading').innerHTML = '';
        document.getElementById('kanji-meaning').textContent = '';
        document.getElementById('kanji-examples').innerHTML = '';
        
        this.showCard();
      },
      
      async preFetchNextCard() {
        // Pre-fetch data for the next card in background
        const nextIndex = this.currentIndex + 1;
        if (nextIndex >= this.studyQueue.length) {
          // No next card to pre-fetch
          this.nextKanjiData = null;
          return;
        }
        
        const nextKanji = this.studyQueue[nextIndex];
        console.log('Pre-fetching data for next card:', nextKanji);
        
        try {
          // Fetch from Jiten API through CORS proxy
          const jitenUrl = `https://api.jiten.moe/api/kanji/${nextKanji}`;
          const jitenResponse = await fetch(`https://corsproxy.io/?${encodeURIComponent(jitenUrl)}`);
          const jitenData = await jitenResponse.json();
          
          this.nextKanjiData = {
            kanji: nextKanji,
            data: jitenData
          };
          console.log('Pre-fetch complete for:', nextKanji);
        } catch (error) {
          console.error('Error pre-fetching next card:', error);
          this.nextKanjiData = null;
        }
      },
      
      async showCard() {
        if (this.currentIndex >= this.studyQueue.length) {
          // Session complete - just hide the card
          document.getElementById('study-card').style.display = 'none';
          document.getElementById('no-kanji').style.display = 'block';
          document.getElementById('no-kanji').innerHTML = `<p>${this.t('sessionComplete')}</p><p style="margin-top: 1rem;">${this.t('selectFilter')}</p>`;
          return;
        }
        
        this.currentKanji = this.studyQueue[this.currentIndex];
        
        // Show loading indicator immediately
        document.getElementById('current-kanji').textContent = '...';
        document.getElementById('current-kanji').style.display = 'block';
        document.getElementById('context-display').style.display = 'none';
        
        // Check if we have pre-fetched data for this card
        if (this.nextKanjiData && this.nextKanjiData.kanji === this.currentKanji) {
          console.log('Using pre-fetched data for:', this.currentKanji);
          this.currentKanjiFullData = this.nextKanjiData.data;
          this.nextKanjiData = null; // Clear the cache
          
          // Display kanji
          document.getElementById('current-kanji').textContent = this.currentKanji;
          document.getElementById('current-kanji').style.display = 'block';
          
          // Display optional context
          this.updateContextDisplay();
        } else {
          // No cached data, fetch it now
          console.log('Fetching data for:', this.currentKanji);
          try {
            // Fetch from Jiten API through CORS proxy
            const jitenUrl = `https://api.jiten.moe/api/kanji/${this.currentKanji}`;
            const jitenResponse = await fetch(`https://corsproxy.io/?${encodeURIComponent(jitenUrl)}`);
            console.log('Jiten response status:', jitenResponse.status);
            
            if (!jitenResponse.ok) {
              throw new Error(`Jiten API returned ${jitenResponse.status}`);
            }
            
            const jitenData = await jitenResponse.json();
            console.log('Jiten data received:', jitenData);
            this.currentKanjiFullData = jitenData;
            
            // Display kanji
            document.getElementById('current-kanji').textContent = this.currentKanji;
            document.getElementById('current-kanji').style.display = 'block';
            
            // Display optional context
            this.updateContextDisplay();
            
          } catch (error) {
            console.error('Error fetching kanji data:', error);
            this.currentKanjiFullData = null;
            document.getElementById('current-kanji').textContent = this.currentKanji;
            document.getElementById('context-display').style.display = 'none';
          }
        }
        
        // Reset UI state
        document.getElementById('kanji-info').classList.remove('visible');
        document.getElementById('rating-buttons').classList.remove('visible');
        document.getElementById('show-answer-btn').style.display = 'block';
        
        // Reset display - show kanji, hide stroke order initially
        document.getElementById('current-kanji').style.display = 'block';
        document.getElementById('stroke-order').style.display = 'none';
        document.getElementById('stroke-order').innerHTML = '';
        
        // Pre-fetch the NEXT card in background
        this.preFetchNextCard();
      },
      
      displayAnswer() {
        const data = this.currentKanjiFullData;
        
        if (!data) {
          document.getElementById('kanji-reading').textContent = 'â€”';
          document.getElementById('kanji-meaning').textContent = this.t('dataUnavailable');
          document.getElementById('kanji-examples').innerHTML = '';
          return;
        }
        
        const showKun = document.getElementById('show-kun').checked;
        const showOn = document.getElementById('show-on').checked;
        const showMeaning = document.getElementById('show-meaning').checked;
        const showExamples = document.getElementById('show-examples').checked;
        const showStrokeOrder = document.getElementById('show-stroke-order').checked;
        
        // Toggle between kanji display and stroke order
        if (showStrokeOrder) {
          document.getElementById('current-kanji').style.display = 'none';
          document.getElementById('stroke-order').style.display = 'block';
          this.loadStrokeOrder();
        } else {
          document.getElementById('current-kanji').style.display = 'block';
          document.getElementById('current-kanji').textContent = this.currentKanji;
          document.getElementById('stroke-order').style.display = 'none';
        }
        
        // Context is independent - update it regardless of kanji vs stroke order
        this.updateContextDisplay();
        
        let readingHTML = '';
        
        // Show ALL kun readings if checked
        // Jiten API uses kunReadings (camelCase, not snake_case)
        if (showKun && data.kunReadings && data.kunReadings.length > 0) {
          readingHTML += `<div style="margin-bottom: 15px;">
            <strong>è¨“èª­ã¿:</strong> ${data.kunReadings.join(', ')}
          </div>`;
        }
        
        // Show ALL on readings if checked
        // Jiten API uses onReadings (camelCase, not snake_case)
        if (showOn && data.onReadings && data.onReadings.length > 0) {
          readingHTML += `<div style="margin-bottom: 15px;">
            <strong>éŸ³èª­ã¿:</strong> ${data.onReadings.join(', ')}
          </div>`;
        }
        
        if (readingHTML) {
          document.getElementById('kanji-reading').innerHTML = readingHTML;
          document.getElementById('kanji-reading').style.display = 'block';
        } else {
          document.getElementById('kanji-reading').style.display = 'none';
        }
        
        // Show ALL meanings if checked
        if (showMeaning) {
          if (data.meanings && data.meanings.length > 0) {
            document.getElementById('kanji-meaning').textContent = data.meanings.join(', ');
          } else {
            document.getElementById('kanji-meaning').textContent = 'â€”';
          }
          document.getElementById('kanji-meaning').style.display = 'block';
        } else {
          document.getElementById('kanji-meaning').style.display = 'none';
        }
        
        // Show examples if checked
        if (showExamples) {
          const examplesHTML = this.getExamples(data);
          document.getElementById('kanji-examples').innerHTML = examplesHTML;
          document.getElementById('kanji-examples').style.display = 'block';
        } else {
          document.getElementById('kanji-examples').style.display = 'none';
        }
      },
      
      async loadStrokeOrder() {
        const kanji = this.currentKanji;
        const unicode = kanji.codePointAt(0).toString(16).padStart(5, '0');
        const svgUrl = `https://raw.githubusercontent.com/KanjiVG/kanjivg/master/kanji/${unicode}.svg`;
        
        try {
          const response = await fetch(svgUrl);
          const svgText = await response.text();
          
          // Parse SVG properly to avoid XML artifacts
          const parser = new DOMParser();
          const svgDoc = parser.parseFromString(svgText, 'image/svg+xml');
          const svg = svgDoc.querySelector('svg');
          
          if (!svg) {
            throw new Error('Invalid SVG');
          }
          
          // Clean up the container and add the SVG
          const container = document.getElementById('stroke-order');
          container.innerHTML = '';
          container.appendChild(svg.cloneNode(true));
          
          // Get the imported SVG element
          const importedSvg = container.querySelector('svg');
          
          // Remove all metadata groups (kvg:element, text elements, etc.)
          importedSvg.querySelectorAll('g[id^="kvg:StrokeNumbers"]').forEach(el => el.remove());
          importedSvg.querySelectorAll('text').forEach(el => el.remove());
          
          // Get only the stroke paths (not the character outline)
          const paths = importedSvg.querySelectorAll('path[id^="kvg:"]');
          paths.forEach((path, index) => {
            // Style the strokes
            path.style.fill = 'none';
            path.style.stroke = 'black';
            path.style.strokeWidth = '3';
            path.style.strokeLinecap = 'round';
            path.style.strokeLinejoin = 'round';
            
            // Animate
            const length = path.getTotalLength();
            path.style.strokeDasharray = length;
            path.style.strokeDashoffset = length;
            path.style.animation = `drawStroke 0.5s ease-out ${index * 0.3}s forwards`;
          });
          
          // Add CSS animation if not already added
          if (!document.getElementById('stroke-animation-style')) {
            const style = document.createElement('style');
            style.id = 'stroke-animation-style';
            style.textContent = `
              @keyframes drawStroke {
                to {
                  stroke-dashoffset: 0;
                }
              }
            `;
            document.head.appendChild(style);
          }
        } catch (error) {
          console.error('Error loading stroke order:', error);
          document.getElementById('stroke-order').innerHTML = `<p style="color: #999;">${this.t('strokeNotAvailable')}</p>`;
        }
      },
      
      getBestRepresentativeWord(kanji, data) {
        console.log('getBestRepresentativeWord called for:', kanji);
        
        if (!data || !data.topWords || data.topWords.length === 0) {
          console.log('No words available, returning empty array');
          return [];
        }
        
        // Jiten API returns topWords in frequency order, so just take the first 3
        const examples = [];
        
        for (let i = 0; i < Math.min(3, data.topWords.length); i++) {
          const word = data.topWords[i];
          // Use the reading field which has the kanji+kana form
          if (word.reading) {
            examples.push(word.reading);
          }
        }
        
        console.log('Top 3 frequent words:', examples);
        return examples;
      },
      
      parseFurigana(furiganaText) {
        // Parse Jiten's furigana format: "èµ¤[ã‚ã‹]ã„" -> "<ruby>èµ¤<rt>ã‚ã‹</rt></ruby>ã„"
        if (!furiganaText) return '';
        
        return furiganaText.replace(/([^[]+)\[([^\]]+)\]/g, '<ruby>$1<rt>$2</rt></ruby>');
      },
      
      getExamples(data) {
        if (!data.topWords || data.topWords.length === 0) {
          return `<p>${this.t('noExamples')}</p>`;
        }
        
        // Get first 5 examples from Jiten API topWords
        const examples = data.topWords.slice(0, 5);
        let html = '';
        
        examples.forEach(word => {
          // Jiten kanji endpoint structure: { reading, readingFurigana, mainDefinition }
          // Use readingFurigana for furigana display
          const withFurigana = this.parseFurigana(word.readingFurigana || word.reading);
          html += `
            <div class="example-item">
              <div class="example-ja">${withFurigana}</div>
              <div class="example-en">${word.mainDefinition || ''}</div>
            </div>
          `;
        });
        
        return html;
      },
      
      showAnswer() {
        this.displayAnswer();
        document.getElementById('kanji-info').classList.add('visible');
        document.getElementById('rating-buttons').classList.add('visible');
        document.getElementById('show-answer-btn').style.display = 'none';
      },
      
      updateContextDisplay() {
        // Update the displayed context without affecting kanji/stroke order display
        if (!this.currentKanji || !this.currentKanjiFullData) {
          return; // No card loaded yet
        }
        
        const showInContext = document.getElementById('show-in-context').checked;
        const contextDisplay = document.getElementById('context-display');
        
        if (showInContext) {
          // Show context words
          const contextWords = this.getBestRepresentativeWord(this.currentKanji, this.currentKanjiFullData);
          // Only show if we have context words
          if (contextWords.length > 0) {
            contextDisplay.textContent = contextWords.join('ãƒ»'); // Japanese middle dot separator
            contextDisplay.style.display = 'block';
          } else {
            contextDisplay.style.display = 'none';
          }
        } else {
          // Hide context
          contextDisplay.style.display = 'none';
        }
      },
      
      updateDisplay() {
        // Only update if answer is already shown
        if (document.getElementById('kanji-info').classList.contains('visible')) {
          this.displayAnswer();
        }
      },
      
      rateCard(rating) {
        // Update kanji data
        const data = this.kanjiData[this.currentKanji];
        data.level = rating;
        data.lastReview = new Date().toISOString();
        data.reviewCount++;
        
        // Calculate next review (simple SRS)
        const intervals = [1, 3, 7, 14, 30]; // days
        const interval = intervals[rating] || 1;
        const nextReview = new Date();
        nextReview.setDate(nextReview.getDate() + interval);
        data.nextReview = nextReview.toISOString();
        
        this.saveData();
        this.renderGrid();
        this.updateStats();
        
        // Move to next card
        this.currentIndex++;
        this.showCard();
      },
      
      previousCard() {
        if (this.currentIndex > 0) {
          this.currentIndex--;
          this.showCard();
        }
      },
      
      nextCard() {
        if (this.currentIndex < this.studyQueue.length - 1) {
          this.currentIndex++;
          this.showCard();
        }
      },
      
      skipCard() {
        // Skip without rating
        this.currentIndex++;
        this.showCard();
      }
    };

    // Initialize app
    app.init();
  </script>
</body>
</html>
