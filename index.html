<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Êº¢Â≠ó„Éû„Çπ„Çø„Éº - Kanji Mastery</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: sans-serif;
      background: white;
      color: black;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid black;
    }
    
    h1 {
      font-size: 24px;
    }
    
    .nav-tabs {
      display: flex;
      gap: 10px;
    }
    
    .tab-btn {
      padding: 8px 16px;
      background: white;
      border: 1px solid black;
      cursor: pointer;
    }
    
    .tab-btn.active {
      background: black;
      color: white;
    }
    
    .page {
      display: none;
    }
    
    .page.active {
      display: block;
    }
    
    .legend {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      padding: 10px;
      border: 1px solid black;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 14px;
    }
    
    .legend-color {
      width: 20px;
      height: 20px;
      border: 1px solid black;
    }
    
    .kanji-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(28px, 1fr));
      gap: 2px;
      border: 1px solid black;
      padding: 10px;
      max-height: 600px;
      overflow-y: auto;
    }
    
    .kanji-cell {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      cursor: pointer;
      border: 1px solid #ccc;
    }
    
    .kanji-cell:hover {
      border: 2px solid black;
    }
    
    .kanji-cell.unknown { background: black; color: black; }
    .kanji-cell.learning { background: #333; color: black; }
    .kanji-cell.familiar { background: #666; color: black; }
    .kanji-cell.known { background: #999; color: black; }
    .kanji-cell.mastered { background: white; color: black; }
    
    .study-controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .control-group {
      min-width: 200px;
    }
    
    .control-group label {
      display: block;
      font-size: 14px;
      margin-bottom: 5px;
    }
    
    select, button {
      width: 100%;
      padding: 8px;
      border: 1px solid black;
      background: white;
      color: black;
      cursor: pointer;
    }
    
    button {
      background: black;
      color: white;
    }
    
    button:hover {
      background: #333;
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .study-card {
      border: 2px solid black;
      padding: 40px 20px;
      text-align: center;
      margin-bottom: 20px;
      min-height: 400px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    
    .answer-toggles {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .toggle-btn {
      padding: 6px 12px;
      border: 1px solid black;
      background: white;
      color: black;
      cursor: pointer;
      font-size: 14px;
    }
    
    .toggle-btn.active {
      background: black;
      color: white;
    }
    
    .kanji-display {
      font-size: 120px;
      margin-bottom: 20px;
    }
    
    .kanji-info {
      display: none;
    }
    
    .kanji-info.visible {
      display: block;
    }
    
    .stroke-order {
      font-size: 120px;
      margin-bottom: 20px;
      min-height: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .stroke-order svg {
      width: 200px;
      height: 200px;
      display: block;
    }
    
    .reading {
      font-size: 24px;
      margin-bottom: 10px;
    }
    
    .meaning {
      font-size: 18px;
      margin-bottom: 20px;
    }
    
    .examples {
      text-align: left;
      max-width: 600px;
      margin: 0 auto;
    }
    
    .example-item {
      margin-bottom: 15px;
      padding: 10px;
      border-left: 2px solid black;
    }
    
    .example-ja {
      font-size: 16px;
      margin-bottom: 5px;
    }
    
    .example-en {
      font-size: 14px;
      color: #666;
    }
    
    .show-answer-btn {
      max-width: 300px;
    }
    
    .rating-buttons {
      display: none;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 20px;
      width: 100%;
      max-width: 600px;
    }
    
    .rating-buttons.visible {
      display: grid;
    }
    
    .rating-btn {
      padding: 10px;
      border: 2px solid black;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      border: 1px solid black;
      padding: 15px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: bold;
      display: block;
    }
    
    .stat-label {
      font-size: 12px;
      margin-top: 5px;
    }
    
    .no-kanji {
      text-align: center;
      padding: 40px 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Êº¢Â≠ó„Éû„Çπ„Çø„Éº</h1>
      <div class="nav-tabs">
        <button class="tab-btn active" data-page="grid">Grid View</button>
        <button class="tab-btn" data-page="study">Study Mode</button>
      </div>
    </header>
    
    <!-- Grid Page -->
    <div id="grid-page" class="page active">
      <div class="legend">
        <div class="legend-item">
          <div class="legend-color" style="background: black"></div>
          <span>Unknown</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #333"></div>
          <span>Learning</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #666"></div>
          <span>Familiar</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #999"></div>
          <span>Known</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: white"></div>
          <span>Mastered</span>
        </div>
      </div>
      
      <div class="stats">
        <div class="stat-card">
          <span class="stat-value" id="total-kanji">0</span>
          <span class="stat-label">Total Kanji</span>
        </div>
        <div class="stat-card">
          <span class="stat-value" id="mastered-count">0</span>
          <span class="stat-label">Mastered</span>
        </div>
        <div class="stat-card">
          <span class="stat-value" id="learning-count">0</span>
          <span class="stat-label">In Progress</span>
        </div>
        <div class="stat-card">
          <span class="stat-value" id="unknown-count">0</span>
          <span class="stat-label">Unknown</span>
        </div>
      </div>
      
      <div class="kanji-grid" id="kanji-grid"></div>
    </div>
    
    <!-- Study Page -->
    <div id="study-page" class="page">
      <div class="study-controls">
        <div class="control-group">
          <label>Filter by Level</label>
          <select id="level-filter" onchange="app.startStudy()">
            <option value="all">All Levels</option>
            <option value="unknown">Unknown Only</option>
            <option value="learning">Learning Only</option>
            <option value="familiar">Familiar Only</option>
            <option value="known">Known Only</option>
            <option value="review">Review Due</option>
          </select>
        </div>
        <div class="control-group">
          <label>Sort By</label>
          <select id="sort-option" onchange="app.startStudy()">
            <option value="random">Random</option>
            <option value="frequency">Frequency</option>
            <option value="level">Proficiency Level</option>
          </select>
        </div>
      </div>
      
      <div class="study-card" id="study-card">
        <div class="study-options" style="margin-bottom: 20px;">
          <label style="margin-right: 15px; cursor: pointer;">
            <input type="checkbox" id="show-kun" checked onchange="app.saveTogglePreferences(); app.updateDisplay()"> Ë®ìË™≠„Åø (Kun)
          </label>
          <label style="margin-right: 15px; cursor: pointer;">
            <input type="checkbox" id="show-on" checked onchange="app.saveTogglePreferences(); app.updateDisplay()"> Èü≥Ë™≠„Åø (On)
          </label>
          <label style="margin-right: 15px; cursor: pointer;">
            <input type="checkbox" id="show-meaning" checked onchange="app.saveTogglePreferences(); app.updateDisplay()"> Meaning
          </label>
          <label style="margin-right: 15px; cursor: pointer;">
            <input type="checkbox" id="show-examples" onchange="app.saveTogglePreferences(); app.updateDisplay()"> Examples
          </label>
          <label style="cursor: pointer;">
            <input type="checkbox" id="show-stroke-order" onchange="app.saveTogglePreferences(); app.updateDisplay()"> Stroke Order
          </label>
        </div>
        
        <div class="kanji-display" id="current-kanji"></div>
        <div class="stroke-order" id="stroke-order" style="display: none;"></div>
        
        <button class="show-answer-btn" id="show-answer-btn" onclick="app.showAnswer()">
          Show Answer
        </button>
        
        <div class="kanji-info" id="kanji-info">
          <div class="reading" id="kanji-reading"></div>
          <div class="meaning" id="kanji-meaning"></div>
          <div class="examples" id="kanji-examples"></div>
        </div>
        
        <div class="rating-buttons" id="rating-buttons">
          <button class="rating-btn" data-rating="0" onclick="app.rateCard(0)">
            Again<br><small>Learning</small>
          </button>
          <button class="rating-btn" data-rating="1" onclick="app.rateCard(1)">
            Hard<br><small>Familiar</small>
          </button>
          <button class="rating-btn" data-rating="2" onclick="app.rateCard(2)">
            Good<br><small>Known</small>
          </button>
          <button class="rating-btn" data-rating="3" onclick="app.rateCard(3)">
            Easy<br><small>Mastered</small>
          </button>
        </div>
      </div>
      
      <div class="no-kanji" id="no-kanji" style="display: none;">
        <p>No kanji available for the selected filters.</p>
        <p style="margin-top: 1rem;">Try adjusting your filter settings.</p>
      </div>
    </div>
  </div>

  <script>
    const KANJI_LIST = `‰∏Ä‰∫å‰ªÅ‰∏âÂõõ‰∫î‰ºçÂÖ≠‰∏ÉÂÖ´‰πùÂçÅÁôæÂçÉ‰∏áËê¨ÂÑÑÊÜ∂ÂÖÜÁú∫ÈäöÊåëË∑≥Èõ∂‰ª§ÂÜ∑Èà¥Áé≤ÈΩ¢Ê≠ØË£ÅÂπ¥Áà∂ÈáúÊØçÂ≠êÂ≠úÂ≠§Â≠´Áà™Â≠î‰∫ÜÂÖÑÊ≥ÅÂºüÁ¨¨ÂºîÂßâÂ∏ÇÂ¶πÈªíÁ¥´Ê≠§Êü¥ÈõåÁ¥∫ÁîòÈùíÊô¥Ê∏ÖË´ãÁ≤æÊÉÖÈùñÈùôËµ§Ë∑°Á∑ëÈå≤Á¶ÑÈªÑÊ®™ÁôΩÊ≥äÊüè‰ºØÊãçËø´Ëà∂Á≤ïÂè£ÂìÅÂô®Âê∏ÂèäÊâ±Á¥öÂñ´ÂêπÁÇäÂô¥Â¢≥ÊÜ§ÂêêÂë≥Êú™ÂòÜÂñùÊ∏áÂë™ÂîÜÂò±Â±ûÂëºÂîÑÂêü‰ªäÁê¥È≥¥Âî±ÊòåÊô∂Âè´Ëµ≥ÂñöÊèõÂîØÁ∂≠Âí≤Âì®Âè∑ÂëâÂ®ØË™§Âê¶ËàåÂêéÂîáËæ∞Â®†ÊåØÈúáÂì≤ÂïìÂõΩÂõ≥ÂúíÈÅ†Âõ£ÂúèÂ∑ªÂà∏Êã≥ÂõûÂõ≤‰∫ïËÄï‰∏ºÂõ∫ÂÄãÂõ∞ÂõöÊó•ÊóßÊó≠ÊõúÊò®ÈÖ¢‰ΩúË©êÊò†Ëã±Â§ÆÊöóÈóáÊöÅÂ∞≠ÊõôÁΩ≤ÊöëË´∏ÊöñÊòáÂçáÂºÅÊôØ‰∫¨ÂΩ±ÊòìÊòØÊõ∏Èü≥ÈüøÈÉ∑È¶ôÊôãÊõøÊö´Êñ¨Áî∞Áî∑ËÉÉÁï∞Á¥ØÂ°ÅÁï≥ÊÄùÁïôÁîªÁî∫‰∏ÅÈ†ÇË®ÇÂ∫ÅÁï•ÈÖ™Áµ°ËêΩÁïîÂçä‰º¥Âà§ÂçëÁ¢ëÈ¨ºÈ≠îÈÜúÂ°äÈ≠ÇÈ≠èÈ≠ÖÈ≠ÅÊõ≤ÂÖ∏Ë±äÁõÆÁúºÈôêÁû≥Á´•Áû¨Áù°ÂûÇÁú†Ê∞ëÁù¶ÁúåËá™ÈºªË≤∑ÁΩ™ÁΩ∞ÁæÖÁΩ∑Ë¶áË¶ÜËÖπË§áÂæ©ÁúÅÂ∞ëÁÇíÂ∞èÁúãÁù£Ë≤ùË¥àÊõΩÂÉßÂ±§Â¢óÊÜéË≤°ÊâçÊùêË≥≠ÊïóË≥†ÂüπÂÄçÈô™Ë≤©ÂèçÊùøÂùÇÈ£ØÈò™ÁâàÁâáË≤ØË≥ÑË≥äË≥ºÊ∫ùÊßãË¨õË≤ßË≤ªË≤¥Ë≤®ÂåñËä±Èù¥Èù©Ë≥ÉË≤∏‰ª£Ë¢ãË≥ÄÂä†Êû∂ÂòâË≤øË≥õË≥™Ë≥¢Â†ÖÂì°È°åÈ°òÈ†ëÈ°îÂΩ¶È°çÈ°ûÈ†àÈ†ªÊ≠©È†ÜÈ†ê‰∫àÈáéÈ†≠Ë±ÜÈÄóÈ°ïÈ°ßÈõáÊúàÂãùËÑöÂç¥ËÉ¥ËÖ∞Ë¶ÅËÖïËÉéÂè∞ÊÄ†ËÜ≥ÂñÑËÜ®ËÑÇÊó®ÊåáËÉ∏ËáìËîµËÖ∏È®∞ËÉûÂåÖÊ≥°Êä±Á†≤È£ΩËÇ•Ë±öËÇùÂπ≤Ê±óÂππÂàäËÉÜÊãÖËÑáËÑÖÂçîËÇ∫ËÑ≥ÊÇ©ËÑàËÜúÊúçËÑ±ËÇåÊú∫È£¢ËÉåËÇØÈ™®ËÖéÁÅ´ÁÅØÁÅΩÁáÉÁÑ∂ÁÑºÁÇâÁá•ÊìçËóªÁπ∞ÁÖ©ÁàÜÊö¥ÁÖôÁïëÁï†Ê∞¥Ê∞∑ÊπØÊµ©Ê≤àÊûïÊ¥ãÁæäÊ¥≤Â∑ûÈÖ¨Êµ∑ÊÇîÊØéÊ≤ñ‰∏≠‰ª≤Âø†ÁÅòÊ≥¢Á†¥ÊµÅÁêâÁ°´ÁÄ¨È†ºÊ∏¶Á¶çÈçãÈÅéÊ¥™ÊπæÊµ¶Ë£úÊçïËºîËí≤ËàóÊµúÂÖµÊΩüËáºËààÊ∏ØÊπñËÉ°Ê≤¢ÊäûÊ≥•Ê±†Âú∞‰πüÊ∑ÄÊ≤≥ÂèØ‰ΩïËç∑Â∑ùÊªùÁ´úÈæçÊ∏ìÈ∂èÊµÆÊºèÊ≥åÁßòÂøÖÊª¥ÊëòÈÅ©ÊïµÊ≤°ÊΩúÊµ∏‰æµÂØùÊ∑±Ê±öÊøØÊ¥óÂÖàÊ∫∂ÂÆπÊµ¥Ê¨≤Êº±Ê∂ºÊµÑÊ∑≥ÊΩ§ÊªëÊº¨Ê∏©Ê≤∏ÊπßÂãáÊ≤πÁî±Ê±ΩÊ∞óÊ±ÅÊªãÊÖàÁ£ÅÊ≤ªÊ∏ãÊπøÊ∂ôÊàªÊ≥£ÈÖíÊΩîÊ±∫ÊºîÊ∑ëÂèîÊ∂≤Ê∑∑ÊòÜÊøÉËæ≤Ê∫Ä‰∏°ÂÜÜÊº†ÊøÅÊøÄÊ¥ªÊã¨‰π±ËæûÂπ∏Â†±Ê∏¨ÂâáÂÅ¥Ê¥•Êº¢Ê±éÂá°Â∏ÜÊ∏°Â∫¶Ê∫ñÊªûÂ∏ØÊ∏àÊñâÂâ§Ê∑ªÊ¥æÊº´ÊÖ¢ÊªÖÊ≥ïÂéªÊºÇÁ•®Ê®ôÊµÖÈä≠Ë∑µÊº∏Ê∏ïÊ∑µÊ∫êÂéüÊ∏õÊ∂ØÊ∂àËÇñÊ∏âÊæÑÁôªÊ≥®Êü±ÈßêÊºÜÊ≤ôÁ†ÇÊ∑°Ë´áÁÇéÊ≥≥Ê∞∏Ë©†ÂáùÂáÜÈÖ∏ÈÖ∑ÂëäÈÖµÂ≠ùÊïôËÄÅÈÜ∏Â£åÂ¨¢Ë≠≤ÈÖçÈÖîÁ≤ãÊú®ÊûóÊ£ÆÊ®ãÊ§úÈ®ìÂâ£Èô∫Ê°ÉÈÄÉÊùæË®üÂÖ¨Ê¶éÊ®∫ËèØÊ§øÊùâÊ°úÊ°ßÊ™úÊ§éÊ•¢ÊßôÁúüÊÖéÊüøÊ¢®Ê°ÇÂú≠Ê•†Ê†πÁóïÊ©òÊ°ëÊ†ÉÊ†óÊ¶äÊ¢ÖÊùéÊü≥Ê•äÊèöÈôΩÊßªË¶èÊ®πÊûêÊû¢Êû†Ê¢ÅÊ£öÊúãÂ¥©ÊùúÊßΩÊõπÈÅ≠Ê®ΩÊ©ãÂñ¨ÂÉëÁüØÊ¨ÑËò≠ÊùëÊ†∏Ê†ºÂêÑÈñ£ÂÆ¢Ê¢∞ÊàíÊ¶ÇÊÖ®Ê£ãÊúüÂÖ∂ÁÆïÊóóÊ¨∫ÊùØ‰∏çÊûöÊ©üÂπæÁ£ØÁïøÊûØÂè§ÂßëÊïÖÊ†°‰∫§ËºÉÁµûÂäπÈÉäÊúΩÊ•µÊ®©Ê§çÊÆñÊßòÊ£íÂ•â‰ø∏Ê°üÊú≠ÊüÑÁóÖÊ®°Êú¥Êù°ÊüîÈõÜÊüìÊüªÊûùÊîØÁ§æÁ•àÁ•ñÁãôÁµÑÁ≤óÁßüÈòªÁ•ûÁî≥‰º∏Á¥≥Á¶ÖÊà¶Á•ùÁ§ºÁ¶èÂâØÂπÖÁ••Ë©≥Á•êÂè≥Á•âÊ≠¢Ë¶ñÂàùË¢´ÁöÆÂΩºÊä´Áñ≤Ë£ïË•üÁ¶ÅË¢ñË£∏ÈáëÈäÄÈäÖÂêåÊ¥ûÊ°êÁ≠íÈå´ÈâÑËø≠ÈãºÁ∂±Â≤°ÂâõÈâõÊ≤øÈè°Â¢ÉÈå¶ÈäÉÂÖÖÈéñÈáßÈéåÈáùÈã≠ÈàçÂ±ØÈã≥ÂØøÈå†ÂÆöÈçµÂª∫ÂÅ•Èâ¢Êú¨ÂΩìÈçõÊÆµÈêòÈäòÂêçÈëëÁõ£Ëâ¶Èá£ÈéÆÂúüÂ£≤Â£∞ÂñúÂ°æÁÜüÂ£ÅÁôñÂûãÂàëÂΩ¢Áì∂Áì¶Â¢®Â°óÂ¢úÂ†ïÊúâÂû£Â°ÄÂ±è‰ΩµÂ£áÂ°öÂ°îÊê≠Á≠îÂüéÊàêË™†ÁõõÂùëÊäóËà™Â†ÄÂ±àÊéòÂ†§ÊèêÂ†∞ÂüºÂ•áÂØÑÈ®éÂ¥éÂ†∫ÁïåÂ†¥ÂüüÂ£äÊáêÂ†™ÂãòÁîöÂùáÂüãÂ°©ÁêÜÈáåÁèæÁèçÁè†Êú±Ê†™ÊÆäÁëûÁè≠Áí∞ÈÇÑÁêÉÊ±ÇÊïëÁê¢ÁéãÁöáÊúõËÅñÁéâÁ¥†ÊØíÂ•èÊ≥∞È∫¶È∫πÁß¶ÁùÄÁæéÈ§äÂßúÂ∏≥Èï∑ÂºµÂπåÊôÉÂÖâÂ∏ΩÂÜí‰∫∫ÂÇæÈ†É‰Ω≥‰ΩøÂè≤ÂÄüÊòîÈåØÊÉúÂÉçÂãï‰ºëÂÇç‰ªªÂ¶äËçè‰ºùËª¢ÂÇ¨‰ø°‰ªèÊâï‰øÆÂÄ´Ëº™‰ºè‰ΩçÂÑ™ÊÜÇÂÇë‰øäÈßøÂ≥ª‰Ωì‰ø£ÂÇ∑ÂÉèË±°ÂÇµ‰ΩêÂ∑¶Â∑Æ‰øóË∞∑‰ø∫Â•ÑÂÉïÊí≤Ê•≠‰æ°‰øÇÁ≥ª‰ª∂ÂÄô‰æõÂÖ±‰ªñ‰ΩéÊäµÂ∫ïÈÇ∏ÂÅµË≤ûÁ¶éÂÄíÂà∞‰ø≥ÊéíËº©‰øµË°®ÂÇô‰æøÂÅΩÁÇ∫ÂÄ§ÁΩÆÁõ¥‰æùË°£‰ºäÂÄ≠Âßî‰ª∞ÂÅ∂ÈÅáÈöÖ‰æã‰ºº‰ª•ÂÅèÈÅçÁ∑®ÁØá‰ªÆ‰ΩèÂÄ∂ÂÖ∑ÂÑüË≥ûÂÅú‰∫≠ÂÅâÈÅïÁ∑ØÂÉöÈÅºÂØÆÁôÇ‰æÆ‰ªïÂ£´ÊÅ≠Âú®Â≠òÂæåË°åÂæÄ‰∏ªÂΩπÁñ´Ë°ìÂæãÂæ™ÁõæË°õÂæíËµ∞Ë∂ÖË∂ôË∂äËµ¥ÂæÆË°ùÂæπÊí§Âæ≥ÂæóÂæÅÊ≠£Ë®ºÁóáÊîøÊï¥ÂæêÂèôÈô§Ë°°Âæ°Âç∏Ë°óÂ•≥Â¶ÉÂß´Ëá£Ëá®Â™õÊè¥Â®òÂ´°Â¶ôÂ¶ñÂ¶ÇÂ©øÂ©¶Â•ΩÂ™íÂ©öÂßªÂõ†Â´ÅÂÆ∂Á®ºÂßìÁîüÊòüÊÄßÁâ≤Áî£ÂßãÂ´åÂÖºË¨ôÂ¶ªË®ÄË™∞Ë¨ÄÊüêË™ûÂêæÊÇüË©±Ë®òÂ∑±ÂøåÁ¥ÄËµ∑Ë≠∞Áæ©Áä†ÂÑÄË´ñË©∞ÂêâË™¨Á®éË™åÂøóË™≤ÊûúËèìÂ∑£Ë©ûÂè∏È£ºË®ìË™≠Ë®≥Ë™øÂΩ´Ë¨πÂã§Ë¨éËø∑Ë®àË´æË®∫Ë©¶ÂºèË´ÆË≥áÂßøÊ¨°Ë™ìË≠¶Êï¨È©öË≠∑Ë™òË≠òÁπîËÅ∑Ë®¥Ë™çÂøçÂàÉË®éË´≠ÊÑâËº∏ÁôíË¨ùÂ∞ÑË∫´Ë®±Ë™ïÂª∂Ë≠úÊôÆ‰∏¶Ë®≠Ë™áË¨°Êè∫Ë©ïÂπ≥Âù™Ë©≤ÂäæË´èÂèñË∂£ËÄ≥ÊÅ•ËÅ¥Âä©ËÅØÂøÉÊÖãËÉΩÁÜäÊÅØÊÅ©ÊÜ©ÊÅãÂ§âÊÄ•ÂøòÁõ≤Âøô‰∫°ÊÇ£ÊÇ™‰∫úÊÑèÊÄíÂ•¥Âä™ÊÅêÊÖ∞Â∞âÊÇ≤ÈùûÊââÊñêÊÉ≥Áõ∏ÊπòÁÆ±Êá∏ÊÇ†ÊÜ≤Êá≤Âæ¥ÊááÊÉëÊÑöÊÜæÊÑüÊÖ£Ë≤´Âø´ÊÇºÊÄñÂ∏ÉÂ∏åÊÉßÊÅ®ÊÉ®ÂèÇÊÅí‰∫òÊÖåËçíÊÄ™ÊâãÊíÉÊäïÊé®ÊãôÂá∫Êì¨ÁñëÊäÄÂ≤êÊê∫ÊíÆÊúÄÊéÉÊèèËãóÁå´ÊâπÊØîÁêµÊéßÊç®ËàéÊéõÊåøÊìÅÊé™Êé°ËèúÂΩ©Êé≤ÊéàÂèóÊãùÊãìÊäºÊãêÊì¶ÂØüÊêæÊè°ÊäúÈ´™ÂèãÊäπÊú´ÊåüÂ≥°Áã≠Êã°Â∫ÉÈâ±ÂÆèÁ¥òÊçÆÂ±ÖÊã†Âá¶ÊêçÊã∑ËÄÉÊâìÊäòÊå´Â∫ßÊäëÊé•ÊëÇÊâ∂Â§´ÊçúÊé¢ÊãæÊèÆËºùÊãíÂ∑®Ë∑ùÊãòË∂≥‰øÉÊçâË∫çË∏äÁî®Ë∏èË¶ãË¶™Êñ∞Ë¶≥ÂãßÊ≠ìË¶ßÂÖêÂÖãÂÖúÁ´∂ÈÄ±Âë®ËøëÊ¨£Êñ≠Ëæ∫ÂàÄÈÄüÊùüÁñéÈÅãÈÅäÈÅÖÈÄÜËæºÂÖ•ÈÄöÁóõÈÄî‰ΩôÊñúÈÅ∑ÈÄùÂ∑°ÈÅ£ÈÄÅËøîÈÄÄÈÄ†ÈÄ∏ÈÅÆËøΩÈÅÇÈÅîÈÄ≤ÈÅøÈÄÆËøÖÈÄìËøéËø∞ÈÄèÈÅ∏Â∑ΩÈÅ∫ËæªÊñπËÇ™ÂùäÂ¶®Ë®™ÊàøËä≥Á¥°Èò≤ÊîæÊñºÊóèÊóÖÊñΩÊóãÂåóÂçóË•øÊù±ÂáçÊ£üËªäËªåËª∏ËªüËªΩÂæÑËåéÁµåËªíËΩÑÂâ≤ËàüËàπËâáÂª∑Â∫≠‰∏πÊò•Â§èÁßãËê©ÂÜ¨ÊúùÊΩÆ‰πæ‰πôÈüìÂçàÊòºÊô©Â§úÈõ®Èõ≤ÊõáÈõ∞ÂàÜÁ¥õÁ≤âÈúßÂãôÁüõÈúûÊöáÈú≤Ë∑ØÈõ∑ÈõªÈõ™ÈúäÈúÄÊÑõÂ¶•ÁÜ±Ëí∏ÊâøÁÖÆËÄÖÁÖïÁÖßÊò≠Ê≤ºÊãõÁ¥πÂè¨Âã≤Ëñ´ÈªôÁÑ°ËàûÁÇπÈñÄÂïèÈñìÁ∞°Èñ¢ÈñëËÅûÈñãÈñâÈñ≤ÊÇ¶Èñ•‰ºêÈóòÂÜô‰∏éÂÜóÂÜ†ËªçÁ©¥Â≠óÂÆóÁ§∫ÂØõÂÆ∞ËæõÂü∑ÂØíÂØÇÂÆÆÂëÇÂÆùÂØÜÂØ©ÂÆüÁ™ÆÂÆ£ÂØßÂÆ≥ÂÆÖË®óÂÆãÂØ°ÂÆ§ÂÆòËèÖÁÆ°È§®ÈòúÂÆ¥Ë≥ìÂØåÂÜ®ÂÆúÂÆáÂ§©ÂÆôÊäΩÂÆâÊ°àÂÆåÂÖÉÁø´ÂØÖ‰∏∏Á©∂Á™ÅÁ™ÉÂàáÁ™íÁ™™Á™ØÁ™ìÁ©∫Â≠¶Ë¶öÊ†ÑÂñ∂ËõçÂä¥ÊéåÂ†ÇÂÖöÂ∏∏ÂìÄË°∞Âñ™Ë£èË£ÇÂàóÁÉàË£ÖÂ£ÆËçòË£ΩÂà∂Ë§í‰øùÂëÜË•≤ÂçíÁéáË±™‰∫Æ‰∫´‰∫®ËÇ≤Ê£ÑÂêëÂ∞öÊåôË™âÂ•ÆÂ•àÂ•îÂ•™ÂØ∏ËÄêÂØæÂ∞ÅËæ±Â∞äÂ∞éÈÅìÈ¶ñÂ∞ãË£ÅËºâÊ†ΩÂúßÂ®ÅÁÅ∞ÂéÑÊ≠¥Êö¶ÂéöÂéòÂ∏≠Â∫äÈ∫ªÊë©Á£®ÂªäÈÉéÊúóÂ∫´Â∫ú‰ªòÁ¨¶Â∫óÂïÜÂ∫∑ÊÖ∂Â∫∏È∑πËÖêËÇâÂªâÂ∫∂Â∫èÂªÉÁô∫Â∫µÂøúÂªüÈπøÈ∫óÁó¢Âà©ÁñæÁó¥Áü•Êô∫ËôéËôöÊàØËôúÊÖÆËÜöÁõßËôêÂäáÂ±ãÂ±ÄÂ∞ªÂ∞æÊ¢∂ÊØõÂ∞øÂ±äÂ±ïÂ±•Â∞ΩÂ∞ºÊà∏ÊâÄËÇ©ÊâáÂêàÂê´ÂëΩ‰ºÅÂÖ®ÂÇòÂØ∫ÊôÇÊåÅ‰æçË©©ÂæÖÁâπÁ≠âÈ≠öÊºÅÈØ®ÈÆÆËô´ËõáËöäËù∂ËûçÁã¨ÁãºÊµ™ËâØÁãÇÁåõÂ≠üÁã©ÂÆàÁåüÁå™ÁçÖÂ∏´Â∏•Áç≤Á©´Áå∂ÁäØÁåøÁçÑÈ¶¨ÈßíÂè•ÈßÜÂå∫Ê¨ßÊÆ¥ÈßÖÈ®íÈßÑÂ§™ÁÉèÈ≥•È≥©Èµ¨È¥ªÈ¥àÈ¥®ÈµúÈ∂¥È∑≤Â∞±Â≥∂Â∂ãÂ∂åÁâõÁâü‰π≥Áâ©‰∫ãÁâßÈõÑÈõ¢ÈõëÈõ£ÈõÄÁæΩÁøíÁøåÁøºÁøîÁøªÁï™Ëó©Âπ°ÁøÅËå®ËãëËäΩÁâôÈõÖËëâËäù‰πã‰πèËçâÊó©ÂçìËä¶Ëä≠Â∑¥ÊääÁê∂ËïâËå∂ËèåËèäËëµËóçËñÆËìÆÈÄ£Ëä•‰ªãËëõËè©ËçªËåÖËòáËè±ÂãüÊÖïËã•ÊöÆÂ¢ìÂπïËìÑÁïúËä∏ËóùËë¨Ê≠ªËñ©Ëñ¶Ëñ¨Ê•ΩÂ§¢Ëó§ËåÇËñÑÂçöÁ∏õÂ∞ÇÁ∞øËã´Âç†Ëã¶Á≥∏Á∑íËëóÁ∏æË≤¨Á©çÁµ±Áµ¶Á∑©Á¥çÂÜÖÁ∑èËÅ°Á¥îÁµπÁ∂øÁ∑öÊ≥âÁ∂≤Á∏ÑÁµêÁ∑†Â∏ùÁ¥ÑÁöÑÁ∏ÅÁ∂ôÁµ∂Ëâ≤ÁµÇÁ¥ôÊ∞èÁ¥ãÊñáÊñéÁ≤õÁµµ‰ºöÁ∂æÁπäÁ¥∞Á∂öÁ∏¶ÂæìÁ≥æÁ∏ÆÂÆøÁ∑¥Á¥¢Á∑äÁπÅÁ´πÁØâÁ≠ëÁØ†Á¨π‰∏ñÁ¨õÁØ§Á≠ãÁØÄÂç≥Á¨ëÁÆóÁ≠ÜËÇáÁ±çÁ≠ñÁØÑÁ±≥ÊñôÊñóÁ≤íÁ¨†Á´ãÁ´ØÁ≥ñÂîêÁ≤ßÂ∫ÑÁ≤òÁ≥ßÈáèÁßÅÁ®öÁ®îÂøµÁ©èÈö†ÂíåÁßªÁ®ãÂëàÁ®≤Á©ÇÊÅµÁßíÁß∞Áß©Â§±ÁßëÁ®ÆÈáçÁ®øÈ´òÂ≠£ÁßÄ‰πÉÈáàÂ∞∫Áü≥Á§éÁ§ÅÁÑ¶Á†îÁ†ïÁ¢∫Á°¨Êõ¥Á¢ÅÂü∫Â±±‰ªôÂ¥îÂ≤©Â∑åÂé≥Êï¢Â≤∏ÁÇ≠Â≥†‰∏ä‰∏ãÂ≤≥‰∏òÂ∂ΩÂ≥∞Â≥ØÈÄ¢Á∏´Â∂∫È†òÂµêÈ¢®ÂáßÂ≤¨Áî≤Â¥áÁöøÁõÜÁõ§Á£êÊê¨Ëà¨ÁõóÁõüÊòéÁõäË°ÄË°ÜÈ£üÈ£≤È£æÈ§ìÊàëÊó¢Â§ßËá≠Â∞ñÂ••Â•®Â∞ÜÂ•ëÁä¨ÁåÆÁä∂Áç£ÂäõÂπºÂãâÂÖçÂä±Âã¢Âä£Â§ïÂ§ñÊÆãÊÆâÊó¨Â§ö‰πÖÂ∑•È†ÖÂäüÊîªÂ∑ßÊ±üÁ¥ÖËôπË≤¢Ê¨†Ê≠åÊ¨æÈö∑ÊïèÊîπÊï∑Êï£Êï∞Ëá¥Ëá≥Ëµ¶Êï¶ËßíËß¶Ëß£‰∫âË≤†Âç±‰∫ÄÂåªÁü¢Áü≠Âå†ÂåπÂåøÂá∂ÂáΩÂπΩÂà∑Ââ∞‰πóÂâµÂÄâÂâñÂà•ÂâäÂààÂäâÂàªÂà∫Â∏∞ÊÆ∫Á©ÄÊÆªÊÆøÊØÖÂèàÂèéÂèåÈöªÈö£Êù•Èô£ÈöÜÈôçÈöõÁ•≠ÈöäÈöèÈ´ÑÈô¢ÈôµÁ®úÈô∏ÈöéÁöÜÈôõÈô∞Èô∂Èô≥ÈöúÁ´†ÂΩ∞ÈöîÈô•ÈÇ¶ÈÑ≠ÈÉΩÈÉ°ÂêõÁæ§ÈÉ®ÈÉµÈÇ™ÈÉÅÈÇ£ÈÉ≠ÈòøÂºìÂºïÂºòÂº∑ÂºæÂçòÂº¶ÁéÑÂπªÂº•Âº±Âç∞ÂÜçÂçµ‰∏à‰∫íÈºìÊ≠¶È£õÂÜäÁº∂ÂºäÂπ£Èù¢Ââç`.split('');

    const RADICALS = `ÂÑøÁõÆÈáëÊâãË∂≥Èõ®‰∫∫Ê∞¥ÁÅ´Êú®Âè£Áî∞Êó•ÊúàÂøÉÂúüËâ∏Â•≥Â≠êÁ´πÁ±≥Á≥∏Ë≤ùËªäÈñÄ‰∏Ä‰∫åÂäõÂàÄÂçÅ‰∏∂Â§ßÂ∞èÂ±±Â∑ùÂ∑•Â∑æÂºìÂΩ≥Êî¥Êà∏Áü≥Á§∫Á¶æÁ©¥Á´ãËÄ≥Ë°£Ë®ÄË∞∑Ë±ÜË±ïË±∏Ëµ§Ëµ∞Ë∫´ËæõËæ∞ÈáåÈï∑ÈòúÈÇëÈÖâÈùíÈùûÈù¢Èù©Èü≠Èü≥È†ÅÈ¢®È£õÈ£üÈ¶ñÈ¶¨È™®È´òÈ´üÈ¨•È¨ØÈ¨ºÈ≠öÈ≥•ÈπµÈπøÈ∫¶È∫ªÈªÑÈªçÈªíÈº†ÈºªÊ≠ØÁ´ú‰∫ÄÈæ†ÂÆÄÂØ∏ÂõóÁôΩÁöÆÁöøÁüõÁü¢ÁΩëÁæäÁæΩËÄÅËÄíËÅøËÇâËá£Ëá™Ëá≥ËáºËàåËàüËâ≤Ëô´Ë°ÄË°åË•øË¶ãËßíÁîòÁîüÁî®Áì¶ÁìúÁéâÁéÑÁä¨ÁâõÁâôÂ£´Â§ïÂ∞∏ÂÖ´ÂçúÂç©ÂéÇÂé∂ÂèàÂá†ÂáµÂÜ´ÂÜñÂÜÇÂÖ•`.split('');

    const app = {
      kanjiData: {},
      currentKanji: null,
      studyQueue: [],
      currentIndex: 0,
      answerMode: 'rtk', // 'rtk', 'reading', or 'examples'
      currentKanjiFullData: null,
      
      init() {
        this.loadData();
        this.loadTogglePreferences();
        this.setupEventListeners();
        this.renderGrid();
        this.updateStats();
      },
      
      loadTogglePreferences() {
        const prefs = localStorage.getItem('togglePreferences');
        if (prefs) {
          const preferences = JSON.parse(prefs);
          document.getElementById('show-kun').checked = preferences.showKun ?? true;
          document.getElementById('show-on').checked = preferences.showOn ?? true;
          document.getElementById('show-meaning').checked = preferences.showMeaning ?? true;
          document.getElementById('show-examples').checked = preferences.showExamples ?? false;
          document.getElementById('show-stroke-order').checked = preferences.showStrokeOrder ?? false;
        } else {
          // Set defaults
          document.getElementById('show-kun').checked = true;
          document.getElementById('show-on').checked = true;
          document.getElementById('show-meaning').checked = true;
          document.getElementById('show-examples').checked = false;
          document.getElementById('show-stroke-order').checked = false;
        }
      },
      
      saveTogglePreferences() {
        const preferences = {
          showKun: document.getElementById('show-kun').checked,
          showOn: document.getElementById('show-on').checked,
          showMeaning: document.getElementById('show-meaning').checked,
          showExamples: document.getElementById('show-examples').checked,
          showStrokeOrder: document.getElementById('show-stroke-order').checked
        };
        localStorage.setItem('togglePreferences', JSON.stringify(preferences));
      },
      
      loadData() {
        const saved = localStorage.getItem('kanjiProgress');
        if (saved) {
          this.kanjiData = JSON.parse(saved);
        } else {
          // Initialize all kanji as unknown
          KANJI_LIST.forEach(kanji => {
            this.kanjiData[kanji] = {
              level: 0, // 0=unknown, 1=learning, 2=familiar, 3=known, 4=mastered
              lastReview: null,
              nextReview: null,
              reviewCount: 0
            };
          });
          this.saveData();
        }
      },
      
      saveData() {
        localStorage.setItem('kanjiProgress', JSON.stringify(this.kanjiData));
      },
      
      setupEventListeners() {
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            e.target.classList.add('active');
            const page = e.target.dataset.page;
            document.getElementById(page + '-page').classList.add('active');
            
            // Auto-start study when switching to study page
            if (page === 'study') {
              this.startStudy();
            }
          });
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
          // Ignore if typing in an input field
          if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
          
          const key = e.key.toLowerCase();
          const isAnswerVisible = document.getElementById('kanji-info').classList.contains('visible');
          const isStudyMode = document.getElementById('study-page').classList.contains('active');
          
          // Only handle shortcuts in study mode
          if (!isStudyMode) return;
          
          // Space/Enter - Show Answer
          if ((key === ' ' || key === 'enter') && !isAnswerVisible) {
            e.preventDefault();
            this.showAnswer();
            return;
          }
          
          // Number keys 0-4 - Rate cards (only when answer is visible)
          if (isAnswerVisible && ['0', '1', '2', '3', '4'].includes(key)) {
            e.preventDefault();
            const rating = parseInt(key);
            this.rateCard(rating);
            return;
          }
          
          // Toggle shortcuts (work anytime in study mode)
          if (key === 'k') {
            e.preventDefault();
            document.getElementById('show-kun').click();
            return;
          }
          if (key === 'o') {
            e.preventDefault();
            document.getElementById('show-on').click();
            return;
          }
          if (key === 'm') {
            e.preventDefault();
            document.getElementById('show-meaning').click();
            return;
          }
          if (key === 'e') {
            e.preventDefault();
            document.getElementById('show-examples').click();
            return;
          }
          if (key === 's') {
            e.preventDefault();
            document.getElementById('show-stroke-order').click();
            return;
          }
          
          // Arrow keys / Backspace - Navigate cards
          if (key === 'arrowleft' || key === 'backspace') {
            e.preventDefault();
            this.previousCard();
            return;
          }
          if (key === 'arrowright') {
            e.preventDefault();
            this.nextCard();
            return;
          }
          
          // R - Restart session
          if (key === 'r') {
            e.preventDefault();
            this.startStudy();
            return;
          }
          
          // Escape - Skip card
          if (key === 'escape') {
            e.preventDefault();
            this.skipCard();
            return;
          }
        });
      },
      
      renderGrid() {
        const grid = document.getElementById('kanji-grid');
        grid.innerHTML = '';
        
        KANJI_LIST.forEach(kanji => {
          const cell = document.createElement('div');
          cell.className = 'kanji-cell ' + this.getLevelClass(kanji);
          cell.textContent = kanji;
          cell.title = `Click to study: ${kanji}`;
          cell.addEventListener('click', () => this.studySpecificKanji(kanji));
          grid.appendChild(cell);
        });
      },
      
      studySpecificKanji(kanji) {
        // Switch to study mode tab
        this.switchTab('study');
        
        // Create a study queue with just this kanji
        this.studyQueue = [kanji];
        this.currentIndex = 0;
        
        // Show study card
        document.getElementById('study-card').style.display = 'flex';
        document.getElementById('no-kanji').style.display = 'none';
        
        // Load the card
        this.showCard();
      },
      
      switchTab(page) {
        // Update tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.classList.remove('active');
          if (btn.dataset.page === page) {
            btn.classList.add('active');
          }
        });
        
        // Update pages
        document.querySelectorAll('.page').forEach(p => {
          p.classList.remove('active');
        });
        document.getElementById(page + '-page').classList.add('active');
      },
      
      getLevelClass(kanji) {
        const level = this.kanjiData[kanji]?.level || 0;
        const classes = ['unknown', 'learning', 'familiar', 'known', 'mastered'];
        return classes[level];
      },
      
      updateStats() {
        const stats = { unknown: 0, learning: 0, familiar: 0, known: 0, mastered: 0 };
        KANJI_LIST.forEach(kanji => {
          const level = this.kanjiData[kanji]?.level || 0;
          const key = ['unknown', 'learning', 'familiar', 'known', 'mastered'][level];
          stats[key]++;
        });
        
        document.getElementById('total-kanji').textContent = KANJI_LIST.length;
        document.getElementById('mastered-count').textContent = stats.mastered;
        document.getElementById('learning-count').textContent = stats.learning + stats.familiar + stats.known;
        document.getElementById('unknown-count').textContent = stats.unknown;
      },
      
      
      async startStudy() {
        const filter = document.getElementById('level-filter').value;
        const sort = document.getElementById('sort-option').value;
        
        const now = new Date();
        
        // Build queue based on filter
        this.studyQueue = KANJI_LIST.filter(kanji => {
          const data = this.kanjiData[kanji];
          
          // Skip cards that aren't due yet (unless filtering by 'all')
          if (filter !== 'all' && data.nextReview) {
            const nextReviewDate = new Date(data.nextReview);
            if (nextReviewDate > now) {
              return false; // Not due yet
            }
          }
          
          if (filter === 'all') return true;
          if (filter === 'unknown') return data.level === 0;
          if (filter === 'learning') return data.level === 1;
          if (filter === 'familiar') return data.level === 2;
          if (filter === 'known') return data.level === 3;
          if (filter === 'review') {
            // Only show cards that are due for review
            if (!data.nextReview) return false;
            return new Date(data.nextReview) <= now;
          }
          return false;
        });
        
        if (this.studyQueue.length === 0) {
          document.getElementById('study-card').style.display = 'none';
          document.getElementById('no-kanji').style.display = 'block';
          return;
        }
        
        document.getElementById('study-card').style.display = 'flex';
        document.getElementById('no-kanji').style.display = 'none';
        
        // Sort queue
        if (sort === 'random') {
          this.studyQueue.sort(() => Math.random() - 0.5);
        } else if (sort === 'level') {
          this.studyQueue.sort((a, b) => this.kanjiData[a].level - this.kanjiData[b].level);
        }
        // For frequency, we'll keep the original order (which is roughly by frequency)
        
        this.currentIndex = 0;
        this.showCard();
      },
      
      async showCard() {
        if (this.currentIndex >= this.studyQueue.length) {
          // Session complete - just hide the card
          document.getElementById('study-card').style.display = 'none';
          document.getElementById('no-kanji').style.display = 'block';
          document.getElementById('no-kanji').innerHTML = '<p>Study session complete! üéâ</p><p style="margin-top: 1rem;">Select a filter to start a new session.</p>';
          return;
        }
        
        this.currentKanji = this.studyQueue[this.currentIndex];
        document.getElementById('current-kanji').textContent = this.currentKanji;
        document.getElementById('kanji-info').classList.remove('visible');
        document.getElementById('rating-buttons').classList.remove('visible');
        document.getElementById('show-answer-btn').style.display = 'block';
        
        // Reset display - show kanji, hide stroke order initially
        document.getElementById('current-kanji').style.display = 'block';
        document.getElementById('stroke-order').style.display = 'none';
        document.getElementById('stroke-order').innerHTML = '';
        
        // Fetch kanji data from multiple sources
        try {
          // Get basic kanji data
          const kanjiResponse = await fetch(`https://kanjiapi.dev/v1/kanji/${this.currentKanji}`);
          const kanjiData = await kanjiResponse.json();
          this.currentKanjiFullData = kanjiData;
          
          // Get example words
          const wordsResponse = await fetch(`https://kanjiapi.dev/v1/words/${this.currentKanji}`);
          const wordsData = await wordsResponse.json();
          this.currentKanjiFullData.words = wordsData;
          
        } catch (error) {
          console.error('Error fetching kanji data:', error);
          this.currentKanjiFullData = null;
        }
      },
      
      setAnswerMode(mode) {
        this.answerMode = mode;
        
        // Update toggle button states
        document.querySelectorAll('.toggle-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // If answer is already visible, update it
        if (document.getElementById('kanji-info').classList.contains('visible')) {
          this.displayAnswer();
        }
      },
      
      displayAnswer() {
        const data = this.currentKanjiFullData;
        
        if (!data) {
          document.getElementById('kanji-reading').textContent = '‚Äî';
          document.getElementById('kanji-meaning').textContent = 'Data unavailable';
          document.getElementById('kanji-examples').innerHTML = '';
          return;
        }
        
        const showKun = document.getElementById('show-kun').checked;
        const showOn = document.getElementById('show-on').checked;
        const showMeaning = document.getElementById('show-meaning').checked;
        const showExamples = document.getElementById('show-examples').checked;
        const showStrokeOrder = document.getElementById('show-stroke-order').checked;
        
        // Toggle between kanji display and stroke order
        if (showStrokeOrder) {
          document.getElementById('current-kanji').style.display = 'none';
          document.getElementById('stroke-order').style.display = 'block';
          this.loadStrokeOrder();
        } else {
          document.getElementById('current-kanji').style.display = 'block';
          document.getElementById('stroke-order').style.display = 'none';
        }
        
        let readingHTML = '';
        
        // Show ALL kun readings if checked
        if (showKun && data.kun_readings && data.kun_readings.length > 0) {
          readingHTML += `<div style="margin-bottom: 15px;">
            <strong>Ë®ìË™≠„Åø:</strong> ${data.kun_readings.join(', ')}
          </div>`;
        }
        
        // Show ALL on readings if checked
        if (showOn && data.on_readings && data.on_readings.length > 0) {
          readingHTML += `<div style="margin-bottom: 15px;">
            <strong>Èü≥Ë™≠„Åø:</strong> ${data.on_readings.join(', ')}
          </div>`;
        }
        
        if (readingHTML) {
          document.getElementById('kanji-reading').innerHTML = readingHTML;
          document.getElementById('kanji-reading').style.display = 'block';
        } else {
          document.getElementById('kanji-reading').style.display = 'none';
        }
        
        // Show ALL meanings if checked
        if (showMeaning) {
          if (data.meanings && data.meanings.length > 0) {
            document.getElementById('kanji-meaning').textContent = data.meanings.join(', ');
          } else {
            document.getElementById('kanji-meaning').textContent = '‚Äî';
          }
          document.getElementById('kanji-meaning').style.display = 'block';
        } else {
          document.getElementById('kanji-meaning').style.display = 'none';
        }
        
        // Show examples if checked
        if (showExamples) {
          const examplesHTML = this.getExamples(data);
          document.getElementById('kanji-examples').innerHTML = examplesHTML;
          document.getElementById('kanji-examples').style.display = 'block';
        } else {
          document.getElementById('kanji-examples').style.display = 'none';
        }
      },
      
      async loadStrokeOrder() {
        const kanji = this.currentKanji;
        const unicode = kanji.codePointAt(0).toString(16).padStart(5, '0');
        const svgUrl = `https://raw.githubusercontent.com/KanjiVG/kanjivg/master/kanji/${unicode}.svg`;
        
        try {
          const response = await fetch(svgUrl);
          const svgText = await response.text();
          
          // Parse SVG properly to avoid XML artifacts
          const parser = new DOMParser();
          const svgDoc = parser.parseFromString(svgText, 'image/svg+xml');
          const svg = svgDoc.querySelector('svg');
          
          if (!svg) {
            throw new Error('Invalid SVG');
          }
          
          // Clean up the container and add the SVG
          const container = document.getElementById('stroke-order');
          container.innerHTML = '';
          container.appendChild(svg.cloneNode(true));
          
          // Get the imported SVG element
          const importedSvg = container.querySelector('svg');
          
          // Remove all metadata groups (kvg:element, text elements, etc.)
          importedSvg.querySelectorAll('g[id^="kvg:StrokeNumbers"]').forEach(el => el.remove());
          importedSvg.querySelectorAll('text').forEach(el => el.remove());
          
          // Get only the stroke paths (not the character outline)
          const paths = importedSvg.querySelectorAll('path[id^="kvg:"]');
          paths.forEach((path, index) => {
            // Style the strokes
            path.style.fill = 'none';
            path.style.stroke = 'black';
            path.style.strokeWidth = '3';
            path.style.strokeLinecap = 'round';
            path.style.strokeLinejoin = 'round';
            
            // Animate
            const length = path.getTotalLength();
            path.style.strokeDasharray = length;
            path.style.strokeDashoffset = length;
            path.style.animation = `drawStroke 0.5s ease-out ${index * 0.3}s forwards`;
          });
          
          // Add CSS animation if not already added
          if (!document.getElementById('stroke-animation-style')) {
            const style = document.createElement('style');
            style.id = 'stroke-animation-style';
            style.textContent = `
              @keyframes drawStroke {
                to {
                  stroke-dashoffset: 0;
                }
              }
            `;
            document.head.appendChild(style);
          }
        } catch (error) {
          console.error('Error loading stroke order:', error);
          document.getElementById('stroke-order').innerHTML = '<p style="color: #999;">Stroke order not available</p>';
        }
      },
      
      getPrimaryReadingWithExample(data) {
        // Try to find kun'yomi example first
        if (data.kun_readings && data.kun_readings.length > 0 && data.words) {
          const kunReading = data.kun_readings[0];
          
          // Priority 1: Single kanji by itself (most common usage)
          const singleKanji = data.words.find(word => {
            const written = word.variants[0]?.written || '';
            return written === this.currentKanji;
          });
          
          if (singleKanji && singleKanji.variants[0]) {
            const variant = singleKanji.variants[0];
            const meaning = singleKanji.meanings[0]?.glosses[0] || '';
            return {
              display: `${variant.written} (${variant.pronounced})`,
              meaning: meaning
            };
          }
          
          // Priority 2: Simple kun'yomi word (kanji + 1-2 hiragana, like È£ü„Åπ„Çã)
          const simpleKunWord = data.words.find(word => {
            const written = word.variants[0]?.written || '';
            return written.startsWith(this.currentKanji) && 
                   written.length <= 4 &&
                   this.containsHiragana(written);
          });
          
          if (simpleKunWord && simpleKunWord.variants[0]) {
            const variant = simpleKunWord.variants[0];
            const meaning = simpleKunWord.meanings[0]?.glosses[0] || '';
            return {
              display: `${variant.written} (${variant.pronounced})`,
              meaning: meaning
            };
          }
          
          // Fallback: just show the kun'yomi reading
          return {
            display: kunReading,
            meaning: this.getPrimaryMeaning(data)
          };
        }
        
        // If no kun'yomi, use on'yomi with compound
        if (data.on_readings && data.on_readings.length > 0 && data.words) {
          const onReading = data.on_readings[0];
          
          // Look for a common compound (2 kanji)
          const compound = data.words.find(word => {
            const written = word.variants[0]?.written || '';
            return written.length === 2 && 
                   written.includes(this.currentKanji) &&
                   !this.containsHiragana(written);
          });
          
          if (compound && compound.variants[0]) {
            const variant = compound.variants[0];
            const meaning = compound.meanings[0]?.glosses[0] || '';
            return {
              display: `${variant.written} (${variant.pronounced})`,
              meaning: meaning
            };
          }
          
          // Fallback: just show the on'yomi reading
          return {
            display: onReading,
            meaning: this.getPrimaryMeaning(data)
          };
        }
        
        // Ultimate fallback
        return {
          display: '‚Äî',
          meaning: this.getPrimaryMeaning(data)
        };
      },
      
      containsHiragana(text) {
        // Check if string contains hiragana characters
        return /[\u3040-\u309F]/.test(text);
      },
      
      getExamples(data) {
        if (!data.words || data.words.length === 0) {
          return '<p>No examples available</p>';
        }
        
        // Get first 3-5 examples
        const examples = data.words.slice(0, 5);
        let html = '';
        
        examples.forEach(word => {
          const meanings = word.meanings.map(m => m.glosses.join(', ')).join('; ');
          html += `
            <div class="example-item">
              <div class="example-ja">${word.variants[0].written} (${word.variants[0].pronounced})</div>
              <div class="example-en">${meanings}</div>
            </div>
          `;
        });
        
        return html;
      },
      
      getPrimaryReading(data) {
        // For numbers and common kanji, prioritize kun'yomi
        // For most other kanji, prioritize on'yomi
        let reading = '';
        
        if (data.kun_readings && data.kun_readings.length > 0) {
          // Clean up kun'yomi - remove the okurigana part (after the dot)
          reading = data.kun_readings[0].split('.')[0];
        }
        
        if (!reading && data.on_readings && data.on_readings.length > 0) {
          reading = data.on_readings[0];
        }
        
        return reading || '‚Äî';
      },
      
      getPrimaryMeaning(data) {
        // Get the first/most common meaning
        if (data.meanings && data.meanings.length > 0) {
          return data.meanings[0];
        }
        return '‚Äî';
      },
      
      showAnswer() {
        this.displayAnswer();
        document.getElementById('kanji-info').classList.add('visible');
        document.getElementById('rating-buttons').classList.add('visible');
        document.getElementById('show-answer-btn').style.display = 'none';
      },
      
      updateDisplay() {
        // Only update if answer is already shown
        if (document.getElementById('kanji-info').classList.contains('visible')) {
          this.displayAnswer();
        }
      },
      
      rateCard(rating) {
        // Update kanji data
        const data = this.kanjiData[this.currentKanji];
        data.level = rating;
        data.lastReview = new Date().toISOString();
        data.reviewCount++;
        
        // Calculate next review (simple SRS)
        const intervals = [1, 3, 7, 14, 30]; // days
        const interval = intervals[rating] || 1;
        const nextReview = new Date();
        nextReview.setDate(nextReview.getDate() + interval);
        data.nextReview = nextReview.toISOString();
        
        this.saveData();
        this.renderGrid();
        this.updateStats();
        
        // Move to next card
        this.currentIndex++;
        this.showCard();
      },
      
      previousCard() {
        if (this.currentIndex > 0) {
          this.currentIndex--;
          this.showCard();
        }
      },
      
      nextCard() {
        if (this.currentIndex < this.studyQueue.length - 1) {
          this.currentIndex++;
          this.showCard();
        }
      },
      
      skipCard() {
        // Skip without rating
        this.currentIndex++;
        this.showCard();
      }
    };

    // Initialize app
    app.init();
  </script>
</body>
</html>
